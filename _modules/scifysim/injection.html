<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scifysim.injection &mdash; SCIFYsim dev-0.2.3 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=88750a54"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SCIFYsim
          </a>
              <div class="version">
                dev-0.2.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup_guide.html">Installing SCIFYsim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../need_to_know.html">What you need to know</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipe.html">Documentation recipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">scifysim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.analysis.html">scifysim.analysis module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.combiner.html">scifysim.combiner module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.combiners.html">scifysim.combiners module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.confconverter.html">scifysim.confconverter module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.correctors.html">scifysim.correctors module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.director.html">scifysim.director module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.injection.html">scifysim.injection module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.map_manager.html">scifysim.map_manager module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.mol_dens.html">scifysim.mol_dens module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.n_air.html">scifysim.n_air module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.observatory.html">scifysim.observatory module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.parsefile.html">scifysim.parsefile module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.plot_tools.html">scifysim.plot_tools module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.sources.html">scifysim.sources module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.spectrograph.html">scifysim.spectrograph module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.utilities.html">scifysim.utilities module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SCIFYsim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">scifysim.injection</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scifysim.injection</h1><div class="highlight"><pre>
<span></span><span class="c1"># injection.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module revolves around the injector class</span>
<span class="sd">At ``__init__()``, injector builds</span>

<span class="sd">* one atmo object for each telescope (stored in a list)</span>
<span class="sd">* one focuser object (badly named) for each wavelength AND each telescope</span>
<span class="sd">* one fiber_head object that builds the map of LP01 mode.</span>

<span class="sd">It then creates a generator called ``self.it`` that will return</span>
<span class="sd">a series of complex numbers corresponding to injection complex phasors.</span>

<span class="sd">**Testing:**</span>

<span class="sd">- ``test_fiber`` for the ``fiber_head``</span>
<span class="sd">- ``test_injector`` for the ``injector``</span>

<span class="sd">&quot;&quot;&quot;</span>



<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp2d</span><span class="p">,</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">xaosim</span> <span class="kn">import</span> <span class="n">zernike</span>



<span class="kn">from</span> <span class="nn">pdb</span> <span class="kn">import</span> <span class="n">set_trace</span>


<span class="c1"># amto_screen is now provided in house to provide seed</span>
<span class="c1">#from xaosim import wavefront as wft</span>

<span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span>
<span class="n">fft</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span>
<span class="n">ifft</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span>


<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logit</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utilities</span>

<span class="n">parent</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>


<div class="viewcode-block" id="atmo"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo">[docs]</a><span class="k">class</span> <span class="nc">atmo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Atmospheric Kolmogorov-type phase screen.</span>
<span class="sd">    </span>
<span class="sd">    **Class Attributes:**</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    - csz     : size (csz x csz) of the phase screen       (in pixels)</span>
<span class="sd">    - pdiam   : diameter of the aperture within this array (in pixels)</span>
<span class="sd">    - rndarr  : uniformly distributed random array         (csz x csz)</span>
<span class="sd">    - kolm    : the original phase screen                  (csz x csz)</span>
<span class="sd">    - kolm2   : the oversized phase screen    ((csz + pdiam) x (csz + pdiam))</span>
<span class="sd">    - qstatic : an optional quasi static aberration    (pdiam x pdiam)</span>
<span class="sd">    - rms     : total phase screen rms value           (in nanometers)</span>
<span class="sd">    - rms_i   : instant rms inside the pupil           (in nanometers)</span>

<span class="sd">    **Comment:**</span>
<span class="sd">    </span>
<span class="sd">    While the attributes are documented here for reference, the prefered</span>
<span class="sd">    way of interacting with them is via the functions defined within the</span>
<span class="sd">    class.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># ==================================================</span>
<div class="viewcode-block" id="atmo.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;GRAVITY+&quot;</span><span class="p">,</span> <span class="n">csz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
                 <span class="n">psz</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                 <span class="n">lsz</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                 <span class="n">ro_wl</span><span class="o">=</span><span class="mf">3.5e-6</span><span class="p">,</span> <span class="n">L0</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                 <span class="n">fc</span><span class="o">=</span><span class="mf">24.5</span><span class="p">,</span> <span class="n">correc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">wind_speed</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> 
                 <span class="n">wind_angle</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">step_time</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">lo_excess</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="n">pdiam</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Kolmogorov type atmosphere + qstatic error</span>

<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - name  : a string describing the instrument</span>
<span class="sd">        - csz   : the size of the Fourier array</span>
<span class="sd">        - psz   : the size of the pupil in  pixels</span>
<span class="sd">        - lsz   : the screen linear size (in meters)</span>
<span class="sd">        - r0    : the Fried parameter (in meters)</span>
<span class="sd">        - L0    : the outer scale parameter (in meters)</span>
<span class="sd">        - fc    : the cutoff frequency [lambda/D] defined by the </span>
<span class="sd">          number of actuators</span>
<span class="sd">        - correc : the correction factor to apply to controlled</span>
<span class="sd">          spatial frequencies.</span>
<span class="sd">        - wind_speed : the speed of the phas screen in [m/s]</span>
<span class="sd">        - step_time : the time resolution of the simulation [s]</span>
<span class="sd">        - config : a parsed config file </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Deprecated the use of config is preferred</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csz</span>     <span class="o">=</span> <span class="n">csz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psz</span>     <span class="o">=</span> <span class="n">psz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lsz</span>     <span class="o">=</span> <span class="n">lsz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span>   <span class="o">=</span> <span class="n">pdiam</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ppscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wind_speed</span> <span class="o">=</span> <span class="n">wind_speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_time</span> <span class="o">=</span> <span class="n">step_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r0</span>      <span class="o">=</span> <span class="n">r0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L0</span>      <span class="o">=</span> <span class="n">L0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r0_wl</span>   <span class="o">=</span> <span class="n">r0_wl</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rms_i</span>   <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correc</span>  <span class="o">=</span> <span class="n">correc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lo_excess</span> <span class="o">=</span> <span class="n">lo_excess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc</span>      <span class="o">=</span> <span class="n">fc</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;pup_res&quot;</span><span class="p">)</span>
            <span class="n">screen_oversize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;screen_size&quot;</span><span class="p">)</span>
            <span class="n">pdiams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getarray</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span><span class="s2">&quot;diam&quot;</span><span class="p">)</span>
            <span class="n">pdiam</span> <span class="o">=</span> <span class="n">pdiams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;fc_ao&quot;</span><span class="p">)</span>
            <span class="n">r0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;r0&quot;</span><span class="p">)</span>
            <span class="n">L0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;Lout&quot;</span><span class="p">)</span>
            <span class="n">correc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;correc&quot;</span><span class="p">)</span>
            <span class="n">lo_excess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;lo_excess&quot;</span><span class="p">)</span>
            <span class="n">wind_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;vwind&quot;</span><span class="p">)</span>
            <span class="n">step_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;step_time&quot;</span><span class="p">)</span>
            <span class="n">wl_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;photon&quot;</span><span class="p">,</span> <span class="s2">&quot;lambda_cen&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">csz</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pres</span><span class="o">*</span><span class="n">screen_oversize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psz</span>     <span class="o">=</span> <span class="n">pres</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span>   <span class="o">=</span> <span class="n">pdiam</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ppscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wind_speed</span> <span class="o">=</span> <span class="n">wind_speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_time</span> <span class="o">=</span> <span class="n">step_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lsz</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="o">*</span><span class="n">screen_oversize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r0</span>      <span class="o">=</span> <span class="n">r0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L0</span>      <span class="o">=</span> <span class="n">L0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r0_wl</span>   <span class="o">=</span> <span class="n">wl_mean</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rms_i</span>   <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correc</span>  <span class="o">=</span> <span class="n">correc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lo_excess</span> <span class="o">=</span> <span class="n">lo_excess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc</span>      <span class="o">=</span> <span class="n">fc</span>
            
        <span class="n">kolm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modul</span>    <span class="o">=</span> <span class="n">atmo_screen</span><span class="p">(</span><span class="n">screen_dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="n">screen_extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lsz</span><span class="p">,</span>
                                          <span class="n">r0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r0</span><span class="p">,</span> <span class="n">L0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L0</span><span class="p">,</span>
                                          <span class="n">fc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">,</span> <span class="n">correc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correc</span><span class="p">,</span>
                                          <span class="n">lo_excess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lo_excess</span><span class="p">,</span>
                                          <span class="n">pdiam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kolm</span> <span class="o">=</span> <span class="n">kolm</span><span class="o">.</span><span class="n">real</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">qstatic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">psz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psz</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shm_phs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qstatic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kolm2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kolm</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1">#self.kolm2   = self.kolm2[:self.sz+self.pdiam,:self.sz+self.pdiam]</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">offx</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># x-offset on the &quot;large&quot; phase screen array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offy</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># y-offset on the &quot;large&quot; phase screen array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_step_vector</span><span class="p">(</span><span class="n">wind_angle</span><span class="o">=</span><span class="n">wind_angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttc</span>     <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># Tip-tilt correction flag</span>
        
        <span class="c1"># auxilliary array (for tip-tilt correction)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xxnorm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yynorm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">give</span><span class="p">()</span>
        
        <span class="c1"># Must update screen to obtain the correct scaling and correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_screen</span><span class="p">()</span></div>
    

    <span class="c1"># ==============================================================</span>
    
<div class="viewcode-block" id="atmo.update_step_vector"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo.update_step_vector">[docs]</a>    <span class="k">def</span> <span class="nf">update_step_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wind_angle</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wind_speed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh the step vector that will be applied</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - wind_angle : the angle of incience of the wind (values around 0.1 rad</span>
<span class="sd">          are favoured since they provide long series before repeating)</span>
<span class="sd">        - wind_speed : The speed of the moving phase screen.</span>
<span class="sd">        - step_time  : The time step of the simulation [s]</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wind_speed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wind_speed</span> <span class="o">=</span> <span class="n">wind_speed</span>
        <span class="k">if</span> <span class="n">step_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_time</span> <span class="o">=</span> <span class="n">step_time</span>
        <span class="n">shift_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_speed</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">step_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ppscale</span>
        <span class="n">xstep</span><span class="p">,</span> <span class="n">ystep</span> <span class="o">=</span> <span class="n">shift_length</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">wind_angle</span><span class="p">),</span> <span class="n">shift_length</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">wind_angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">ystep</span><span class="p">,</span> <span class="n">xstep</span><span class="p">))</span></div>
        
        
        
    
<div class="viewcode-block" id="atmo.set_qstatic"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo.set_qstatic">[docs]</a>    <span class="k">def</span> <span class="nf">set_qstatic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qstatic</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines some quasistatic errors in the wavefront</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - qstatic    : A static phase screen</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">qstatic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qstatic</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qstatic</span> <span class="o">=</span> <span class="n">qstatic</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;quasi-static phase screen updated!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;could not update quasi-static phase screen&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;array should be </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2"> (dtype=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qstatic</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no new quasi-static screen was provided!&quot;</span><span class="p">)</span></div>

    <span class="c1"># ==============================================================</span>
<div class="viewcode-block" id="atmo.update_screen"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo.update_screen">[docs]</a>    <span class="k">def</span> <span class="nf">update_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generic update of the properties of the phase-screen</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - correc : *float* The correction factor for the control region</span>
<span class="sd">        - fc : *float* The cutoff fequency</span>
<span class="sd">        - r0 : *flaot* r0 of the initial phase screen</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">r0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r0</span> <span class="o">=</span> <span class="n">r0</span>

        <span class="k">if</span> <span class="n">L0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L0</span> <span class="o">=</span> <span class="n">L0</span>

        <span class="k">if</span> <span class="n">correc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correc</span> <span class="o">=</span> <span class="n">correc</span>

        <span class="k">if</span> <span class="n">fc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">fc</span>
        
        <span class="c1"># Converting to a piston screen in microns at this point</span>
        <span class="c1"># r0 is now expected at the mean of the wl band</span>
        <span class="n">kolm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modul</span> <span class="o">=</span> <span class="n">atmo_screen</span><span class="p">(</span><span class="n">screen_dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="n">screen_extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lsz</span><span class="p">,</span>
                                          <span class="n">r0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r0</span><span class="p">,</span> <span class="n">L0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L0</span><span class="p">,</span>
                                          <span class="n">fc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">,</span> <span class="n">correc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correc</span><span class="p">,</span>
                                          <span class="n">lo_excess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lo_excess</span><span class="p">,</span>
                                          <span class="n">pdiam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kolm</span>    <span class="o">=</span> <span class="mf">1.0e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r0_wl</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">kolm</span><span class="o">.</span><span class="n">real</span>  <span class="c1"># converting to piston in microns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kolm2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kolm</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span></div>


<div class="viewcode-block" id="atmo.reset"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offx</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offy</span> <span class="o">=</span> <span class="mf">0.</span></div>
        
<div class="viewcode-block" id="atmo.give"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo.give">[docs]</a>    <span class="k">def</span> <span class="nf">give</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        Main loop: frozen screen slid over the aperture</span>
<span class="sd">        </span>
<span class="sd">        This returns a iterator that yelds the phase screen</span>
<span class="sd">        for one aperture.</span>
<span class="sd">        </span>
<span class="sd">        **use:**</span>
<span class="sd">        </span>
<span class="sd">        .. code-block::</span>
<span class="sd">        </span>
<span class="sd">            a = atmo.give()</span>
<span class="sd">            phscreen = next(a)</span>
<span class="sd">            phscreen = next(a)</span>

<span class="sd">        **Options:**</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offy</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intoffx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intoffy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offy</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">))</span>

            <span class="n">subk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kolm2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">intoffx</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">intoffx</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">psz</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">intoffy</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">intoffy</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">psz</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttc</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ttx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xxnorm2</span>
                <span class="n">tty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yynorm2</span>
                <span class="n">subk</span> <span class="o">-=</span> <span class="n">ttx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">+</span> <span class="n">tty</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rms_i</span> <span class="o">=</span> <span class="n">subk</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shm_phs</span> <span class="o">=</span> <span class="n">subk</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qstatic</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_phs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div></div>
            
<span class="c1"># ==================================================================</span>
<div class="viewcode-block" id="atmo_screen"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.atmo_screen">[docs]</a><span class="k">def</span> <span class="nf">atmo_screen</span><span class="p">(</span><span class="n">screen_dimension</span><span class="p">,</span> <span class="n">screen_extent</span><span class="p">,</span>
                <span class="n">r0</span><span class="p">,</span> <span class="n">L0</span><span class="p">,</span>
                <span class="n">fc</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">correc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lo_excess</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                <span class="n">pdiam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    </span>
<span class="sd">    The Kolmogorov - Von Karman phase screen generation algorithm.</span>

<span class="sd">    Adapted from the work of Carbillet &amp; Riccardi (2010).</span>
<span class="sd">    `&lt;http://cdsads.u-strasbg.fr/abs/2010ApOpt..49G..47C&gt;`_</span>

<span class="sd">    Kolmogorov screen can be altered by an attenuation of the power</span>
<span class="sd">    by a correction factor *correc* up to a cut-off frequency *fc*</span>
<span class="sd">    expressed in number of cycles across the phase screen</span>

<span class="sd">    **Parameters:**</span>

<span class="sd">    - screen_dimension    : the size of the array to be computed (in pixels)</span>
<span class="sd">    - screen_extent     :  the physical extent of the phase screen (in meters)</span>
<span class="sd">    - r0     : the Fried parameter, measured at a given wavelength (in meters)</span>
<span class="sd">    - L0     : the outer scale parameter (in meters)</span>
<span class="sd">    - fc     : DM cutoff frequency (in lambda/D)</span>
<span class="sd">    - correc : correction of wavefront amplitude (factor 10, 100, ...)</span>
<span class="sd">    - lo_excess: A factor introducing excess low-order averations (mosly tip-tilt)</span>
<span class="sd">      Must be striclty 0 =&lt; lo_excess &lt; 1.</span>
<span class="sd">    - pdiam  : pupil diameter (in meters)</span>
<span class="sd">    - seed   : random seed for the screen (default: None produces a new seed)</span>

<span class="sd">    Returns: two independent phase screens, available in the real and </span>
<span class="sd">    imaginary part of the returned array.</span>

<span class="sd">    **Remarks:**</span>
<span class="sd">    </span>
<span class="sd">    If pdiam is not specified, the code assumes that the diameter of</span>
<span class="sd">    the pupil is equal to the extent of the phase screen &quot;screen_extent&quot;.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1">#phs = 2*np.pi * (np.random.rand(screen_dimension, screen_dimension) - 0.5)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">SeedSequence</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
    <span class="n">phs</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">screen_dimension</span><span class="p">,</span><span class="n">screen_dimension</span><span class="p">))</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">screen_dimension</span><span class="p">)</span><span class="o">-</span><span class="n">screen_dimension</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">screen_dimension</span><span class="p">)</span><span class="o">-</span><span class="n">screen_dimension</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="n">shift</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">modul</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">screen_extent</span><span class="o">/</span><span class="n">L0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="o">/</span><span class="mf">12.</span><span class="p">)</span>
    

    <span class="k">if</span> <span class="n">pdiam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&lt;</span> <span class="n">fc</span> <span class="o">*</span> <span class="n">screen_extent</span> <span class="o">/</span> <span class="n">pdiam</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">in_fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&lt;</span> <span class="n">fc</span><span class="p">)</span>
        
    <span class="c1">#if not np.isclose(lo_excess, 0):</span>
    <span class="c1">#    set_trace()</span>
    
    <span class="n">modul</span><span class="p">[</span><span class="n">in_fc</span><span class="p">]</span> <span class="o">/=</span> <span class="n">correc</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lo_excess</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">rr</span><span class="p">[</span><span class="n">in_fc</span><span class="p">]))</span>
    <span class="c1"># obtaining unique rr values </span>
    <span class="n">rru</span><span class="p">,</span> <span class="n">rru_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">amodul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mf">0.0228</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">screen_extent</span><span class="o">/</span><span class="n">r0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="n">modul</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">rru_indices</span><span class="p">]</span>
    
    <span class="n">screen</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">modul</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phs</span><span class="p">))</span> <span class="o">*</span> <span class="n">screen_dimension</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">screen</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mf">0.0228</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">screen_extent</span><span class="o">/</span><span class="n">r0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span>

    <span class="n">screen</span> <span class="o">-=</span> <span class="n">screen</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">screen</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rru</span><span class="p">,</span> <span class="n">amodul</span><span class="p">])</span><span class="o">.</span><span class="n">T</span></div>

<span class="c1"># ======================================================================</span>

            
<span class="n">dtor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span>  <span class="c1"># to convert degrees to radians</span>
<span class="n">i2pi</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>   <span class="c1"># complex phase factor</span>






<div class="viewcode-block" id="Hn"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.Hn">[docs]</a><span class="k">def</span> <span class="nf">Hn</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">))</span></div>


<div class="viewcode-block" id="focuser"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser">[docs]</a><span class="k">class</span> <span class="nc">focuser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Generic monochoromatic camera class</span>
<span class="sd">    </span>
<span class="sd">    This class simulates focusing optics. It can simulate injection </span>
<span class="sd">    either:</span>
<span class="sd">    </span>
<span class="sd">    - by computing the product of the image plane complex amplitude with</span>
<span class="sd">      the fiber mode field, or</span>
<span class="sd">    - by computing the product of the pupil plane complex amplitude with</span>
<span class="sd">      the conjugation of the fiber mode field.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># =========================================================================</span>
<div class="viewcode-block" id="focuser.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;SCExAO_chuck&quot;</span><span class="p">,</span> <span class="n">csz</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">ysz</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">xsz</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                 <span class="n">pupil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">screen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rm_inj_piston</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">pdiam</span><span class="o">=</span><span class="mf">7.92</span><span class="p">,</span> <span class="n">pscale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">wl</span><span class="o">=</span><span class="mf">1.6e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Default instantiation of a cam object:</span>

<span class="sd">        </span>
<span class="sd">        **Parameters are:**</span>
<span class="sd">        </span>
<span class="sd">        - name    : a string describing the camera (&quot;instrument + camera name&quot;)</span>
<span class="sd">        - csz     : array size for Fourier computations</span>
<span class="sd">        - (ys,xs) : the dimensions of the actually produced image</span>
<span class="sd">        - pupil   : a csz x csz array containing the pupil</span>
<span class="sd">        - pscale  : the plate scale of the image, in mas/pixel</span>
<span class="sd">        - wl      : the central wavelength of observation, in meters</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csz</span> <span class="o">=</span> <span class="n">csz</span>              <span class="c1"># Fourier computation size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ysz</span> <span class="o">=</span> <span class="n">ysz</span>              <span class="c1"># camera vertical dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xsz</span> <span class="o">=</span> <span class="n">xsz</span>              <span class="c1"># camera horizontal dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ysz</span><span class="p">,</span> <span class="n">xsz</span><span class="p">)</span>    <span class="c1"># max image dimension</span>

        <span class="c1"># possible crop values (to match true camera image sizes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xsz</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ysz</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xsz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ysz</span>

        <span class="k">if</span> <span class="n">pupil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="n">ud</span><span class="p">(</span><span class="n">csz</span><span class="p">,</span> <span class="n">csz</span><span class="p">,</span> <span class="n">csz</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="n">pupil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatpup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatpup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupilsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span>  <span class="o">=</span> <span class="n">pdiam</span>                 <span class="c1"># pupil diameter in meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pscale</span> <span class="o">=</span> <span class="n">pscale</span>                <span class="c1"># plate scale in mas/pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pscale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl</span>     <span class="o">=</span> <span class="n">wl</span>                    <span class="c1"># wavelength in meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu2phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>  <span class="c1"># convert microns to phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frm0</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ysz</span><span class="p">,</span> <span class="n">xsz</span><span class="p">))</span>  <span class="c1"># initial camera frame</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">btwn_pixel</span> <span class="o">=</span> <span class="kc">True</span>            <span class="c1"># fourier comp. centering option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phot_noise</span> <span class="o">=</span> <span class="kc">False</span>            <span class="c1"># photon noise flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>              <span class="c1"># default # of photons in frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corono</span>     <span class="o">=</span> <span class="kc">False</span>            <span class="c1"># if True: perfect coronagraph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_injection_piston</span> <span class="o">=</span> <span class="n">rm_inj_piston</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">)</span>
      
        <span class="c1"># final tune-up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cam</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_TT</span><span class="p">()</span></div>

<div class="viewcode-block" id="focuser.define_TT"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.define_TT">[docs]</a>    <span class="k">def</span> <span class="nf">define_TT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines tip and tilt phase screens based on the pupil</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">*</span><span class="n">zernike</span><span class="o">.</span><span class="n">mkzer</span><span class="p">(</span><span class="o">*</span><span class="n">zernike</span><span class="o">.</span><span class="n">noll_2_zern</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">100</span><span class="p">,</span>
                                 <span class="n">limit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tip</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">*</span><span class="n">zernike</span><span class="o">.</span><span class="n">mkzer</span><span class="p">(</span><span class="o">*</span><span class="n">zernike</span><span class="o">.</span><span class="n">noll_2_zern</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">100</span><span class="p">,</span>
                                  <span class="n">limit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tilt</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tilt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntilt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">tilt</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tilt</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span></div>

    <span class="c1"># =========================================================================</span>

<div class="viewcode-block" id="focuser.update_pupil"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.update_pupil">[docs]</a>    <span class="k">def</span> <span class="nf">update_pupil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pupil</span><span class="p">,</span> <span class="n">reference_pupil</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">pupil</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="nb">bool</span><span class="p">),</span> <span class="s2">&quot;Given wrong pupil data type. Needs bool.&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">pupil</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="n">pupil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatpup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatpup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupilsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pupilsum</span> <span class="o">*</span> <span class="mf">1.</span><span class="o">/</span><span class="n">reference_pupil</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span></div>
        
<div class="viewcode-block" id="focuser.update_cam"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.update_cam">[docs]</a>    <span class="k">def</span> <span class="nf">update_cam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">between_pixel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Change the filter, the plate scale or the centering of the camera</span>

<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - pscale        : the plate scale of the image, in mas/pixel</span>
<span class="sd">        - wl            : the central wavelength of observation, in meters</span>
<span class="sd">        - between_pixel : whether FT are centered between four pixels or not</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wasgoing</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">wl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A1</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sft aux array to be refreshed&quot;</span><span class="p">)</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">pscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pscale</span> <span class="o">=</span> <span class="n">pscale</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A1</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SFT aux array to be refreshed&quot;</span><span class="p">)</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">between_pixel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btwn_pixel</span> <span class="o">=</span> <span class="n">between_pixel</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A1</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SFT aux array to be refreshed&quot;</span><span class="p">)</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ld0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="o">*</span><span class="mf">3.6e6</span><span class="o">/</span><span class="n">dtor</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pscale</span>  <span class="c1"># l/D (in pixels)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nld0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isz</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ld0</span>           <span class="c1"># nb of l/D across the frame</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">)))</span></div>


    <span class="c1"># =========================================================================</span>
<div class="viewcode-block" id="focuser.update_signal"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.update_signal">[docs]</a>    <span class="k">def</span> <span class="nf">update_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nph</span><span class="o">=</span><span class="mf">1e6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Update the strength of the signal</span>

<span class="sd">        Automatically sets the *phot_noise* flag to *True*</span>
<span class="sd">        *IF* the value provided is negative, it sets the *phot_noise* flag</span>
<span class="sd">        back to *False* and sets the signal back to 1e6 photons</span>

<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - nph: the total number of photons inside the frame</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nph</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">nph</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phot_noise</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phot_noise</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="c1"># =========================================================================</span>
<div class="viewcode-block" id="focuser.sft"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.sft">[docs]</a>    <span class="k">def</span> <span class="nf">sft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Class specific implementation of the explicit Fourier Transform</span>

<span class="sd">        </span>
<span class="sd">        The algorithm is identical to the function in the sft module,</span>
<span class="sd">        except that intermediate FT arrays are stored for faster</span>
<span class="sd">        computation.</span>

<span class="sd">        For a more generic implementation, refer to the sft module of this</span>
<span class="sd">        package.</span>

<span class="sd">        Assumes the original array is square.</span>
<span class="sd">        No need to &quot;center&quot; the data on the origin.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A1</span>  <span class="c1"># look for existence of auxilliary arrays</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;updating the Fourier auxilliary arrays&quot;</span><span class="p">)</span>
            <span class="n">NA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span>
            <span class="n">NB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isz</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nld0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">=</span> <span class="n">m</span><span class="o">/</span><span class="p">(</span><span class="n">NA</span><span class="o">*</span><span class="n">NB</span><span class="p">)</span>

            <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">NB</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">NA</span><span class="p">))</span>

            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">btwn_pixel</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">NA</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NA</span><span class="p">)</span><span class="o">-</span><span class="n">NA</span><span class="o">/</span><span class="mf">2.0</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">NB</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NB</span><span class="p">)</span><span class="o">-</span><span class="n">NB</span><span class="o">/</span><span class="mf">2.0</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>

            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sign</span><span class="o">*</span><span class="n">i2pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">U</span><span class="p">),</span> <span class="n">X</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sign</span><span class="o">*</span><span class="n">i2pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">U</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_A1</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span>

        <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_A1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A2</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_A3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">B</span><span class="p">)</span></div>

    <span class="c1"># =========================================================================</span>
<div class="viewcode-block" id="focuser.getimage"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.getimage">[docs]</a>    <span class="k">def</span> <span class="nf">getimage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phscreen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Produces an image, given a certain number of phase screens,</span>
<span class="sd">        and updates the shared memory data structure that the camera</span>
<span class="sd">        instance is linked to with that image</span>

<span class="sd">        If you need something that returns the image, you have to use the</span>
<span class="sd">        class member method get_image(), after having called this method.</span>

<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - phscreen:   The piston map in µm</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#from pdb import set_trace</span>
        <span class="c1"># Here </span>

        <span class="n">phs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># phase map</span>
        
        <span class="k">if</span> <span class="n">phscreen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># a phase screen was provided</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_injection_piston</span><span class="p">:</span>
                <span class="n">phs</span> <span class="o">+=</span> <span class="n">phscreen</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">phscreen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phs</span> <span class="o">+=</span> <span class="n">phscreen</span>
            
        <span class="n">wf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phs</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu2phase</span><span class="p">)</span>
        <span class="n">wf</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupilsum</span><span class="p">)</span>  <span class="c1"># signal scaling</span>
        <span class="n">wf</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span>                               <span class="c1"># apply the pupil mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phs</span> <span class="o">=</span> <span class="n">phs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span>                   <span class="c1"># store total phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sft</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>                      <span class="c1"># focal plane cplx ampl</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_pa</span></div>
    
<div class="viewcode-block" id="focuser.get_inv_image"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.get_inv_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_inv_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Hn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_A1</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_A3</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">B</span></div>
    
<div class="viewcode-block" id="focuser.get_injection"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.get_injection">[docs]</a>    <span class="k">def</span> <span class="nf">get_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phscreen</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the complex injection phasor based on fiber mode in the pupil plane.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - phscreen: The piston map in µm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#set_trace()</span>
        <span class="n">phs</span> <span class="o">=</span> <span class="n">phscreen</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">phs</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">phs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flatpup</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_bias</span>
        <span class="c1"># We do only the needed operations thanks to masking</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupilsum</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flatpup</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu2phase</span><span class="p">)</span>  <span class="c1"># signal scaling</span>
        <span class="c1">#wf *= self.pupil                               # apply the pupil mask</span>
        <span class="c1">#self._phs = phs * self.pupil                   # store total phase</span>
        <span class="c1">#self.fc_pa = self.sft(wf)                      # focal plane cplx ampl</span>
        <span class="n">injected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_masked_lppup</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">injected</span></div>
    
<div class="viewcode-block" id="focuser.get_tilt"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.focuser.get_tilt">[docs]</a>    <span class="k">def</span> <span class="nf">get_tilt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phscreen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Measures the tip-tilt measurement corresponding to the wavefront</span>
<span class="sd">        provided. The tip-tilt is in a 2-array and the unit is lambda/D </span>
<span class="sd">        where D is the extent of the pupil mask.</span>
<span class="sd">        </span>

<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - phscreen:   The piston map in µm</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#from pdb import set_trace</span>
        <span class="c1"># Here </span>

        <span class="n">phs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">csz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># phase map</span>
        
        <span class="k">if</span> <span class="n">phscreen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># a phase screen was provided</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_injection_piston</span><span class="p">:</span>
                <span class="n">phs</span> <span class="o">+=</span> <span class="n">phscreen</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">phscreen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phs</span> <span class="o">+=</span> <span class="n">phscreen</span>
            
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">*</span><span class="n">phs</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu2phase</span>
        <span class="n">tip</span>  <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntip</span><span class="p">)</span>
        <span class="n">tilt</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilt</span><span class="p">)</span>
        <span class="c1">#wf *= np.sqrt(self.signal / self.pupil.sum())  # signal scaling</span>
        <span class="c1">#wf *= self.pupil                               # apply the pupil mask</span>
        <span class="c1">#self._phs = phs * self.pupil                   # store total phase</span>
        <span class="c1">#self.fc_pa = self.sft(wf)                      # focal plane cplx ampl</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tip</span><span class="p">,</span> <span class="n">tilt</span><span class="p">])</span></div></div>
        
        
            
            
            
            
<div class="viewcode-block" id="injector"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector">[docs]</a><span class="k">class</span> <span class="nc">injector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="injector.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pupil</span><span class="o">=</span><span class="s2">&quot;VLT&quot;</span><span class="p">,</span>
                 <span class="n">pdiam</span><span class="o">=</span><span class="mf">8.</span><span class="p">,</span><span class="n">odiam</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ntelescopes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">tt_correction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">no_piston</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lambda_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fiber_mode</span><span class="o">=</span><span class="s2">&quot;diameter&quot;</span><span class="p">,</span>
                 <span class="n">NA</span> <span class="o">=</span> <span class="mf">0.23</span><span class="p">,</span>
                 <span class="n">a</span> <span class="o">=</span> <span class="mf">4.25e-6</span><span class="p">,</span>
                 <span class="n">ncore</span> <span class="o">=</span> <span class="mf">2.7</span><span class="p">,</span>
                 <span class="n">wl_mfd</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">focal_hrange</span><span class="o">=</span><span class="mf">20.0e-6</span><span class="p">,</span>
                 <span class="n">focal_res</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                 <span class="n">pscale</span> <span class="o">=</span> <span class="mf">4.5</span><span class="p">,</span>
                 <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rm_inj_piston</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">atmo_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates fiber injection object.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - pupil     : The telescope pupil to consider</span>
<span class="sd">        - pdiam     : The pupil diameter</span>
<span class="sd">        - ntelescopes : The number of telescopes to inject</span>
<span class="sd">        - pupil     : Apupil name or definition</span>
<span class="sd">        - tt_correction : Amount of TT to correct (Not implemented yet)</span>
<span class="sd">        - no_piston : Remove the effect of piston at the injection </span>
<span class="sd">          (So that it is handled only by the FT.)</span>
<span class="sd">        - NA        : Then numerical aperture of the fiber</span>
<span class="sd">        - a         : The radius of the core (m)</span>
<span class="sd">        - ncore    : The refractive index of the core</span>
<span class="sd">        - focal_hrange : The half-range of the focal region to simulate (m)</span>
<span class="sd">        - focal_res : The total resolution of the focal plane to simulate</span>
<span class="sd">        - pscale    : The pixel scale for imager setup (mas/pix)</span>
<span class="sd">        - seed      : Value to pass for random phase screen initialization</span>
<span class="sd">        - atmo_config: A parsed config file </span>
<span class="sd">                    </span>
<span class="sd">        Use: call ``next(self.it)`` that returns injection phasors</span>
<span class="sd">        For more information, look into the attributes.</span>
<span class="sd">        </span>
<span class="sd">        To get the ideal injection: ``self.best_injection(lambdas)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lambda_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">3.0e-6</span><span class="p">,</span> <span class="mf">4.2e-6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span> <span class="o">=</span> <span class="n">lambda_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntelescopes</span> <span class="o">=</span> <span class="n">ntelescopes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span> <span class="o">=</span> <span class="n">pdiam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">odiam</span> <span class="o">=</span> <span class="n">odiam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collecting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">odiam</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">atmo_config</span> <span class="o">=</span> <span class="n">atmo_config</span>
        
        <span class="c1">##########</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fiber_mode</span> <span class="o">=</span> <span class="n">fiber_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NA</span> <span class="o">=</span> <span class="n">NA</span> <span class="c1"># 0.23#0.21</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="c1"># 4.25e-6#3.0e-6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span> <span class="o">=</span> <span class="n">ncore</span> <span class="c1"># 2.7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl_mfd</span> <span class="o">=</span> <span class="n">wl_mfd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_hrange</span> <span class="o">=</span> <span class="n">focal_hrange</span> <span class="c1"># 20.0e-6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_res</span> <span class="o">=</span> <span class="n">focal_res</span> <span class="c1"># 50</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pscale</span> <span class="o">=</span> <span class="n">pscale</span>
        <span class="c1">#Now calling the common part of the config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="n">pupil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_inj_piston</span> <span class="o">=</span> <span class="n">rm_inj_piston</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="c1"># Preparing iterators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">give_fiber</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_best_injection</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_efunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">give_interpolated</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_planes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injected</span> <span class="o">=</span> <span class="kc">None</span></div>
        
<div class="viewcode-block" id="injector.from_config_file"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.from_config_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">focal_res</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">pupil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the injector object from a config file</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        file      : A pre-parsed config file</span>
<span class="sd">        fpath     : The path to a config file</span>
<span class="sd">        nwl       : The number of wl channels</span>
<span class="sd">        focal_res : The total resolution of the focal plane to simulate </span>
<span class="sd">        </span>
<span class="sd">        Gathers the variables from the config file then calls for a class instance (``__init__()``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scifysim</span> <span class="kn">import</span> <span class="n">parsefile</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Need to read the file&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">,</span> <span class="s2">&quot;Need to provide at least</span><span class="se">\</span>
<span class="s2">                                        a path to a config file&quot;</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading the parsefile module&quot;</span><span class="p">)</span>
            <span class="n">theconfig</span> <span class="o">=</span> <span class="n">parsefile</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
            <span class="n">confpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;file provided&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">parsefile</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">),</span> \
                             <span class="s2">&quot;The file must be a ConfigParser object&quot;</span>
            <span class="n">theconfig</span> <span class="o">=</span> <span class="n">file</span>
            <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Now we use fpath to provide the root for appendix config files&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        
        <span class="c1"># Numerical aperture</span>
        <span class="n">fiber_mode</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;fiber_mode&quot;</span><span class="p">)</span>
        <span class="n">wl_mfd</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;fib_wav&quot;</span><span class="p">)</span>
        <span class="n">NA</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;num_app&quot;</span><span class="p">)</span>
        <span class="c1"># Core radius</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">):</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Core radius is set to 0 : optimize&quot;</span><span class="p">)</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not implemented in scifysim: set to 4.25&quot;</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">4.25e-6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">)</span>
        <span class="c1"># Core index</span>
        <span class="n">ncore</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;core_index&quot;</span><span class="p">)</span>
        <span class="c1"># Wavelength coverage</span>
        <span class="n">lambcen</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;photon&quot;</span><span class="p">,</span> <span class="s2">&quot;lambda_cen&quot;</span><span class="p">)</span>
        <span class="n">lambwidth</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;photon&quot;</span><span class="p">,</span> <span class="s2">&quot;bandwidth&quot;</span><span class="p">)</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;photon&quot;</span><span class="p">,</span> <span class="s2">&quot;injection_spectral_interp&quot;</span><span class="p">)</span>
        <span class="c1">#nwls = theconfig.getint(&quot;photon&quot;, &quot;n_spectral_science&quot;)</span>
        <span class="n">nwl</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;photon&quot;</span><span class="p">,</span> <span class="s2">&quot;n_spectral_injection&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;None&quot;</span> <span class="ow">in</span> <span class="n">interpolation</span><span class="p">:</span>
            <span class="n">nwl</span> <span class="o">=</span> <span class="n">nwls</span>
        <span class="k">elif</span> <span class="s2">&quot;nearest&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="s2">&quot;linear&quot;</span> <span class="ow">in</span> <span class="n">interpolation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nwl</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Need minimum 2 spectral chanels at injection&quot;</span><span class="p">)</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;to get quadratic interpolation (selected </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nwl</span><span class="p">))</span>
                <span class="n">nwl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nwl</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;quadratic&quot;</span> <span class="ow">in</span> <span class="n">interpolation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nwl</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Need minimum 3 spectral chanels at injection&quot;</span><span class="p">)</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;to get quadratic interpolation (selected </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nwl</span><span class="p">))</span>
                <span class="n">nwl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nwl</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;cubic&quot;</span> <span class="ow">in</span> <span class="n">interpolation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nwl</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Need minimum 4 spectral chanels at injection&quot;</span><span class="p">)</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;to get cubic interpolation (selected </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nwl</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolation: &quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised interpolation&quot;</span><span class="p">)</span>
            
        <span class="n">lambmin</span> <span class="o">=</span> <span class="n">lambcen</span> <span class="o">-</span> <span class="n">lambwidth</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambmax</span> <span class="o">=</span> <span class="n">lambcen</span> <span class="o">+</span> <span class="n">lambwidth</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lambda_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lambmin</span><span class="p">,</span> <span class="n">lambmax</span><span class="p">,</span> <span class="n">nwl</span><span class="p">)</span>
        
        <span class="n">pdiams</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getarray</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span> <span class="s2">&quot;diam&quot;</span><span class="p">)</span>
        <span class="n">pdiam</span> <span class="o">=</span> <span class="n">pdiams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">odiams</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getarray</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span> <span class="s2">&quot;cen_obs&quot;</span><span class="p">)</span>
        <span class="n">odiam</span> <span class="o">=</span> <span class="n">odiams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">separate_atmo_file</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;appendix&quot;</span><span class="p">,</span> <span class="s2">&quot;use_atmo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">separate_atmo_file</span><span class="p">:</span>
            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;appendix&quot;</span><span class="p">,</span> <span class="s2">&quot;atmo_file&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;file for atmo configuration:&quot;</span><span class="p">)</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">((</span><span class="n">confpath</span><span class="o">/</span><span class="n">rel_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
                <span class="n">atmo_config</span> <span class="o">=</span> <span class="n">parsefile</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">confpath</span><span class="o">/</span><span class="n">rel_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;confp was not provided&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;Need to provide fpath&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using same file for atmo configuration&quot;</span><span class="p">)</span>
            <span class="n">atmo_config</span> <span class="o">=</span> <span class="n">theconfig</span>
        
            
        <span class="c1">#atmo_mode = theconfig.get(&quot;atmo&quot;, &quot;atmo_mode&quot;)</span>
        <span class="c1">#if &quot;seeing&quot; in atmo_mode:</span>
        <span class="c1">#    r0 = seeing_to_r0(theconfig.getfloat(&quot;atmo&quot;,&quot;seeing&quot;), lambcen)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    r0 = theconfig.getfloat(&quot;atmo&quot;, &quot;r0&quot;)</span>
        
        
        <span class="c1"># Focal scale and range</span>
        <span class="n">focal_res</span> <span class="o">=</span> <span class="n">focal_res</span>
        <span class="n">focal_hrange</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;focal_hrange&quot;</span><span class="p">)</span>
        <span class="n">pscale</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fiber&quot;</span><span class="p">,</span> <span class="s2">&quot;pscale&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pupil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;pup_res&quot;</span><span class="p">)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">pres</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">pupil</span> <span class="o">=</span> <span class="n">tel_pupil</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">pres</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">theconfig</span><span class="p">,</span> <span class="n">tel_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">ntelescopes</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span> <span class="s2">&quot;n_dish&quot;</span><span class="p">)</span>
        
        <span class="n">rm_inj_piston</span> <span class="o">=</span> <span class="n">theconfig</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;remove_injection_piston&quot;</span><span class="p">)</span>
        
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pupil</span><span class="o">=</span><span class="n">pupil</span><span class="p">,</span>
                 <span class="n">pdiam</span><span class="o">=</span><span class="n">pdiam</span><span class="p">,</span> <span class="n">odiam</span><span class="o">=</span><span class="n">odiam</span><span class="p">,</span>
                 <span class="n">ntelescopes</span><span class="o">=</span><span class="n">ntelescopes</span><span class="p">,</span> <span class="n">tt_correction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">no_piston</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lambda_range</span><span class="o">=</span><span class="n">lambda_range</span><span class="p">,</span>
                 <span class="n">atmo_config</span><span class="o">=</span><span class="n">atmo_config</span><span class="p">,</span>
                 <span class="n">fiber_mode</span><span class="o">=</span><span class="n">fiber_mode</span><span class="p">,</span>
                 <span class="n">NA</span><span class="o">=</span><span class="n">NA</span><span class="p">,</span>
                 <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                 <span class="n">wl_mfd</span><span class="o">=</span><span class="n">wl_mfd</span><span class="p">,</span>
                 <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                 <span class="n">focal_hrange</span><span class="o">=</span><span class="n">focal_hrange</span><span class="p">,</span>
                 <span class="n">focal_res</span><span class="o">=</span><span class="n">focal_res</span><span class="p">,</span>
                 <span class="n">pscale</span><span class="o">=</span><span class="n">pscale</span><span class="p">,</span>
                 <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                 <span class="n">rm_inj_piston</span><span class="o">=</span><span class="n">rm_inj_piston</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">theconfig</span>
        <span class="k">return</span> <span class="n">obj</span></div>
        
        
        
<div class="viewcode-block" id="injector._setup"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector._setup">[docs]</a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Common part of the setup</span>
<span class="sd">        Nota: the seed for creation of the screen is incremented by 1 between pupils</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phscreensz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">theseed</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">theseed</span> <span class="o">=</span> <span class="n">seed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atmo</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atmo_config</span><span class="p">,</span>
                                    <span class="n">seed</span><span class="o">=</span><span class="n">theseed</span><span class="p">,</span>
                                    <span class="n">wind_angle</span><span class="o">=</span><span class="mf">0.08</span><span class="o">+</span><span class="mf">0.01</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">focuser</span><span class="p">(</span><span class="n">csz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phscreensz</span><span class="p">,</span>
                                             <span class="n">xsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_res</span><span class="p">,</span> <span class="n">ysz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_res</span><span class="p">,</span> <span class="n">pupil</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">,</span>
                                             <span class="n">pscale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pscale</span><span class="p">,</span> <span class="n">pdiam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdiam</span><span class="p">,</span>
                                             <span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span> <span class="n">rm_inj_piston</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_inj_piston</span><span class="p">)</span> <span class="k">for</span> <span class="n">wl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiber_mode</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fiber</span> <span class="o">=</span> <span class="n">gaussian_fiber_head</span><span class="p">(</span><span class="n">NA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiber_mode</span> <span class="o">==</span> <span class="s2">&quot;diameter&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fiber</span> <span class="o">=</span> <span class="n">fiber_head</span><span class="p">()</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fibfiber</span> <span class="o">=</span> <span class="n">fiber_head</span><span class="p">()</span>
        <span class="c1"># Caluclating the focal length of the focuser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal_hrange</span><span class="o">/</span><span class="n">utilities</span><span class="o">.</span><span class="n">mas2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fov</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">fp</span><span class="p">[</span><span class="n">wl</span><span class="p">]</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="n">fp</span><span class="p">[</span><span class="n">wl</span><span class="p">]</span><span class="o">.</span><span class="n">phot_noise</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LP01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LP01</span><span class="o">.</span><span class="n">full_consolidation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">)</span>
        <span class="c1">### Still need to figure out the focal scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LP01</span><span class="o">.</span><span class="n">numerical_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_hrange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">)</span>
        <span class="n">quartiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">amap</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">):</span>
            <span class="n">quartiles</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">amap</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_quartiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">quartiles</span><span class="p">)</span>
        
        <span class="c1"># Computing the mode of the fiber in the pupil plane for all scopes and wavelengths</span>
        <span class="c1"># Although they should be all the same</span>
        <span class="n">lppup</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span> <span class="c1"># Iterating ont the scopes</span>
            <span class="n">focal_wl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fiberwl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span> <span class="c1"># Iterating on the wavelengths</span>
                <span class="n">a_lp_pup</span> <span class="o">=</span> <span class="n">fiberwl</span><span class="o">.</span><span class="n">pupil</span> <span class="o">*</span> <span class="n">fiberwl</span><span class="o">.</span><span class="n">get_inv_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
                <span class="n">fiberwl</span><span class="o">.</span><span class="n">lppup</span> <span class="o">=</span> <span class="n">a_lp_pup</span>
                <span class="n">fiberwl</span><span class="o">.</span><span class="n">flat_masked_lppup</span> <span class="o">=</span> <span class="n">fiberwl</span><span class="o">.</span><span class="n">lppup</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">fiberwl</span><span class="o">.</span><span class="n">flatpup</span><span class="p">]</span>   <span class="c1"># This is pre-computation/ to optimize the computation</span>
                <span class="n">focal_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_lp_pup</span><span class="p">)</span>
            <span class="n">lppup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">focal_wl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lppup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lppup</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="injector.reset_screen"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.reset_screen">[docs]</a>    <span class="k">def</span> <span class="nf">reset_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ascreen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">:</span>
            <span class="n">ascreen</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="injector.give_fiber"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.give_fiber">[docs]</a>    <span class="k">def</span> <span class="nf">give_fiber</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span>
                <span class="n">thescreen</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
                <span class="n">focal_wl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fiberwl</span> <span class="ow">in</span> <span class="n">scope</span><span class="p">:</span>
                    <span class="n">focal_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fiberwl</span><span class="o">.</span><span class="n">getimage</span><span class="p">(</span><span class="n">thescreen</span><span class="p">))</span>
                <span class="n">focal_planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">focal_wl</span><span class="p">)</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">focal_planes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focal_planes</span> <span class="o">=</span> <span class="n">focal_planes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">injected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_planes</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">injected</span></div>
            
<div class="viewcode-block" id="injector.give_comparison"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.give_comparison">[docs]</a>    <span class="k">def</span> <span class="nf">give_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A test comparison between image and pupil plane injection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">thescreens</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span>
                <span class="n">thescreen</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
                <span class="n">thescreens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thescreen</span><span class="p">)</span>
                <span class="n">focal_wl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fiberwl</span> <span class="ow">in</span> <span class="n">scope</span><span class="p">:</span>
                    <span class="n">focal_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fiberwl</span><span class="o">.</span><span class="n">getimage</span><span class="p">(</span><span class="n">thescreen</span><span class="p">))</span>
                <span class="n">focal_planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">focal_wl</span><span class="p">)</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">focal_planes</span><span class="p">)</span>
            <span class="c1">#self.focal_planes = focal_planes</span>
            <span class="n">orig_injected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">focal_planes</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span>
                <span class="n">thescreen</span> <span class="o">=</span> <span class="n">thescreens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">focal_wl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ascope</span> <span class="ow">in</span> <span class="n">scope</span><span class="p">:</span>
                    <span class="n">focal_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ascope</span><span class="o">.</span><span class="n">get_injection</span><span class="p">(</span><span class="n">thescreen</span><span class="p">))</span>
                    <span class="c1">#pupil_injected = self.pupil</span>
                <span class="n">focal_planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">focal_wl</span><span class="p">)</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">focal_planes</span><span class="p">)</span>
            <span class="n">pupil_injected</span> <span class="o">=</span> <span class="n">focal_planes</span>
            <span class="c1">#self.focal_planes = focal_planes</span>
            <span class="c1">#self.injected = np.sum(self.focal_planes*self.lpmap[None,:,:,:], axis=(2,3))</span>
            <span class="k">yield</span> <span class="n">orig_injected</span><span class="p">,</span> <span class="n">pupil_injected</span></div>
        

<div class="viewcode-block" id="injector.all_inj_phasors"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.all_inj_phasors">[docs]</a>    <span class="k">def</span> <span class="nf">all_inj_phasors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lambdas</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function that applies interpolation for all the inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">einterp</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">lambdas</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">outs</span></div>
<div class="viewcode-block" id="injector.best_injection"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.best_injection">[docs]</a>    <span class="k">def</span> <span class="nf">best_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lambdas</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function that applies interpolation for all the inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">best_einterp</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">lambdas</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">outs</span></div>
            
<div class="viewcode-block" id="injector.give_interpolated_injection_image_plane"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.give_interpolated_injection_image_plane">[docs]</a>    <span class="k">def</span> <span class="nf">give_interpolated_injection_image_plane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interpolation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This one will yield the method that interpolates all the injection phasors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span>
                <span class="n">thescreen</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
                <span class="n">focal_wl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fiberwl</span> <span class="ow">in</span> <span class="n">scope</span><span class="p">:</span>
                    <span class="n">focal_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fiberwl</span><span class="o">.</span><span class="n">getimage</span><span class="p">(</span><span class="n">thescreen</span><span class="p">))</span>
                <span class="n">focal_planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">focal_wl</span><span class="p">)</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">focal_planes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focal_planes</span> <span class="o">=</span> <span class="n">focal_planes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">injected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_planes</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="c1">#self.injected = np.array([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">einterp</span> <span class="o">=</span> <span class="p">[</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">injected</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                      <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>\
                                                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">)]</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_inj_phasors</span></div>
            
            
<div class="viewcode-block" id="injector.give_interpolated"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.give_interpolated">[docs]</a>    <span class="k">def</span> <span class="nf">give_interpolated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interpolation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This one will yield the method that interpolates all the injection phasors</span>

<span class="sd">        **Arguments:**</span>

<span class="sd">        * interpolation:  type of interpolation to use based on the computed n (typically n=3)</span>
<span class="sd">          wavefronts.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">injection_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span>
                <span class="n">thescreen</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
                <span class="n">inj_wl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fiberwl</span> <span class="ow">in</span> <span class="n">scope</span><span class="p">:</span>
                    <span class="n">inj_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fiberwl</span><span class="o">.</span><span class="n">get_injection</span><span class="p">(</span><span class="n">thescreen</span><span class="p">))</span>
                <span class="n">injection_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inj_wl</span><span class="p">)</span>
            <span class="n">injection_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">injection_values</span><span class="p">)</span>
            <span class="c1">#self.focal_planes = focal_planes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">injected</span> <span class="o">=</span> <span class="n">injection_values</span>
            <span class="c1">#self.injected = np.array([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">einterp</span> <span class="o">=</span> <span class="p">[</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">injected</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                      <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>\
                                                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">)]</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_inj_phasors</span></div>
        
<div class="viewcode-block" id="injector.compute_best_injection"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.compute_best_injection">[docs]</a>    <span class="k">def</span> <span class="nf">compute_best_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interpolation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This one will yield the method that interpolates ideal injection</span>

<span class="sd">        **Arguments:**</span>

<span class="sd">        * interpolation:  type of interpolation to use based on the computed n (typically n=3)</span>
<span class="sd">          wavefronts.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
        
        <span class="n">focal_planes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span>
            <span class="n">thescreen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">it</span><span class="p">))</span>
            <span class="n">focal_wl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fiberwl</span> <span class="ow">in</span> <span class="n">scope</span><span class="p">:</span>
                <span class="n">focal_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fiberwl</span><span class="o">.</span><span class="n">getimage</span><span class="p">(</span><span class="n">thescreen</span><span class="p">))</span>
            <span class="n">focal_planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">focal_wl</span><span class="p">)</span>
        <span class="n">focal_planes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">focal_planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_planes</span> <span class="o">=</span> <span class="n">focal_planes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_planes</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="c1"># Here we dump the first interpolation which returns nans for some reason.</span>
        <span class="c1"># This seeems to be a bug in the library.</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">injected</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                  <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_einterp</span> <span class="o">=</span> <span class="p">[</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">injected</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                  <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>\
                                                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">)]</span></div>
        <span class="c1">#from pdb import set_trace</span>
        <span class="c1">#set_trace()</span>
        
        
<div class="viewcode-block" id="injector.compute_injection_function"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.compute_injection_function">[docs]</a>    <span class="k">def</span> <span class="nf">compute_injection_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">tilt_res</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tilt_range</span><span class="o">=</span><span class="mf">2.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes an interpolation of the injection as a function of a tip-tilt</span>
<span class="sd">        </span>
<span class="sd">        ``injector.injection_abs(wl [m], offset [lambda/D])``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp2d</span>
        
        <span class="n">meanwl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">)</span>
        <span class="c1"># tilt_vector goes for 1 lambda/D</span>
        <span class="n">tilt_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">meanwl</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">meanwl</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">phscreensz</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phscreensz</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tilt_range</span><span class="p">,</span> <span class="n">tilt_res</span><span class="p">)</span>
        <span class="n">injecteds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">theoffset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
            <span class="n">thescreen</span> <span class="o">=</span> <span class="n">theoffset</span> <span class="o">*</span> <span class="n">tilt_vector</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">):</span>
                <span class="n">focal_wl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fiberwl</span> <span class="ow">in</span> <span class="n">scope</span><span class="p">:</span>
                    <span class="n">focal_wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fiberwl</span><span class="o">.</span><span class="n">getimage</span><span class="p">(</span><span class="n">thescreen</span><span class="p">))</span>
                    <span class="c1"># focal_wl.append(fiberwl.get_injection(thescreen))</span>
                <span class="n">focal_planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">focal_wl</span><span class="p">)</span>
            <span class="n">focal_planes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">focal_planes</span><span class="p">)</span>
            <span class="n">injected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">focal_planes</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># print(focal_planes.shape)</span>
            <span class="c1"># injected = np.sum(focal_planes[0])</span>
            <span class="c1">#print(injected.dtype)</span>
            <span class="n">injecteds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">injected</span><span class="p">)</span>
        <span class="n">injecteds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">injecteds</span><span class="p">)</span>
        <span class="n">points_x</span><span class="p">,</span> <span class="n">points_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">points_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">injecteds</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injection_rate</span> <span class="o">=</span> <span class="n">LinearNDInterpolator</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">points_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">points_y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())),</span> <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">injecteds</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="c1"># self.injection_rate = unsorted_intepr2d(self.lambda_range, offset, np.abs(injecteds)**2, kind=interpolation, fill_value=0.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injection_rate</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;rate(wavelength[m], offset[lambda/D])&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injection_arg</span> <span class="o">=</span> <span class="n">LinearNDInterpolator</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">points_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">points_y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())),</span> <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">injecteds</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="c1"># self.injection_arg = unsorted_interp2d(self.lambda_range, offset, np.angle(injecteds), kind=interpolation, fill_value=0.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injection_arg</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;phase(wavelength[m], offset[lambda/D])&quot;&quot;&quot;</span>
        <span class="k">return</span></div>
    
<div class="viewcode-block" id="injector.update_screens"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injector.update_screens">[docs]</a>    <span class="k">def</span> <span class="nf">update_screens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset all the screens for the injection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ascreen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">:</span>
            <span class="n">ascreen</span><span class="o">.</span><span class="n">update_screen</span><span class="p">()</span>
            
        <span class="c1"># Discarding the first value : quick fix for python 3.9??</span>
        <span class="n">discard</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_efunc</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">)</span></div></div>

    
    
    
    
    
    
    
    
    
    
<div class="viewcode-block" id="fringe_tracker"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker">[docs]</a><span class="k">class</span> <span class="nc">fringe_tracker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="fringe_tracker.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theconfig</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the module that simulates the OPD residual from fring tracker performance</span>
<span class="sd">        theconfig    : A parsed config file</span>
<span class="sd">        seed         : Seed for the generation of random OPDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">theconfig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precompute</span> <span class="o">=</span> <span class="n">precompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fringe tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;reference_file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wet_atmosphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;fringe tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;wet_atmosphere&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fringe tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;dry_scaling&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wet_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fringe tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;wet_scaling&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_bias_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;fringe tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;static_bias_scaling&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span><span class="s2">&quot;n_dish&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">parent</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_file</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_ps_phase</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_ps_disp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_dt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span><span class="p">))</span>
        <span class="c1"># timestep: the one that will be used in the simulator</span>
        <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Loading keyword step_time from [atmo] in fringe_tracking&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;step_time&quot;</span><span class="p">)</span></div>
        
        
        
<div class="viewcode-block" id="fringe_tracker.prepare_time_series"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker.prepare_time_series">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_time_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lamb</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call to refresh the time series to use</span>
<span class="sd">        duration        : The duration of the time series to prepare</span>
<span class="sd">        replace         : Replace the time series (otherwise append)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Preparing a fringe tracking residual time series&quot;</span><span class="p">)</span>
        <span class="n">element_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_ps_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">elements_needed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="n">element_duration</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">dryps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">disps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tel</span><span class="p">):</span>
            <span class="c1">#Building up to the required length</span>
            <span class="n">dryp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">disp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elements_needed</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dryp</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">random_series_fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_ps_disp</span><span class="p">,</span> <span class="n">matchto</span><span class="o">=</span><span class="n">dryp</span><span class="p">,</span> <span class="n">keepall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">dryp</span> <span class="o">=</span> <span class="n">dryp</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">static_bias_scaling</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dryp</span><span class="p">)</span>
                <span class="c1"># Make sure to increment the seed every use</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">random_series_fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_ps_disp</span><span class="p">,</span> <span class="n">matchto</span><span class="o">=</span><span class="n">disp</span><span class="p">,</span> <span class="n">keepall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">dryps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dryp</span><span class="p">)</span>
            <span class="n">disps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disp</span><span class="p">)</span>
        <span class="c1"># Assumbling into an array of columns</span>
        <span class="n">dryps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dryps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_scaling</span>
        <span class="n">disps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">disps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wet_scaling</span>
        <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Dry pistons and dispersion residuals scaling refreshed&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_sample_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_dt</span> <span class="o">*</span> <span class="n">dryps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_dt</span><span class="p">)</span>
        <span class="c1">#desired_sample_times = np.arange(0, duration, self.timestep)</span>
        
        <span class="k">if</span> <span class="n">replace</span> <span class="ow">or</span> <span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dry_piston_series</span> <span class="o">=</span> <span class="n">dryps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_series</span> <span class="o">=</span> <span class="n">disps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dry_piston_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dry_piston_series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_piston_series</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersion_series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_series</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_interpolation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phasor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="fringe_tracker.iterator"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker.iterator">[docs]</a>    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lamb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterator that yields the phasors of fringe tracker residuals</span>
<span class="sd">        The iterator sets for precomputed or direct interpolation depending on the configuration.</span>
<span class="sd">        It also sets for wet or dry computation depending on the configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_sample_times</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wet_atmosphere</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">available</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_time_series</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phasor_dry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lamb</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wet atmosphere not implemented&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Wet atmosphere not implemented&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_batch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_sample_times</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wet_atmosphere</span><span class="p">:</span>
                <span class="n">precomp_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_series_piston</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">precomp_length</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_time_series</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phasor_precomputed_dry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">lamb</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logit</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wet atmosphere not implemented&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Wet atmosphere not implemented&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="fringe_tracker.prepare_interpolation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker.prepare_interpolation">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mandatory</span>
<span class="sd">        Computes the interpolation functions to be used later</span>
<span class="sd">        </span>
<span class="sd">        save:</span>
<span class="sd">        </span>
<span class="sd">        ``self.piston_interpolation()``</span>
<span class="sd">        ``self.dispersion_interpolation``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piston_interpolation</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_sample_times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_piston_series</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_interpolation</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_sample_times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_series</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="fringe_tracker.interpolate_batch"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker.interpolate_batch">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        optional:</span>
<span class="sd">        Prepares lookup tables for direct lookup of piston values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">desired_sample_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_series_piston</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">piston_interpolation</span><span class="p">(</span><span class="n">desired_sample_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_series_dispersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion_interpolation</span><span class="p">(</span><span class="n">desired_sample_times</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="fringe_tracker.get_phasor_precomputed_dry"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker.get_phasor_precomputed_dry">[docs]</a>    <span class="k">def</span> <span class="nf">get_phasor_precomputed_dry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">lamb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Precomputed computation are recommended for longer time series when trying to factor-in long timescale effects.</span>
<span class="sd">        One can prepare the &quot;low&quot; resolution series, and dump the original dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_series_dispersion</span><span class="p">[</span><span class="n">i</span><span class="p">,:][:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">lamb</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span></div>
<div class="viewcode-block" id="fringe_tracker.get_phasor_dry"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fringe_tracker.get_phasor_dry">[docs]</a>    <span class="k">def</span> <span class="nf">get_phasor_dry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">lamb</span><span class="p">):</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">piston_interpolation</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">lamb</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span></div></div>
    
                                                    

<span class="c1"># TODO : try legacy: bisplev or RectBivariateSpline</span>
<span class="c1"># For modern try:  interpn, LineraNDInterpolator</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">LinearNDInterpolator</span>


    
<span class="c1"># class unsorted_interp2d(interp2d):</span>
<span class="c1">#     def __call__(self, x, y, dx=0, dy=0):</span>
<span class="c1">#         if (len(x) == 1) and (len(y) == 1):</span>
<span class="c1">#             return interp2d.__call__(self, x, y, dx=dx, dy=dy, assume_sorted=True)</span>
<span class="c1">#         asx = np.argsort(x)</span>
<span class="c1">#         usx = np.argsort(asx)</span>
<span class="c1">#         asy = np.argsort(y)</span>
<span class="c1">#         usy = np.argsort(asy)</span>
    
<span class="c1">#         return interp2d.__call__(self, x[asx], y[asy], dx=dx, dy=dy, assume_sorted=True)[usy,:][:,usx]</span>

<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span>
<span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">mu_0</span><span class="p">,</span> <span class="n">epsilon_0</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logit</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k0</span>

<span class="kn">from</span> <span class="nn">sympy.utilities.lambdify</span> <span class="kn">import</span> <span class="n">implemented_function</span>
<span class="n">J0</span> <span class="o">=</span> <span class="n">implemented_function</span><span class="p">(</span><span class="s2">&quot;J_0&quot;</span><span class="p">,</span> <span class="n">j0</span><span class="p">)</span>
<span class="n">J1</span> <span class="o">=</span> <span class="n">implemented_function</span><span class="p">(</span><span class="s2">&quot;J_1&quot;</span><span class="p">,</span> <span class="n">j1</span><span class="p">)</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">implemented_function</span><span class="p">(</span><span class="s2">&quot;K_0&quot;</span><span class="p">,</span> <span class="n">k0</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sympy.functions.elementary.piecewise</span> <span class="kn">import</span> <span class="n">Piecewise</span>
<span class="kn">from</span> <span class="nn">kernuller</span> <span class="kn">import</span> <span class="n">fprint</span>



<div class="viewcode-block" id="gaussian_fiber_head"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.gaussian_fiber_head">[docs]</a><span class="k">class</span> <span class="nc">gaussian_fiber_head</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="gaussian_fiber_head.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.gaussian_fiber_head.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mfd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl_mfd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class that constructs a gaussian approximation for a fiber mode.</span>
<span class="sd">        Numerical evaluations are based on NA or mfd and wl_mfd, depending</span>
<span class="sd">        on which is provided.</span>
<span class="sd">        ufuncs are stored in:</span>
<span class="sd">        ``Hy_r``</span>
<span class="sd">        ``Hy_xy``</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - NA        : The numerical aperture</span>
<span class="sd">        - mfd       : The mode field diameter [m]</span>
<span class="sd">        - wl_mfd    : The wavelength at which the mfd is measured [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;r, x, y&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;lambda, lambda_0&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;w, R, k&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># q, the beam parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">I</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="o">/</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">qwaist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">subs</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">oo</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sp</span><span class="o">.</span><span class="n">I</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ur</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sp</span><span class="o">.</span><span class="n">I</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="n">uwaist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">subs</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">oo</span><span class="p">),</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">)])</span>
        
        <span class="c1">#self.nclad, self.ncore, self.eps0, self.mu = sp.symbols(&quot;n_clad n_core epsilon_0, mu&quot;, real=True)</span>
        <span class="c1">#self.lamb, self.r, self.a  = sp.symbols(&quot;lambda r a&quot;, real=True)</span>
        <span class="c1">#self.U, self.V, self.W = sp.symbols(&quot;U V W&quot;, real=True)</span>
        <span class="c1">#self.c_H = sp.symbols(&quot;c_H&quot;, real=True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NA</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;N.A.&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># ? taken from Shaklan and Roddier?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># pupil diameter</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">define_substitutions</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">build_equation</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">thesubs</span> <span class="o">=</span> <span class="p">[]</span><span class="c1">#self.subcore_na</span>
        <span class="k">if</span> <span class="n">NA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NA_value</span> <span class="o">=</span> <span class="n">NA</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mfd_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wl_mfd_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thesubs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA_value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mfd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mfd_value</span> <span class="o">=</span> <span class="n">mfd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wl_mfd_value</span> <span class="o">=</span> <span class="n">wl_mfd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NA_value</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">N</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb0</span><span class="o">/</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">w_0</span><span class="p">))</span><span class="o">.</span><span class="n">subs</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl_mfd_value</span><span class="p">),</span>
                                                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mfd_value</span><span class="o">/</span><span class="mi">2</span><span class="p">)]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thesubs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA_value</span><span class="p">))</span>
        <span class="c1">#self.consolidate_equation(self.thesubs)</span>
        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consolidate_equation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thesubs</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="gaussian_fiber_head.define_substitutions"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.gaussian_fiber_head.define_substitutions">[docs]</a>    <span class="k">def</span> <span class="nf">define_substitutions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;w_0&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zr</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">w_0</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rz</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="c1"># that one is not used for now</span>
        <span class="c1">#fprint(Rz, &quot;R(z) = &quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_0</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">zr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#fprint(wz, &quot;w(z) = &quot;)</span>
        <span class="c1"># This one is the cool one!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ur_lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ur</span><span class="o">.</span><span class="n">subs</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">),</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wz</span><span class="p">),</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rz</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nclad</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;n_</span><span class="si">{core}</span><span class="s2">, c_</span><span class="si">{clad}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="gaussian_fiber_head.build_equation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.gaussian_fiber_head.build_equation">[docs]</a>    <span class="k">def</span> <span class="nf">build_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ur_lamb</span><span class="o">.</span><span class="n">subs</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">)])</span></div>
        <span class="c1">#fprint(Hy,&quot;H_y = &quot;)</span>
        
<div class="viewcode-block" id="gaussian_fiber_head.consolidate_equation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.gaussian_fiber_head.consolidate_equation">[docs]</a>    <span class="k">def</span> <span class="nf">consolidate_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thesubs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hy</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">thesubs</span><span class="p">)</span> <span class="c1"># Apply the subsitutions</span>
        <span class="c1">#self.Hy_r = </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_r</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xy</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span><span class="o">.</span><span class="n">subs</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subr</span><span class="p">]))</span></div>
<div class="viewcode-block" id="gaussian_fiber_head.full_consolidation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.gaussian_fiber_head.full_consolidation">[docs]</a>    <span class="k">def</span> <span class="nf">full_consolidation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mfd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl_mfd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completes the consolidation of the lambda function</span>
<span class="sd">        with the application parameters:</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        NA      : The numerical aperture</span>
<span class="sd">        mfd     : The mode field diameter in [m]</span>
<span class="sd">        wl_mfd  : The wavelength at which mfd is measured in [m]</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">NA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thesubs</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">NA</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">subr</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">thesubs</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_0</span><span class="p">,</span> <span class="n">mfd</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">wl_mfd</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">subr</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xylambda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">thesubs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xy_full</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">Hy_xylambda</span><span class="p">)</span></div>
<div class="viewcode-block" id="gaussian_fiber_head.numerical_evaluation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.gaussian_fiber_head.numerical_evaluation">[docs]</a>    <span class="k">def</span> <span class="nf">numerical_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">half_range</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">half_range</span><span class="p">,</span> <span class="n">half_range</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">half_range</span><span class="p">,</span> <span class="n">half_range</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">))</span>
        <span class="n">amap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xy_full</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">yy</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">lambs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">map_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">amap</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">amap</span> <span class="o">/</span> <span class="n">map_total</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="c1">#from pdb import set_trace</span>
        <span class="c1">#set_trace()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span></div></div>



<div class="viewcode-block" id="fiber_head"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fiber_head">[docs]</a><span class="k">class</span> <span class="nc">fiber_head</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="fiber_head.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fiber_head.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class that constructs helps compute the LP01 mode of</span>
<span class="sd">        a fiber.</span>
<span class="sd">        </span>
<span class="sd">        **ufuncs are stored in:**</span>
<span class="sd">        </span>
<span class="sd">        - ``Hy_r``</span>
<span class="sd">        - ``Hy_xy``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nclad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;n_clad n_core epsilon_0, mu&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>  <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;lambda r a&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;U V W&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_H</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;c_H&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NA</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;N.A.&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># ? taken from Shaklan and Roddier?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># pupil diameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity_E0</span> <span class="o">=</span> <span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">eps0</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nclad</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">define_substitutions</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">build_equation</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">thesubs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subU_VW</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">subru_neu</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">subv</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">subch</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">subcore_na</span><span class="p">,</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">mu_0</span><span class="p">),</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps0</span><span class="p">,</span> <span class="n">epsilon_0</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consolidate_equation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thesubs</span><span class="p">)</span></div>
        
        
        
        
<div class="viewcode-block" id="fiber_head.define_substitutions"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fiber_head.define_substitutions">[docs]</a>    <span class="k">def</span> <span class="nf">define_substitutions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Defining some basic substitutions from the paper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subv</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span> <span class="c1">#Expr. of V from N.A.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subna</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nclad</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#Expr of NA from nclad &amp; ncore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcore_na</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nclad</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#Expr nclad from N.A.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subch</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_H</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nclad</span><span class="o">/</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span> <span class="c1">#c_H from Shaklan&amp;Roddier</span>
        <span class="c1"># From Rudolph and Neumann 1976 (cited in Coudé du Forest 1994)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subU_VW</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># U from V and W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subru_neu</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="mf">1.1428</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">-</span> <span class="mf">0.9960</span><span class="p">)</span> <span class="c1"># The approximation of the transcendental eq.</span></div>
        
<div class="viewcode-block" id="fiber_head.build_equation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fiber_head.build_equation">[docs]</a>    <span class="k">def</span> <span class="nf">build_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piece1</span> <span class="o">=</span> <span class="n">J0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">J0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piece2</span> <span class="o">=</span> <span class="n">K0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">K0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">c_H</span><span class="o">/</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">*</span><span class="n">J0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">J1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">))</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">Hy</span> <span class="o">=</span> <span class="n">Piecewise</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">common</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">piece1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">piece2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">))</span></div>
        <span class="c1">#fprint(Hy,&quot;H_y = &quot;)</span>
        
<div class="viewcode-block" id="fiber_head.consolidate_equation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fiber_head.consolidate_equation">[docs]</a>    <span class="k">def</span> <span class="nf">consolidate_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thesubs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hy</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">thesubs</span><span class="p">)</span> <span class="c1"># Apply the subsitutions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_r</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;x, y&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xy</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span><span class="o">.</span><span class="n">subs</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subr</span><span class="p">]))</span></div>
<div class="viewcode-block" id="fiber_head.full_consolidation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fiber_head.full_consolidation">[docs]</a>    <span class="k">def</span> <span class="nf">full_consolidation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NA</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ncore</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completes the consolidation of the lambda function</span>
<span class="sd">        with the application parameters:</span>
<span class="sd">        </span>
<span class="sd">        - NA  : The numerical aperture</span>
<span class="sd">        - a   : The core radius in meters</span>
<span class="sd">        - ncore : the refractive index of the core</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thesubs</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">NA</span><span class="p">),</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">,</span> <span class="n">ncore</span><span class="p">),</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">subr</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xylambda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hy_consolidated</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">thesubs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xy_full</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">Hy_xylambda</span><span class="p">)</span></div>
<div class="viewcode-block" id="fiber_head.numerical_evaluation"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.fiber_head.numerical_evaluation">[docs]</a>    <span class="k">def</span> <span class="nf">numerical_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">half_range</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">half_range</span><span class="p">,</span> <span class="n">half_range</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">half_range</span><span class="p">,</span> <span class="n">half_range</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">))</span>
        <span class="n">amap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hy_xy_full</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">yy</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">lambs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">map_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">amap</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">amap</span> <span class="o">/</span> <span class="n">map_total</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="c1">#from pdb import set_trace</span>
        <span class="c1">#set_trace()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span></div></div>


<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">units</span>
<div class="viewcode-block" id="injection_vigneting"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injection_vigneting">[docs]</a><span class="k">class</span> <span class="nc">injection_vigneting</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A shortcut to injection simulation in the case of diffuse sources</span>
<span class="sd">    injector     : an injector object to emulate</span>
<span class="sd">    res          : </span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="injection_vigneting.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injection_vigneting.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">injector</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut to injection simulation in the case of diffuse sources</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - injector     : an injector object to emulate</span>
<span class="sd">        - res          : The resolution of the map</span>
<span class="sd">        - crop         : A factor that scales the FoV of the map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First build a grid of coordinates</span>
        
        <span class="n">lambond</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">)</span> <span class="o">/</span> <span class="n">injector</span><span class="o">.</span><span class="n">pdiam</span><span class="p">)</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">rad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mas2lambond</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">lambond</span>
        
        <span class="n">hskyextent</span> <span class="o">=</span> <span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">focal_hrange</span><span class="o">/</span><span class="n">injector</span><span class="o">.</span><span class="n">focal_length</span><span class="p">)</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">rad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span>
        <span class="n">hskyextent</span> <span class="o">=</span> <span class="n">hskyextent</span><span class="o">*</span><span class="n">crop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resol</span> <span class="o">=</span> <span class="n">res</span> <span class="c1">#injector.focal_res</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">hskyextent</span><span class="p">,</span> <span class="n">hskyextent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">hskyextent</span><span class="p">,</span> <span class="n">hskyextent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collecting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">pdiam</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">injector</span><span class="o">.</span><span class="n">odiam</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">xx</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">yy</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#In mas^2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_sr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">mas</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="c1"># In sr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rr_lambdaond</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">rr</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mas2lambond</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mas2lambond</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">injector</span><span class="p">,</span> <span class="s2">&quot;injection_rate&quot;</span><span class="p">):</span>
            <span class="n">injector</span><span class="o">.</span><span class="n">compute_injection_function</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">tilt_range</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">mygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr_lambdaond</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vig</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="n">injection_rate</span><span class="p">(</span><span class="o">*</span><span class="n">mygrid</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">mygrid</span>
        <span class="c1"># self.vig = injector.injection_rate(injector.lambda_range, self.rr_lambdaond)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vig_func</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="n">injection_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vig</span><span class="p">)</span></div>

<div class="viewcode-block" id="injection_vigneting.vigneted_spectrum"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injection_vigneting.vigneted_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">vigneted_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">lambda_range</span><span class="p">,</span> <span class="n">exptime</span><span class="p">,</span> <span class="n">transmission</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Includes collecting area, throughput (in transmission is not None)</span>
<span class="sd">        and pixel solid angle</span>
<span class="sd">        </span>
<span class="sd">        transmission: The first object of the transmission-emission chain</span>
<span class="sd">        to be used to compute the instrument transmission. This allows to account</span>
<span class="sd">        for throughtput, including airmass.</span>
<span class="sd">        </span>
<span class="sd">        spectrum   : Flux density in ph/s/sr/m^2 </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transmission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throughput</span> <span class="o">=</span> <span class="n">transmission</span><span class="o">.</span><span class="n">get_downstream_transmission</span><span class="p">(</span><span class="n">lambda_range</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">throughput</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collecting</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_sr</span> <span class="o">*</span> <span class="n">exptime</span>
        <span class="n">mygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lambda_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr_lambdaond</span><span class="p">)</span>
        <span class="n">vigneted_spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vig_func</span><span class="p">(</span><span class="o">*</span><span class="n">mygrid</span><span class="p">)</span> <span class="o">*</span>\
                                            <span class="p">(</span><span class="n">spectrum</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">throughput</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span>
        <span class="k">del</span> <span class="n">mygrid</span>
        <span class="c1"># vigneted_spectrum = self.vig_func(lambda_range, self.rr_lambdaond) *\</span>
        <span class="c1">#                                     (spectrum * factor * throughput)[None,:]</span>
        <span class="k">return</span> <span class="n">vigneted_spectrum</span></div></div>

<div class="viewcode-block" id="injection_cloud"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injection_cloud">[docs]</a><span class="k">class</span> <span class="nc">injection_cloud</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A shortcut to injection simulation in the case of diffuse sources</span>
<span class="sd">    injector     : an injector object to emulate</span>
<span class="sd">    res          : </span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="injection_cloud.__init__"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injection_cloud.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">injector</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut to injection simulation in the case of diffuse sources</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        - injector     : an injector object to emulate</span>
<span class="sd">        - res          : The resolution of the map</span>
<span class="sd">        - crop         : A factor that scales the FoV of the map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First build a grid of coordinates</span>
        
        <span class="n">lambond</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">)</span> <span class="o">/</span> <span class="n">injector</span><span class="o">.</span><span class="n">pdiam</span><span class="p">)</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">rad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mas2lambond</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">lambond</span>
        
        <span class="n">hskyextent</span> <span class="o">=</span> <span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">focal_hrange</span><span class="o">/</span><span class="n">injector</span><span class="o">.</span><span class="n">focal_length</span><span class="p">)</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">rad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span>
        <span class="n">hskyextent</span> <span class="o">=</span> <span class="n">hskyextent</span><span class="o">*</span><span class="n">crop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resol</span> <span class="o">=</span> <span class="n">res</span> <span class="c1">#injector.focal_res</span>
        
        <span class="n">xys_mas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">hskyextent</span><span class="p">,</span> <span class="n">high</span><span class="o">=+</span><span class="n">hskyextent</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> 
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xys_mas</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">xys_mas</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collecting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">pdiam</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">injector</span><span class="o">.</span><span class="n">odiam</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">hskyextent</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="c1">#In mas^2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_sr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">mas</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="c1"># In sr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rr_lambdaond</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">rr</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mas2lambond</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mas2lambond</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">injector</span><span class="p">,</span> <span class="s2">&quot;injection_rate&quot;</span><span class="p">):</span>
            <span class="n">injector</span><span class="o">.</span><span class="n">compute_injection_function</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">tilt_range</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">mygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">injector</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rr_lambdaond</span><span class="p">),</span> <span class="n">res</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vig</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="n">injection_rate</span><span class="p">(</span><span class="o">*</span><span class="n">mygrid</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">mygrid</span>
        <span class="c1"># self.vig = injector.injection_rate(injector.lambda_range, self.rr_lambdaond)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vig_func</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="n">injection_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vig</span><span class="p">)</span></div>

<div class="viewcode-block" id="injection_cloud.vigneted_spectrum"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.injection_cloud.vigneted_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">vigneted_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">lambda_range</span><span class="p">,</span> <span class="n">exptime</span><span class="p">,</span> <span class="n">transmission</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        transmission: The first object of the transmission-emission chain</span>
<span class="sd">        to be used to compute the instrument transmission. This allows to account</span>
<span class="sd">        for throughtput, including airmass.</span>
<span class="sd">        </span>
<span class="sd">        spectrum   : Flux density in ph/s/sr/m^2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transmission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throughput</span> <span class="o">=</span> <span class="n">transmission</span><span class="o">.</span><span class="n">get_downstream_transmission</span><span class="p">(</span><span class="n">lambda_range</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">throughput</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collecting</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_sr</span> <span class="o">*</span> <span class="n">exptime</span>
        <span class="n">mygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lambda_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr_lambdaond</span><span class="p">)</span>
        <span class="n">vigneted_spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vig_func</span><span class="p">(</span><span class="o">*</span><span class="n">mygrid</span><span class="p">)</span> <span class="o">*</span>\
                                            <span class="p">(</span><span class="n">spectrum</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">throughput</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span>
        <span class="k">del</span> <span class="n">mygrid</span>
        <span class="c1"># vigneted_spectrum = self.vig_func(lambda_range, self.rr_lambdaond) *\</span>
        <span class="c1">#                                     (spectrum * factor * throughput)[None,:]</span>
        <span class="k">return</span> <span class="n">vigneted_spectrum</span></div></div>
    
<div class="viewcode-block" id="test_fiber"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.test_fiber">[docs]</a><span class="k">def</span> <span class="nf">test_fiber</span><span class="p">():</span>
    
    
    <span class="n">NA</span> <span class="o">=</span> <span class="mf">0.21</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">3.0e-6</span>
    <span class="n">lamb0</span> <span class="o">=</span> <span class="mf">3.0e-6</span>
    <span class="n">lambmax</span> <span class="o">=</span> <span class="mf">4.2e-6</span>
    
    <span class="n">focrange</span> <span class="o">=</span> <span class="mf">8.0e-6</span>
    <span class="n">lamb_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">lambmax</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">focrange</span><span class="p">,</span> <span class="n">focrange</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">focrange</span><span class="p">,</span> <span class="n">focrange</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    
    <span class="n">myfiber</span> <span class="o">=</span> <span class="n">fiber_head</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">asub</span> <span class="ow">in</span> <span class="n">myfiber</span><span class="o">.</span><span class="n">thesubs</span><span class="p">:</span>
        <span class="n">fprint</span><span class="p">(</span><span class="n">asub</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">latex</span><span class="p">(</span><span class="n">asub</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot; = &quot;</span><span class="p">)</span>
    <span class="n">fprint</span><span class="p">(</span><span class="n">myfiber</span><span class="o">.</span><span class="n">Hy</span><span class="p">,</span> <span class="s2">&quot;H_y = &quot;</span><span class="p">)</span>
    
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fiber for the following parameters&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;N.A. = </span><span class="si">%.2f</span><span class="s2">, a = </span><span class="si">%.1f</span><span class="s2"> µm, \lambda = [</span><span class="si">%.1f</span><span class="s2">..</span><span class="si">%.1f</span><span class="s2">] (µm)&quot;</span><span class="o">%</span>
                          <span class="p">(</span><span class="n">NA</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">lambmax</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span>
    
    <span class="n">LPMAP</span> <span class="o">=</span> <span class="n">myfiber</span><span class="o">.</span><span class="n">Hy_xy</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">yy</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="mf">0.21</span><span class="p">,</span> <span class="mf">3.0e-6</span><span class="p">,</span> <span class="n">lamb_range</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="mf">2.7</span><span class="p">)</span>
    <span class="n">LPMAP</span> <span class="o">=</span> <span class="n">LPMAP</span><span class="o">/</span><span class="n">LPMAP</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">myfiber</span><span class="o">.</span><span class="n">full_consolidation</span><span class="p">(</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">3.0e-6</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">)</span>
    <span class="n">LPMAP2</span> <span class="o">=</span> <span class="n">myfiber</span><span class="o">.</span><span class="n">numerical_evaluation</span><span class="p">(</span><span class="mf">10.0e-6</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">lamb_range</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LPMAP2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LPMAP2</span><span class="p">[</span><span class="mi">9</span><span class="p">,:,:]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">8.0e-6</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">H1D</span> <span class="o">=</span> <span class="n">myfiber</span><span class="o">.</span><span class="n">Hy_r</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">,</span> <span class="mf">3.0e-6</span><span class="p">,</span> <span class="mf">3.6e-6</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">H1D</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">myfiber</span></div>
            
<div class="viewcode-block" id="test_injection"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.test_injection">[docs]</a><span class="k">def</span> <span class="nf">test_injection</span><span class="p">(</span><span class="n">phscreensz</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="mf">8.</span><span class="p">,</span>
                   <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">20127</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remember to pass seed=None if you want a random initialization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xaosim</span>
    <span class="c1"># Construct a pupil using xaosim</span>
    <span class="n">apup</span> <span class="o">=</span> <span class="n">xaosim</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">VLT</span><span class="p">(</span><span class="n">phscreensz</span><span class="p">,</span> <span class="n">phscreensz</span><span class="p">,</span><span class="n">phscreensz</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">myinst</span> <span class="o">=</span> <span class="n">injector</span><span class="p">(</span><span class="n">pupil</span><span class="o">=</span><span class="n">apup</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span>
                     <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">injected</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
    <span class="c1">#contourlabels = [&quot;0.&quot;,&quot;0.25&quot;,&quot;0.5&quot;, &quot;O.75&quot;]</span>
    <span class="c1">#tweaking the colormap showing the pupil cutout</span>
    <span class="n">current_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
    <span class="n">current_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_phs</span><span class="o">/</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pupil</span><span class="p">),</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">current_cmap</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_planes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="n">myinst</span><span class="o">.</span><span class="n">map_quartiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_planes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">)</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="n">myinst</span><span class="o">.</span><span class="n">map_quartiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Injection focal plane (contours: LP01 mode quartiles)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">tindexes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Telescope </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">injected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">injected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">injected</span><span class="p">[:,</span><span class="n">i</span><span class="p">]),</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> µm&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Injection amplitude&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Injection amplitude for each telescope by WL&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">injected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">injected</span><span class="p">[:,</span><span class="n">i</span><span class="p">]),</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> µm&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Injection phase (radians)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Injection phase for each telescope by WL&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">myinst</span></div>

<div class="viewcode-block" id="test_injection_fromfile"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.test_injection_fromfile">[docs]</a><span class="k">def</span> <span class="nf">test_injection_fromfile</span><span class="p">(</span><span class="n">phscreensz</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
                            <span class="n">fpath</span><span class="o">=</span><span class="s2">&quot;/home/rlaugier/Documents/hi5/SCIFYsim/scifysim/config/default_new_4T.ini&quot;</span><span class="p">,</span>
                            <span class="n">seed</span><span class="o">=</span><span class="mi">20127</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Remember** to pass ``seed=None`` if you want a **random initialization**</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xaosim</span>
    <span class="c1"># Construct a pupil using xaosim</span>
    <span class="n">apup</span> <span class="o">=</span> <span class="n">xaosim</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">VLT</span><span class="p">(</span><span class="n">phscreensz</span><span class="p">,</span> <span class="n">phscreensz</span><span class="p">,</span><span class="n">phscreensz</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">myinst</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="n">from_config_file</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span>
                                     <span class="n">pupil</span><span class="o">=</span><span class="n">apup</span><span class="p">,</span>
                                     <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">injected</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
    <span class="c1">#contourlabels = [&quot;0.&quot;,&quot;0.25&quot;,&quot;0.5&quot;, &quot;O.75&quot;]</span>
    <span class="c1">#tweaking the colormap showing the pupil cutout</span>
    <span class="n">current_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
    <span class="n">current_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_phs</span><span class="o">/</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_plane</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pupil</span><span class="p">),</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">current_cmap</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_planes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="n">myinst</span><span class="o">.</span><span class="n">map_quartiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">myinst</span><span class="o">.</span><span class="n">ntelescopes</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">focal_planes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">)</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lpmap</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="n">myinst</span><span class="o">.</span><span class="n">map_quartiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Injection focal plane (contours: LP01 mode quartiles)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">tindexes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Telescope </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">injected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">injected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">injected</span><span class="p">[:,</span><span class="n">i</span><span class="p">]),</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> µm&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Injection amplitude&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Injection amplitude for each telescope by WL&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">injected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">injected</span><span class="p">[:,</span><span class="n">i</span><span class="p">]),</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> µm&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">myinst</span><span class="o">.</span><span class="n">lambda_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Injection phase (radians)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Injection phase for each telescope by WL&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">myinst</span></div>
    
    

<span class="c1"># An implementation from Ruiliier 2005 (thèse)</span>
<span class="c1"># WIP</span>
<div class="viewcode-block" id="optimize_a"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.optimize_a">[docs]</a><span class="k">def</span> <span class="nf">optimize_a</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>
    <span class="n">rho</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;rho, beta, alpha&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">D</span><span class="p">,</span> <span class="n">omega0</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;D, omega_0, lambda, f&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rhoexpr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">betaexpr</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">D</span><span class="o">*</span><span class="n">omega0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lamb</span><span class="o">*</span><span class="n">f</span><span class="p">)</span>

    <span class="n">rhoexpr</span> <span class="o">=</span> <span class="n">rhoexpr</span><span class="o">.</span><span class="n">subs</span><span class="p">([(</span><span class="n">beta</span><span class="p">,</span> <span class="n">betaexpr</span><span class="p">)])</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">rhoexpr</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">omega0</span><span class="p">),</span> <span class="n">omega0</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="tel_pupil"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.tel_pupil">[docs]</a><span class="k">def</span> <span class="nf">tel_pupil</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdiam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">odiam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spiders</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">between_pix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tel_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    returns an array that draws the pupil of the VLT</span>
<span class="sd">    at the center of an array of size (n,m) with radius &quot;radius&quot;.</span>
<span class="sd">    </span>
<span class="sd">    This is an approximation to reduce number of parameters:</span>
<span class="sd">    offset an angle are approximated. See xaosim.pupil.VLT for original</span>
<span class="sd">    </span>
<span class="sd">    Parameters describing the pupil were deduced from a pupil mask</span>
<span class="sd">    description of the APLC coronograph of SPHERE, by Guerri et al, </span>
<span class="sd">    2011. </span>

<span class="sd">    `&lt;http://cdsads.u-strasbg.fr/abs/2011ExA....30...59G&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">xaosim</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pdiam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pdiam</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">getarray</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span><span class="s2">&quot;diam&quot;</span><span class="p">)[</span><span class="n">tel_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">odiam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">odiam</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">getarray</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span><span class="s2">&quot;cen_obs&quot;</span><span class="p">)[</span><span class="n">tel_index</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">odiam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pdiam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either a file or kw values&quot;</span><span class="p">)</span>
            
    <span class="c1"># Those are fill values, and should not be very important</span>
    <span class="n">thick</span>  <span class="o">=</span> <span class="mf">0.04</span>              <span class="c1"># adopted spider thickness (meters)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">odiam</span> <span class="c1">#1.11              # spider intersection offset (meters)</span>
    <span class="n">beta</span>   <span class="o">=</span> <span class="mf">50.</span>      <span class="c1">#50.5           # spider angle beta</span>
    
    <span class="n">apupil</span> <span class="o">=</span> <span class="n">xaosim</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">four_spider_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">pdiam</span><span class="p">,</span> <span class="n">odiam</span><span class="p">,</span> 
                            <span class="n">beta</span><span class="p">,</span> <span class="n">thick</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">spiders</span><span class="o">=</span><span class="n">spiders</span><span class="p">,</span>
                            <span class="n">between_pix</span><span class="o">=</span><span class="n">between_pix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">apupil</span></div>
<div class="viewcode-block" id="test_injection_function"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.test_injection_function">[docs]</a><span class="k">def</span> <span class="nf">test_injection_function</span><span class="p">(</span><span class="n">asim</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">injector</span><span class="o">.</span><span class="n">compute_injection_function</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">tilt_range</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">os</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">3e-6</span><span class="p">,</span> <span class="mf">4e-6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">injector</span><span class="o">.</span><span class="n">injection_rate</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">os</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">injector</span><span class="o">.</span><span class="n">injection_arg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">os</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">awl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">rates</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> $\mu m$&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">awl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">awl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">args</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> $\mu m$&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">awl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
    
    

<div class="viewcode-block" id="seeing_to_r0"><a class="viewcode-back" href="../../scifysim.injection.html#scifysim.injection.seeing_to_r0">[docs]</a><span class="k">def</span> <span class="nf">seeing_to_r0</span><span class="p">(</span><span class="n">seeing</span><span class="p">,</span> <span class="n">wl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    seeing : seeing in arcseconds</span>
<span class="sd">    wl     : wl in m</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">/</span> <span class="p">(</span><span class="n">seeing</span><span class="o">/</span><span class="mi">3600</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">r0</span></div>
    

<span class="c1"># ===========================================================</span>
<span class="c1"># ===========================================================</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Romain Laugier.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>