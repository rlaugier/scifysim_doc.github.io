

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>scifysim.utilities &mdash; SCIFYsim 0.2.2 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/fonts.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SCIFYsim
          

          
          </a>

          
            
            
              <div class="version">
                0.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.analysis.html">scifysim.analysis module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.bimorph.html">scifysim.bimorph module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.combiner.html">scifysim.combiner module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.combiners.html">scifysim.combiners module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.confconverter.html">scifysim.confconverter module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.correctors.html">scifysim.correctors module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.director.html">scifysim.director module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.injection.html">scifysim.injection module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.map_manager.html">scifysim.map_manager module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.mol_dens.html">scifysim.mol_dens module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.n_air.html">scifysim.n_air module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.observatory.html">scifysim.observatory module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.parsefile.html">scifysim.parsefile module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.plot_tools.html">scifysim.plot_tools module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.sources.html">scifysim.sources module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.spectrograph.html">scifysim.spectrograph module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.utilities.html">scifysim.utilities module</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SCIFYsim</a>
        
      </nav>


      <div class="wy-nav-content">
<div class="git-ribbon">
  <a href="http://github.com/SwissDataScienceCenter" rel="me">Join us on GitHub</a>
</div>

        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>scifysim.utilities</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for scifysim.utilities</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">kernuller</span> <span class="kn">import</span> <span class="n">mas2rad</span>
<span class="kn">from</span> <span class="nn">kernuller</span> <span class="kn">import</span> <span class="n">rad2mas</span>
<span class="kn">from</span> <span class="nn">kernuller</span> <span class="kn">import</span> <span class="n">fprint</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logit</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="vec2diag"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.vec2diag">[docs]</a><span class="k">def</span> <span class="nf">vec2diag</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replictes in sympy the np.diag functionnality to create a</span>
<span class="sd">    diagonal matrix from a 1D vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thelen</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">thelen</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thelen</span><span class="p">):</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="lambdifyz"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.lambdifyz">[docs]</a><span class="k">def</span> <span class="nf">lambdifyz</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Circumvents a bug in lambdify where silent </span>
<span class="sd">    variables will be simplified and therefore</span>
<span class="sd">    aren&#39;t broadcasted. `&lt;https://github.com/sympy/sympy/issues/5642&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    Use an extra argument = 0 when calling</span>
<span class="sd">    </span>
<span class="sd">    Please, keep the function synchronous with kernuller</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
    <span class="n">thesymbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
    <span class="n">thesymbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">exprz</span> <span class="o">=</span> <span class="n">expr</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">fz</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">thesymbols</span><span class="p">,</span> <span class="n">exprz</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="n">modules</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fz</span></div>



<div class="viewcode-block" id="ee"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.ee">[docs]</a><span class="k">class</span> <span class="nc">ee</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Additional functionnality needed:</span>
<span class="sd">    see comments starting 2021/02/24 `&lt;https://github.com/sympy/sympy/issues/5642&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ee.__init__"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.ee.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ee is for Executable expression</span>
<span class="sd">        Encapsulates an expression for flexible lambda evaluation.</span>
<span class="sd">        expression  : a sympy expression to lambdify</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expression</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">is_Matrix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outlen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outshape</span><span class="p">)</span>
            <span class="c1">#self.callfunction = self.setup_matrixfunction()</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outlen</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="ee.lambdify"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.ee.lambdify">[docs]</a>    <span class="k">def</span> <span class="nf">lambdify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the lambda function. Currently, lambdification to numexpr</span>
<span class="sd">        does not support multiple outputs, so we create a list of lambda functions.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * args    : a tuple of sympy for symbols to use as inputs</span>
<span class="sd">        * modules : The module to use for computation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Here, we have to decide if we need the function to all </span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;numexpr&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outlen</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">thefuncs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outlen</span><span class="p">):</span>
                <span class="n">thefuncs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span> <span class="n">modules</span><span class="o">=</span><span class="n">modules</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">thefuncs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callfunction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numexpr_call</span>
            
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="n">modules</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callfunction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpy_call</span></div>
            
            
<div class="viewcode-block" id="ee.numexpr_call"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.ee.numexpr_call">[docs]</a>    <span class="k">def</span> <span class="nf">numexpr_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The evaluation call for funcions for the numexpr case</span>
<span class="sd">        Evaluating the list of functions and returning it as an array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outlen</span><span class="p">)])</span></div>
    
<div class="viewcode-block" id="ee.numpy_call"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.ee.numpy_call">[docs]</a>    <span class="k">def</span> <span class="nf">numpy_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just the normal call of the lambda function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="c1"># Here, we flatten for consitency?</span></div>
    
<div class="viewcode-block" id="ee.__call__"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.ee.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callfunction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span></div>
<div class="viewcode-block" id="ee.fprint"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.ee.fprint">[docs]</a>    <span class="k">def</span> <span class="nf">fprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span></div></div>
    

<div class="viewcode-block" id="prepare_all"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.prepare_all">[docs]</a><span class="k">def</span> <span class="nf">prepare_all</span><span class="p">(</span><span class="n">afile</span><span class="p">,</span> <span class="n">thetarget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_params</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">instrumental_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">crop</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">target_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">compensate_chromatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">modificators</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A shortcut to prepare a simulator object</span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    - afile      : Config file </span>
<span class="sd">    - thetarget  : target name to replace in config file</span>
<span class="sd">    - instrumental_errors : Bool. Whether to include instrumental</span>
<span class="sd">      errors</span>
<span class="sd">    - seed       : seed to pass when generating the </span>
<span class="sd">      time series of instrumental errors</span>
<span class="sd">    - crop       : factor to pass to the injector</span>
<span class="sd">    - target_coords : Coordinates of the target </span>
<span class="sd">      default:None : finds the target from catalog</span>
<span class="sd">    - compensate_chromatic : Bool Whether to run the optimization</span>
<span class="sd">      of the actuators to compensate for chromaticity</span>
<span class="sd">      in the combiner</span>
<span class="sd">    - modificators : a dict of parameters to supersede the config file</span>
<span class="sd">    </span>
<span class="sd">    **Returns:**</span>
<span class="sd">    </span>
<span class="sd">    - asim        : A simulator object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scifysim</span> <span class="kn">import</span> <span class="n">director</span>
    <span class="n">asim</span> <span class="o">=</span> <span class="n">director</span><span class="o">.</span><span class="n">simulator</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">afile</span><span class="p">)</span>
    <span class="c1">#asim.config = loaded_config</span>
    <span class="k">if</span> <span class="n">thetarget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">thetarget</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update_params</span><span class="p">:</span>
        <span class="n">update_star_params</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">update_observing_night</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">target_coords</span><span class="o">=</span><span class="n">target_coords</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_observatory</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modificators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">amod</span> <span class="ow">in</span> <span class="n">modificators</span><span class="p">:</span>
            <span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">amod</span><span class="p">[</span><span class="s2">&quot;section&quot;</span><span class="p">],</span> <span class="n">amod</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="n">amod</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrumental_errors</span><span class="p">:</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fringe tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;dry_scaling&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0001&quot;</span><span class="p">)</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fringe tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;wet_scaling&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0001&quot;</span><span class="p">)</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;atmo&quot;</span><span class="p">,</span> <span class="s2">&quot;correc&quot;</span><span class="p">,</span> <span class="s2">&quot;300.&quot;</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_injector</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="n">crop</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_combiner</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_sequence</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_fringe_tracker</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">fringe_tracker</span><span class="o">.</span><span class="n">prepare_time_series</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">lambda_science_range</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_integrator</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">keepall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">infinite_well</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_spectrograph</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_sources</span><span class="p">()</span>
    <span class="n">highest</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">highest</span><span class="p">],</span> <span class="n">asim</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">reset_static</span><span class="p">()</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">chromatic_matrix</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">lambda_science_range</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">prepare_corrector</span><span class="p">(</span><span class="n">optimize</span><span class="o">=</span><span class="n">compensate_chromatic</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">asim</span></div>


<span class="kn">import</span> <span class="nn">itertools</span>
<div class="viewcode-block" id="get_uv"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.get_uv">[docs]</a><span class="k">def</span> <span class="nf">get_uv</span><span class="p">(</span><span class="n">puparray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the uv baselines for a given pupil configuration.</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * puparray    : An array representing the location of each pupil</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">puparray</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c1">#print(pair)</span>
        <span class="n">uv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">puparray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c1">#print(pair)</span>
        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uv</span><span class="p">,</span> <span class="n">indices</span></div>
    

<div class="viewcode-block" id="test_ex"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.test_ex">[docs]</a><span class="k">def</span> <span class="nf">test_ex</span><span class="p">():</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;x y&quot;</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">objf1</span> <span class="o">=</span> <span class="n">ee</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">objf1</span><span class="o">.</span><span class="n">fprint</span><span class="p">()</span>
    
    <span class="n">objf1</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf1</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="mf">11.</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result with numpy :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">objf1</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf1</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="mf">11.</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result with numexpr :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    
    
    <span class="n">f2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">objf2</span> <span class="o">=</span> <span class="n">ee</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
    <span class="n">objf2</span><span class="o">.</span><span class="n">fprint</span><span class="p">()</span>
    
    <span class="n">objf2</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf2</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="mf">11.</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result with numpy :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">objf2</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf2</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="mf">11.</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result with numexpr :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    
    
    <span class="n">f3</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">objf3</span> <span class="o">=</span> <span class="n">ee</span><span class="p">(</span><span class="n">f3</span><span class="p">)</span>
    <span class="n">objf3</span><span class="o">.</span><span class="n">fprint</span><span class="p">()</span>
    
    <span class="n">objf3</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf3</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="mf">11.</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result with numpy :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">objf3</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">objf3</span><span class="o">.</span><span class="n">outlen</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf3</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="mf">11.</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result with numexpr :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Broadcasting example&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====================&quot;</span><span class="p">)</span>
    
    <span class="n">objf2</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf2</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">],</span> <span class="mf">11.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;broadcas with numpy :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape:&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="n">objf2</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">modules</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">objf2</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">],</span> <span class="mf">11.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;broadcas with numexpr :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape:&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">b</span></div>





<span class="kn">import</span> <span class="nn">cProfile</span><span class="o">,</span> <span class="nn">pstats</span><span class="o">,</span> <span class="nn">io</span>

<div class="viewcode-block" id="profileit"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.profileit">[docs]</a><span class="k">def</span> <span class="nf">profileit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">highres</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">datafn</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.profile&quot;</span> <span class="c1"># Name the data file sensibly</span>
        <span class="k">if</span> <span class="n">highres</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter_ns</span>
            <span class="n">prof</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">(</span><span class="n">perf_counter_ns</span><span class="p">,</span> <span class="n">timeunit</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prof</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">runcall</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">sortby</span> <span class="o">=</span> <span class="s1">&#39;cumulative&#39;</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="n">sortby</span><span class="p">)</span>
        <span class="n">ps</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">datafn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">perf_file</span><span class="p">:</span>
            <span class="n">perf_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">retval</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>

<div class="viewcode-block" id="random_series_fft"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.random_series_fft">[docs]</a><span class="k">def</span> <span class="nf">random_series_fft</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">matchto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">matchlength</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">keepall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a new series of data based on the provided power spectrum.</span>
<span class="sd">    If matchto is provided, the new series is adjusted for continuity </span>
<span class="sd">    to that data.</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * ps       : A power spectrum</span>
<span class="sd">    * matchto  : np.ndarray of preceding series. The mean of the first</span>
<span class="sd">      n (matchlength) values of the new series are matched</span>
<span class="sd">      to the mean of the last n values of this array.</span>
<span class="sd">    * matchlength : integer. The number of values to match </span>
<span class="sd">    * keepall  : Boolean. If true, will return the concatenation of the</span>
<span class="sd">      new array with the old. If False, will return only the</span>
<span class="sd">      new array.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    **Returns:**</span>
<span class="sd">    </span>
<span class="sd">    * a numpy ndarray of the time series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">SeedSequence</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
    <span class="n">newphi</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#newphi = np.random.uniform(low=-np.pi, high=+np.pi, size=ps.shape[0])</span>
    <span class="n">newspectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">newphi</span><span class="p">)</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">newspectrum</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="k">if</span> <span class="n">matchto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">adj0</span> <span class="o">=</span> <span class="n">matchto</span><span class="p">[</span><span class="o">-</span><span class="n">matchlength</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">adj1</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="n">matchlength</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">series</span> <span class="o">-</span> <span class="n">adj1</span> <span class="o">+</span> <span class="n">adj0</span>
        <span class="k">if</span> <span class="n">keepall</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">matchto</span><span class="p">,</span> <span class="n">series</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">series</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">series</span></div>
    
<div class="viewcode-block" id="matchseries"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.matchseries">[docs]</a><span class="k">def</span> <span class="nf">matchseries</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nmatch</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Matches series b with series a with the nmatch last samples of a and</span>
<span class="sd">    the nmatch first samples of b.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    * a        : 1D array the root of the series</span>
<span class="sd">    * b        : 1D array the tail of the series </span>
<span class="sd">    * nmatch   : integer  The number of samples used to match the mean </span>
<span class="sd">    </span>
<span class="sd">    **Returns** the concatenation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adj0</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="n">nmatch</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">adj1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:</span><span class="n">nmatch</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">adj1</span> <span class="o">+</span> <span class="n">adj0</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b2</span><span class="p">))</span></div>
        



<div class="viewcode-block" id="test_random_series"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.test_random_series">[docs]</a><span class="k">def</span> <span class="nf">test_random_series</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="c1"># Creating an initial time series with an interesting spectrum.</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">)</span>
    <span class="c1"># Extracting the power spectrum</span>
    
    <span class="n">psb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c1"># Looping to concatenate time series</span>
    <span class="n">bnew</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">bnew</span> <span class="o">=</span> <span class="n">random_series_fft</span><span class="p">(</span><span class="n">psb</span><span class="p">,</span> <span class="n">matchto</span><span class="o">=</span><span class="n">bnew</span><span class="p">,</span> <span class="n">keepall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bnew</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Random&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original and random time series&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time [arbitrary]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="c1">#print(np.fft.fftfreq(b.shape[0]))</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">freqsnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">bnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psb</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqsnew</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">bnew</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;New&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Power spectrum&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    
<span class="c1"># Function courtesy of Philippe Berio (OCA)</span>
<span class="c1"># this function returns a vector containing the timestaps of the GRAVITY measurements,</span>
<span class="c1"># an array containing the group delay and an array containing the phase delay [nFrame,nBase]</span>
<div class="viewcode-block" id="loadGRA4MAT"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.loadGRA4MAT">[docs]</a><span class="k">def</span> <span class="nf">loadGRA4MAT</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">acqstart</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO PCR ACQ START&#39;</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">acqstart</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mjd</span> <span class="o">+</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;IMAGING_DATA_FT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1E-6</span> <span class="o">/</span> <span class="mf">86400.</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">3600</span>
    <span class="c1">#gd = hdu[&#39;IMAGING_DATA_FT&#39;].data[&#39;GD&#39;] * 2.15 * 25 / (2. * np.pi)</span>
    <span class="c1">#pd = hdu[&#39;IMAGING_DATA_FT&#39;].data[&#39;PD&#39;] * 2.15 / (2. * np.pi)</span>
    <span class="n">coherence</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;IMAGING_DATA_FT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;COHERENCE&#39;</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">close</span>
    <span class="n">array_properties</span> <span class="o">=</span> <span class="n">get_header_bl_data</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nframeGRA4MAT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">coherence</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nChanGRA4MAT</span><span class="o">=</span><span class="mi">4</span>
    <span class="n">nBaseGRA4MAT</span><span class="o">=</span><span class="mi">6</span>
    <span class="n">gdc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframeGRA4MAT</span><span class="p">,</span><span class="n">nBaseGRA4MAT</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">pdc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframeGRA4MAT</span><span class="p">,</span><span class="n">nBaseGRA4MAT</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">foo1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nframeGRA4MAT</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="n">foo2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nframeGRA4MAT</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="n">lambGRA4MAT</span><span class="o">=</span><span class="p">[(</span><span class="mf">2.07767</span><span class="o">+</span><span class="mf">2.06029</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,(</span><span class="mf">2.17257</span><span class="o">+</span><span class="mf">2.15652</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,(</span><span class="mf">2.27180</span><span class="o">+</span><span class="mf">2.26070</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,(</span><span class="mf">2.35531</span><span class="o">+</span><span class="mf">2.35021</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span>
    <span class="n">factor1</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">lambGRA4MAT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">lambGRA4MAT</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="n">factor2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lambGRA4MAT</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iBase</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nBaseGRA4MAT</span><span class="p">):</span>
        <span class="n">foo1</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.</span>
        <span class="n">foo2</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.</span>
        <span class="k">for</span> <span class="n">iChan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nChanGRA4MAT</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iChan</span> <span class="o">&lt;</span> <span class="n">nChanGRA4MAT</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">foo1</span><span class="p">[:,]</span><span class="o">+=</span><span class="p">(</span><span class="n">coherence</span><span class="p">[:,</span><span class="mi">4</span><span class="o">+</span><span class="n">iBase</span><span class="o">+</span><span class="n">iChan</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="n">J</span><span class="o">*</span><span class="n">coherence</span><span class="p">[:,</span><span class="mi">10</span><span class="o">+</span><span class="n">iBase</span><span class="o">+</span><span class="n">iChan</span><span class="o">*</span><span class="mi">16</span><span class="p">])</span><span class="o">*</span>\
                         <span class="p">(</span><span class="n">coherence</span><span class="p">[:,</span><span class="mi">4</span><span class="o">+</span><span class="n">iBase</span><span class="o">+</span><span class="p">(</span><span class="n">iChan</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="n">J</span><span class="o">*</span><span class="n">coherence</span><span class="p">[:,</span><span class="mi">10</span><span class="o">+</span><span class="n">iBase</span><span class="o">+</span><span class="p">(</span><span class="n">iChan</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">])</span>
            <span class="n">foo2</span><span class="p">[:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">coherence</span><span class="p">[:,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">iBase</span> <span class="o">+</span> <span class="n">iChan</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">J</span> <span class="o">*</span> <span class="n">coherence</span><span class="p">[:,</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">iBase</span> <span class="o">+</span> <span class="n">iChan</span><span class="o">*</span><span class="mi">16</span><span class="p">])</span>
        
        <span class="n">pdc</span><span class="p">[:,</span> <span class="n">iBase</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">foo2</span><span class="p">[:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">foo2</span><span class="p">)))</span><span class="o">*</span><span class="n">factor2</span> <span class="c1">#2.15 / (2. * np.pi)</span>
        <span class="n">gdc</span><span class="p">[:,</span> <span class="n">iBase</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">foo1</span><span class="p">[:])</span><span class="o">*</span><span class="n">factor1</span> <span class="c1">#2.15 * 25./ (2. * np.pi)</span>
    <span class="c1">#return time,gd,pd, array_properties </span>
    <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">gdc</span><span class="p">,</span> <span class="n">pdc</span><span class="p">,</span> <span class="n">array_properties</span></div>
<div class="viewcode-block" id="get_header_bl_data"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.get_header_bl_data">[docs]</a><span class="k">def</span> <span class="nf">get_header_bl_data</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pulls the baseline infomation from the header </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting array information&quot;</span><span class="p">)</span>
    <span class="n">tnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tstas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stalocs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
        <span class="n">tnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HIERARCH ESO ISS CONF T</span><span class="si">%d</span><span class="s2">NAME&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">])</span>
        <span class="n">tstas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HIERARCH ESO ISS CONF STATION</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">])</span>
        <span class="n">stalocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HIERARCH ESO ISS CONF T</span><span class="si">%d</span><span class="s2">X&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;HIERARCH ESO ISS CONF T</span><span class="si">%d</span><span class="s2">Y&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">])))</span>
    <span class="n">stalocs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stalocs</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A_GRAVITY</span>
    <span class="n">blengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Baseline </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sta1</span><span class="p">,</span> <span class="n">sta2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tstas</span><span class="p">[</span><span class="n">t1</span><span class="p">],</span> <span class="n">tstas</span><span class="p">[</span><span class="n">t2</span><span class="p">])</span>
        <span class="n">locA</span> <span class="o">=</span> <span class="n">stalocs</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;From </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%.3f</span><span class="s2">, </span><span class="si">%.3f</span><span class="s2">) to </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%.3f</span><span class="s2">, </span><span class="si">%.3f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tnames</span><span class="p">[</span><span class="n">t1</span><span class="p">],</span> <span class="n">tstas</span><span class="p">[</span><span class="n">t1</span><span class="p">],</span> <span class="n">stalocs</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">stalocs</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">tnames</span><span class="p">[</span><span class="n">t2</span><span class="p">],</span> <span class="n">tstas</span><span class="p">[</span><span class="n">t2</span><span class="p">],</span> <span class="n">stalocs</span><span class="p">[</span><span class="n">t2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">stalocs</span><span class="p">[</span><span class="n">t2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">blength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">stalocs</span><span class="p">[</span><span class="n">t2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">stalocs</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">stalocs</span><span class="p">[</span><span class="n">t2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">stalocs</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">blengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blength</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Length </span><span class="si">%.1f</span><span class="s2"> m&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">blength</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="n">blengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">blengths</span><span class="p">)</span>
    <span class="n">array_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tnames&quot;</span><span class="p">:</span><span class="n">tnames</span><span class="p">,</span> <span class="s2">&quot;tstas&quot;</span><span class="p">:</span><span class="n">tstas</span><span class="p">,</span> <span class="s2">&quot;stalocs&quot;</span><span class="p">:</span><span class="n">stalocs</span><span class="p">,</span> <span class="s2">&quot;blengths&quot;</span><span class="p">:</span><span class="n">blengths</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">array_properties</span></div>
<span class="c1"># The baseline matrix for GRAVITY data</span>
<span class="n">A_GRAVITY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]])</span>


<div class="viewcode-block" id="get_star_params"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.get_star_params">[docs]</a><span class="k">def</span> <span class="nf">get_star_params</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showtable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries GAIA DR2 catalog for distance, radius and </span>
<span class="sd">    temperature of star:</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * star   : str   the name of the star</span>
<span class="sd">    * verbose: Whether to print the details found</span>
<span class="sd">    * showtable: Whether to show the table in list form</span>
<span class="sd">    </span>
<span class="sd">    ** returns:**</span>
<span class="sd">    * dist [pc]   : Distance</span>
<span class="sd">    * T    [K]    : Effective temperature</span>
<span class="sd">    * R    [Rsun] : Radius</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">astroquery.vizier</span> <span class="kn">import</span> <span class="n">Vizier</span>
    <span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
    <span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
    
    <span class="n">v</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_object</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GAIA&quot;</span><span class="p">])</span>
    <span class="n">v</span><span class="p">[</span><span class="s2">&quot;I/345/gaia2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s2">&quot;Gmag&quot;</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;I/345/gaia2&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Plx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">parsec</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">parallax</span><span class="p">())</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Teff&quot;</span><span class="p">]</span>
    <span class="n">Rad</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Rad&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">showtable</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
        <span class="n">display</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;I/345/gaia2&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dist = &quot;</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s2">&quot;[pc]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T = &quot;</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="s2">&quot;[K]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R = &quot;</span><span class="p">,</span> <span class="n">Rad</span><span class="p">,</span> <span class="s2">&quot;[R_sun]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rad</span></div>

<div class="viewcode-block" id="get_star_params_GAIA_JMMC"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.get_star_params_GAIA_JMMC">[docs]</a><span class="k">def</span> <span class="nf">get_star_params_GAIA_JMMC</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showtable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries GAIA DR2 catalog for distance, radius and </span>
<span class="sd">    temperature of star:</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * star   : str   the name of the star</span>
<span class="sd">    * verbose: Whether to print the details found</span>
<span class="sd">    * showtable: Whether to show the table in list form</span>
<span class="sd">    </span>
<span class="sd">    **returns:**</span>
<span class="sd">    </span>
<span class="sd">    * dist [pc]   : Distance</span>
<span class="sd">    * T    [K]    : Effective temperature</span>
<span class="sd">    * R    [Rsun] : Radius</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">astroquery.vizier</span> <span class="kn">import</span> <span class="n">Vizier</span>
    <span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
    <span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
    
    <span class="n">v</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_object</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GAIA&quot;</span><span class="p">])</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_object</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;JMMC&quot;</span><span class="p">])</span>
    <span class="n">catav</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;I/345/gaia2&quot;</span><span class="p">]</span>
    <span class="n">catav</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s2">&quot;Gmag&quot;</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">catav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Plx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">parsec</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">parallax</span><span class="p">())</span><span class="o">.</span><span class="n">value</span>
    <span class="k">try</span><span class="p">:</span> <span class="c1">#See if it is available in JMMC</span>
        <span class="n">cataj</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;II/346/jsdc2&quot;</span><span class="p">]</span>
        <span class="n">cataj</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s2">&quot;Vmag&quot;</span><span class="p">)</span>
        <span class="n">objj</span> <span class="o">=</span> <span class="n">cataj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">objj</span><span class="p">[</span><span class="s2">&quot;Teff&quot;</span><span class="p">]</span>
        <span class="n">Rad</span> <span class="o">=</span> <span class="n">objj</span><span class="p">[</span><span class="s2">&quot;UDDK&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dist</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Rsun</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="c1"># if it is not in JMMC</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cataj</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;II/300/jsdc&quot;</span><span class="p">]</span>
            <span class="n">cataj</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s2">&quot;Vmag&quot;</span><span class="p">)</span>
            <span class="n">objj</span> <span class="o">=</span> <span class="n">cataj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">objj</span><span class="p">[</span><span class="s2">&quot;Teff&quot;</span><span class="p">]</span>
            <span class="n">Rad</span> <span class="o">=</span> <span class="n">objj</span><span class="p">[</span><span class="s2">&quot;UDDK&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dist</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Rsun</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Teff&quot;</span><span class="p">]</span>
            <span class="n">Rad</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Rad&quot;</span><span class="p">]</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find the entry in JSDC catalog&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">showtable</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
        <span class="n">display</span><span class="p">(</span><span class="n">catav</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">cataj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dist = &quot;</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s2">&quot;[pc]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T = &quot;</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="s2">&quot;[K]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R = &quot;</span><span class="p">,</span> <span class="n">Rad</span><span class="p">,</span> <span class="s2">&quot;[R_sun]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rad</span></div>

<div class="viewcode-block" id="update_star_params"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.update_star_params">[docs]</a><span class="k">def</span> <span class="nf">update_star_params</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">)</span>
    <span class="n">dist</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rad</span> <span class="o">=</span> <span class="n">get_star_params_GAIA_JMMC</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dist set to &quot;</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s2">&quot;[pc]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T set to &quot;</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="s2">&quot;[K]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R set to &quot;</span><span class="p">,</span> <span class="n">Rad</span><span class="p">,</span> <span class="s2">&quot;[R_sun]&quot;</span><span class="p">)</span>
    
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;star_distance&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;star_temperature&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">T</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;star_radius&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">Rad</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="find_best_night"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.find_best_night">[docs]</a><span class="k">def</span> <span class="nf">find_best_night</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">showplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * obs : Observatory object</span>
<span class="sd">    * showplot : Whether to show a plot of the max elevation </span>
<span class="sd">    * duration   [h] : duration of the observing run</span>
<span class="sd">    </span>
<span class="sd">    **Returns:**</span>
<span class="sd">    </span>
<span class="sd">    * if duration is None (default) : ``besttime`` an ``astropy.Time`` object</span>
<span class="sd">    * else : ``(Tstart, Tend)`` Start and end of the observing run</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">astropy.units</span>
    <span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2021-01-01T03:00:00&quot;</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">dt</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">365</span><span class="p">)]</span>
    <span class="n">poslist</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
    <span class="n">poslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elev_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poslist</span><span class="o">.</span><span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">highest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">elev_vec</span><span class="p">)</span>
    <span class="n">besttime</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">highest_index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">showplot</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">poslist</span><span class="o">.</span><span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Day of the year&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Elevation at midnight [deg]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best time:&quot;</span><span class="p">,</span> <span class="n">besttime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">besttime</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Tstart</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">besttime</span><span class="p">)</span> <span class="o">-</span> <span class="n">TimeDelta</span><span class="p">((</span><span class="n">duration</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="n">Tend</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">besttime</span><span class="p">)</span> <span class="o">+</span> <span class="n">TimeDelta</span><span class="p">((</span><span class="n">duration</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Tstart</span><span class="p">,</span> <span class="n">Tend</span></div>
<div class="viewcode-block" id="update_observing_night"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.update_observing_night">[docs]</a><span class="k">def</span> <span class="nf">update_observing_night</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span>  <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">target_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Parameters**</span>
<span class="sd">    </span>
<span class="sd">    * config  : The parsed config file to modify</span>
<span class="sd">    * time : [fits format] (if None, will optimize for elevation)</span>
<span class="sd">    * duration : [h] *Default*: 6.h</span>
<span class="sd">    * verbose : Whether to print some of the intermediate results</span>
<span class="sd">    * target_coords : Coordinates of the object of interst.</span>
<span class="sd">    </span>
<span class="sd">        - **None** *Default*: Uses the target in the config file</span>
<span class="sd">        - ``astropy.SkyCoords`` object.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scifysim.observatory</span> <span class="kn">import</span> <span class="n">observatory</span>
    <span class="kn">from</span> <span class="nn">astroplan</span> <span class="kn">import</span> <span class="n">FixedTarget</span>
    <span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">observatory</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tarname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">FixedTarget</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">tarname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tarname</span> <span class="o">=</span> <span class="s2">&quot;from coords&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">FixedTarget</span><span class="p">(</span><span class="n">target_coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span> <span class="o">=</span> <span class="n">find_best_night</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">showplot</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">value</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">tend</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span> <span class="p">:</span> 
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">)</span>
    <span class="n">dist</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rad</span> <span class="o">=</span> <span class="n">get_star_params</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sequence start set to &quot;</span><span class="p">,</span> <span class="n">tstart</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sequence end set to &quot;</span><span class="p">,</span> <span class="n">tend</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_start&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">tstart</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_end&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">tend</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="get_location"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.get_location">[docs]</a><span class="k">def</span> <span class="nf">get_location</span><span class="p">(</span><span class="n">simple_map</span><span class="p">,</span> <span class="n">map_extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">search_function</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;polar&quot;</span><span class="p">):</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">simple_map</span><span class="p">),</span> <span class="n">simple_map</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simple_map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">map_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">map_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">map_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">simple_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="n">simple_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">simple_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">simple_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="c1"># order?</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">frac</span><span class="o">*</span><span class="n">gain</span><span class="o">+</span><span class="n">offset</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cartesian:&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
    <span class="n">cpform</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cpform</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">cpform</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;r, theta&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;polar&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">theta</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">pos</span></div>
    
<div class="viewcode-block" id="mag2sig"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.mag2sig">[docs]</a><span class="k">def</span> <span class="nf">mag2sig</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="n">dit</span><span class="p">,</span> <span class="n">lead_transmission</span><span class="p">,</span><span class="n">context</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span> <span class="n">ds_sr</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtains the coefficients including object magnitude, detector integration time,</span>
<span class="sd">    transmission, spectral channels, pixel solid angle, and quantum efficiency (default: 1.).</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * mag     : Magnitude of object (Vega)</span>
<span class="sd">    * dit     : detector integration time [s]</span>
<span class="sd">    * lead_transmission : The transmission of the leading element (often sky) of the </span>
<span class="sd">      transmission-emission chain</span>
<span class="sd">    * context : The spectral context of the instrument (defining the vega magnitudes)</span>
<span class="sd">    * eta     : (default=1.) The quantum efficiency of the detector</span>
<span class="sd">    * spectrum : The type of spectrum of the object defaults to flat as opposed to the </span>
<span class="sd">      temperature of Vega.</span>
<span class="sd">    * ds_sr   : When working with a map the solid angle of a pixel [sr]</span>
<span class="sd">      Can be found in `simulator.vigneting_map.ds_sr` after maps have been computed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">aspectrum</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">sflux_from_vegamag</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span> <span class="c1">#asim.src.planet.ss.flatten()</span>
    <span class="k">if</span> <span class="n">spectrum</span> <span class="o">==</span> <span class="s2">&quot;flat&quot;</span><span class="p">:</span>
        <span class="n">aspectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aspectrum</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">aspectrum</span><span class="p">)</span>
    <span class="n">acoeff</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">(</span><span class="n">dit</span><span class="p">,</span> <span class="n">lead_transmission</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>
                    <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">ds_sr</span><span class="o">=</span><span class="n">ds_sr</span><span class="p">)</span>
    <span class="n">full_coeff</span> <span class="o">=</span> <span class="n">aspectrum</span><span class="o">*</span><span class="n">acoeff</span>
    <span class="k">return</span> <span class="n">full_coeff</span></div>

<div class="viewcode-block" id="coeff"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.coeff">[docs]</a><span class="k">def</span> <span class="nf">coeff</span><span class="p">(</span><span class="n">dit</span><span class="p">,</span> <span class="n">lead_transmission</span><span class="p">,</span><span class="n">context</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span> <span class="n">ds_sr</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtains the coefficients including detector integration time,</span>
<span class="sd">    transmission, spectral channels, pixel solid angle, and quantum efficiency (default: 1.).</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * dit     : detector integration time [s]</span>
<span class="sd">    * lead_transmission : The transmission of the leading element (often sky) of the </span>
<span class="sd">      transmission-emission chain</span>
<span class="sd">    * context : The spectral context of the instrument (defining the vega magnitudes)</span>
<span class="sd">    * eta     : (default=1.) The quantum efficiency of the detector</span>
<span class="sd">    * spectrum : The type of spectrum of the object defaults to flat as opposed to the </span>
<span class="sd">      temperature of Vega.</span>
<span class="sd">    * ds_sr   : When working with a map the solid angle of a pixel [sr]</span>
<span class="sd">      Can be found in `simulator.vigneting_map.ds_sr` after maps have been computed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acoeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">ds_sr</span><span class="p">)</span> <span class="o">*</span>\
                  <span class="n">dit</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span>\
                  <span class="n">lead_transmission</span><span class="o">.</span><span class="n">get_downstream_transmission</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">avega</span><span class="o">.</span><span class="n">lambda_science_range</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">acoeff</span></div>


<div class="viewcode-block" id="extract_diffobs_map"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.extract_diffobs_map">[docs]</a><span class="k">def</span> <span class="nf">extract_diffobs_map</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="n">simulator</span><span class="p">,</span> <span class="n">dit</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">postprod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Here in photons per dit (default=1s)</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * maps     : Transmission maps for 1 ph/s/m2 </span>
<span class="sd">                        at the entrance of atmo</span>
<span class="sd">    * simulator : a sumulator object (see comments below)</span>
<span class="sd">    * dit      : Detector integration time [s]</span>
<span class="sd">    * mag      : The magnitude of a source on the map</span>
<span class="sd">    * postprod : A post-processing (whitening matrix)</span>
<span class="sd">    * eta      : The quantum efficiency of the detector</span>
<span class="sd">    * K        : A matrix to extract the differential</span>
<span class="sd">                observable quantities (kernel matrix).</span>
<span class="sd">                By default, the matrix is obtained from </span>
<span class="sd">                simulator.combiner.K</span>
<span class="sd">    </span>
<span class="sd">    Simulator object is used for</span>
<span class="sd">    </span>
<span class="sd">    * The head transmission (simulator.src.sky)</span>
<span class="sd">    * The solid angle of the pisel</span>
<span class="sd">    * The spectral context (for the spectral channels)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">maps</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">nt</span><span class="p">,</span> <span class="n">nwl</span><span class="p">,</span> <span class="n">nout</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">maps</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">nt</span><span class="p">,</span> <span class="n">nwl</span><span class="p">,</span> <span class="n">nout</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;single_datacube&quot;</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Shape not expected&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">K</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">K</span>
        
    <span class="n">acoeff</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">(</span><span class="n">dit</span><span class="p">,</span> <span class="n">simulator</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">sky</span><span class="p">,</span>
                               <span class="n">simulator</span><span class="o">.</span><span class="n">context</span><span class="p">,</span><span class="n">ds_sr</span><span class="o">=</span><span class="n">simulator</span><span class="o">.</span><span class="n">vigneting_map</span><span class="o">.</span><span class="n">ds_sr</span><span class="p">,</span>
                               <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">)</span>
    
    
<span class="c1">#    coeff = (1/(asim.vigneting_map.ds_sr) *\</span>
<span class="c1">#                  dit * eta *\</span>
<span class="c1">#                  diffuse[0].get_downstream_transmission(asim.lambda_science_range))</span>
    <span class="n">ymap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">awl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwl</span><span class="p">):</span>
            <span class="n">ay</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="n">at</span><span class="p">,</span><span class="n">awl</span><span class="p">,:,:,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nout</span><span class="p">,</span><span class="n">ny</span><span class="o">*</span><span class="n">nx</span><span class="p">))</span>
            <span class="n">ay</span> <span class="o">=</span> <span class="n">ay</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">ymap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ay</span><span class="p">)</span>
    <span class="n">ymap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ymap</span><span class="p">)</span>
    <span class="n">ymap</span> <span class="o">=</span> <span class="n">ymap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nwl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="n">ymap</span> <span class="o">=</span> <span class="n">ymap</span><span class="o">*</span><span class="n">acoeff</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">postprod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ymap</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">ymap</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]):</span>
            <span class="n">ymap</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>  <span class="n">postprod</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ymap</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ymap</span></div>

<div class="viewcode-block" id="test_maps"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.test_maps">[docs]</a><span class="k">def</span> <span class="nf">test_maps</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="s2">&quot;local_config/default_R200&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;GJ 86 A&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Testing and comparing the 2 approaches to build transmission maps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">build_all_maps_dask</span><span class="p">(</span><span class="n">mapcrop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">mapres</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">persist_maps_to_disk</span><span class="p">()</span>
    <span class="n">mapdask</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">maps</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">build_all_maps</span><span class="p">(</span><span class="n">mapcrop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">mapres</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">mapnp</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">maps</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;They are the same map: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mapnp</span><span class="p">,</span> <span class="n">mapdask</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mapnp</span><span class="p">,</span> <span class="n">mapdask</span></div>


<div class="viewcode-block" id="trois"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.trois">[docs]</a><span class="k">def</span> <span class="nf">trois</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="n">xrange</span> <span class="o">=</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span>
    <span class="n">yrange</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xrange</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">*</span><span class="n">yrange</span> <span class="o">+</span> <span class="n">ymin</span>
    <span class="k">return</span> <span class="n">y</span></div>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">WARNING-matplotlib.axes._axes- *c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="eval_perf"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.eval_perf">[docs]</a><span class="k">def</span> <span class="nf">eval_perf</span><span class="p">(</span><span class="n">afile</span><span class="p">,</span><span class="n">t_exp</span><span class="p">,</span><span class="n">n_frames</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
               <span class="n">thetarget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_params</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">instrumental_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">crop</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">target_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">compensate_chromatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">modificators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">plotall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">use_tqdm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the noise profile for a given parameter file.</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    - afile      : Config file </span>
<span class="sd">    - t_exp      : Exposure time</span>
<span class="sd">    - n_frames   : The number of frames for MC simulation</span>
<span class="sd">      to evaluate the instrumental noise</span>
<span class="sd">    - instrumental_errors : Bool. Whether to include instrumental</span>
<span class="sd">      errors</span>
<span class="sd">    - seed       : seed to pass when generating the </span>
<span class="sd">      time series of instrumental errors</span>
<span class="sd">    - crop       : factor to pass to the injector</span>
<span class="sd">    - target_coords : Coordinates of the target </span>
<span class="sd">      default:None : finds the target from catalog</span>
<span class="sd">    - compensate_chromatic : Bool Whether to run the optimization</span>
<span class="sd">      of the actuators to compensate for chromaticity</span>
<span class="sd">      in the combiner</span>
<span class="sd">    - plotall    : Whether to plot a bunch of charts</span>
<span class="sd">    - use_tqdm   : Whether tqdm should be used at the step of the</span>
<span class="sd">      MC simulations. (use false for parameter exploration)</span>
<span class="sd">                </span>
<span class="sd">    **Returns:**</span>
<span class="sd">    </span>
<span class="sd">    - asim       : The simulator object</span>
<span class="sd">    - prof       : The noise profile object</span>
<span class="sd">    - characteristics : A dictionary containing a collection of</span>
<span class="sd">      performance statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scifysim</span> <span class="k">as</span> <span class="nn">sf</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">sqrtm</span>
    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
    
<span class="c1">#    asim = prepare_all(afile, thetarget=thetarget, update_params=update_params,</span>
<span class="c1">#               instrumental_errors=instrumental_errors, seed=seed,</span>
<span class="c1">#               crop=crop, target_coords=target_coords, modificators=modificators,</span>
<span class="c1">#               compensate_chromatic=compensate_chromatic)</span>
<span class="c1">#    diffuse = [asim.src.sky, asim.src.UT, asim.src.warm_optics, asim.src.combiner, asim.src.cold_optics]</span>
<span class="c1">#    #asim.point(asim.sequence[3], asim.target)</span>
<span class="c1">#    #asim.combiner.chromatic_matrix(asim.lambda_science_range)</span>
<span class="c1">#    integ = asim.make_metrologic_exposure(asim.src.planet, asim.src.star, diffuse,</span>
<span class="c1">#                                          texp=t_exp)</span>
<span class="c1">#    integ.prepare_t_exp_base()</span>
<span class="c1">#    #consolidate_metrologic(integ)</span>
<span class="c1">#    integ.consolidate_metrologic()</span>
    
    
    <span class="c1">###############</span>
    <span class="c1">#skipping</span>
    <span class="c1">###############</span>
    <span class="n">asim</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">prepare_all</span><span class="p">(</span><span class="n">afile</span><span class="p">,</span> <span class="n">thetarget</span><span class="o">=</span><span class="n">thetarget</span><span class="p">,</span> <span class="n">update_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">instrumental_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">modificators</span><span class="o">=</span><span class="n">modificators</span><span class="p">)</span>
    <span class="n">diffuse</span> <span class="o">=</span> <span class="p">[</span><span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">sky</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">UT</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">warm_optics</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">combiner</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">cold_optics</span><span class="p">]</span>

    <span class="n">asim</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">chromatic_matrix</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">lambda_science_range</span><span class="p">)</span>
    <span class="c1">#asim.integrator = integ</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">spectral_context</span><span class="p">(</span><span class="s2">&quot;local_config/vega_R200.ini&quot;</span><span class="p">)</span>
    <span class="n">integ</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">make_metrologic_exposure</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">planet</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="n">diffuse</span><span class="p">,</span>
                                          <span class="n">texp</span><span class="o">=</span><span class="n">t_exp</span><span class="p">)</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integ</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting loop&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dit</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">mynpix</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">reveta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">integ</span><span class="o">.</span><span class="n">eta</span>
    <span class="n">full_record</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">diffuse</span> <span class="o">=</span> <span class="p">[</span><span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">sky</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">UT</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">warm_optics</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">combiner</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">cold_optics</span><span class="p">]</span>
    <span class="n">screen_age</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">datacube</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dit_intensity</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">starlights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">planetlights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coupling_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">compling_stds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">phase_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">phase_stds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">injphase_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">injphase_stds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">use_tqdm</span><span class="p">:</span>
        <span class="n">theit</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theit</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">theit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">screen_age</span><span class="o">&gt;=</span><span class="mf">20.</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;generating screen&quot;</span><span class="p">)</span>
            <span class="n">asim</span><span class="o">.</span><span class="n">injector</span><span class="o">.</span><span class="n">update_screens</span><span class="p">()</span>
            <span class="n">screen_age</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">integ</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">make_exposure</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">planet</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="n">diffuse</span><span class="p">,</span>
                                    <span class="n">texp</span><span class="o">=</span><span class="n">dit</span><span class="p">,</span>
                                    <span class="n">monitor_phase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">spectro</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">datacube</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">get_total</span><span class="p">(</span><span class="n">spectrograph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">t_exp</span><span class="o">=</span><span class="n">dit</span><span class="p">,</span>
                                        <span class="n">n_pixsplit</span><span class="o">=</span><span class="n">mynpix</span><span class="p">))</span>
        <span class="n">dit_intensity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reveta</span> <span class="o">*</span> <span class="n">integ</span><span class="o">.</span><span class="n">forensics</span><span class="p">[</span><span class="s2">&quot;Expectancy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">full_record</span><span class="p">:</span>
            <span class="n">starlights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">starlight</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">planetlights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">planetlight</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">coupling_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">inj_amp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">compling_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">inj_amp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            <span class="n">phase_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">ft_phase</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">phase_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">ft_phase</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            <span class="n">injphase_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">inj_phase</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">injphase_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">inj_phase</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            
        <span class="n">integ</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span> <span class="c1"># This can be removed after new kernel start</span>
        <span class="n">screen_age</span> <span class="o">+=</span> <span class="n">dit</span>
    <span class="n">datacube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datacube</span><span class="p">)</span>
    <span class="n">dit_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dit_intensity</span><span class="p">)</span>
    <span class="n">starlights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">starlights</span><span class="p">)</span>
    <span class="n">planetlights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">planetlights</span><span class="p">)</span>
    <span class="n">statics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">static</span><span class="p">)</span>
    
    <span class="n">coupling_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coupling_means</span><span class="p">)</span>
    <span class="n">coupling_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">compling_stds</span><span class="p">)</span>
    <span class="n">phase_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_means</span><span class="p">)</span>
    <span class="n">phase_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_stds</span><span class="p">)</span>
    <span class="n">injphase_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">injphase_means</span><span class="p">)</span>
    <span class="n">injphase_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">injphase_stds</span><span class="p">)</span>
    
    <span class="c1">###################################</span>
    <span class="n">integ</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">integ</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">make_exposure</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">planet</span><span class="p">,</span> <span class="n">asim</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="n">diffuse</span><span class="p">,</span>
                                    <span class="n">texp</span><span class="o">=</span><span class="n">dit</span><span class="p">,</span>
                                    <span class="n">monitor_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">spectro</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">integ</span><span class="o">.</span><span class="n">get_total</span><span class="p">(</span><span class="n">spectrograph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t_exp</span><span class="o">=</span><span class="n">dit</span><span class="p">,</span> <span class="n">n_pixsplit</span><span class="o">=</span><span class="n">mynpix</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;datacube shape: </span><span class="si">{</span><span class="n">datacube</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dit = </span><span class="si">{</span><span class="n">dit</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
    <span class="n">brigh_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">forensics</span><span class="p">[</span><span class="s2">&quot;Expectancy&quot;</span><span class="p">][:,:,</span><span class="n">asim</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">bright</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">dark_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">integ</span><span class="o">.</span><span class="n">forensics</span><span class="p">[</span><span class="s2">&quot;Expectancy&quot;</span><span class="p">][:,:,</span><span class="n">asim</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">dark</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">longest_exp_bright</span> <span class="o">=</span> <span class="mi">65000</span> <span class="o">/</span> <span class="p">(</span><span class="n">brigh_max</span><span class="o">/</span><span class="n">dit</span><span class="p">)</span>
    <span class="n">longest_exp_dark</span> <span class="o">=</span> <span class="mi">65000</span> <span class="o">/</span> <span class="p">(</span><span class="n">dark_max</span><span class="o">/</span><span class="n">dit</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bright limit: </span><span class="si">{</span><span class="n">longest_exp_bright</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s</span><span class="se">\n</span><span class="s2"> Dark limit: </span><span class="si">{</span><span class="n">longest_exp_dark</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
    <span class="n">data_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">datacube</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">diff_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">datacube</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">datacube</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">integ</span><span class="o">.</span><span class="n">static</span> <span class="o">=</span> <span class="n">asim</span><span class="o">.</span><span class="n">computed_static</span>
    <span class="n">integ</span><span class="o">.</span><span class="n">mean_starlight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">starlights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">integ</span><span class="o">.</span><span class="n">mean_planetlight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">planetlights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">integ</span><span class="o">.</span><span class="n">mean_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dit_intensity</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">################ # Diff null distribution</span>
    <span class="n">diffdata</span> <span class="o">=</span> <span class="n">datacube</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">datacube</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shapirops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shapiro</span><span class="p">(</span><span class="n">diffdata</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span> \
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">lambda_science_range</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    
    <span class="n">historgrams</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gauss_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">awl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">lambda_science_range</span><span class="p">[:]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shapiro p = </span><span class="si">{</span><span class="n">shapirops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shapiro p-value: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">format_float_scientific</span><span class="p">(</span><span class="n">shapirops</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diffdata</span><span class="p">[:,</span><span class="n">i</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diffdata</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">myhist</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">diffdata</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bincenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nsamples</span> <span class="o">=</span> <span class="n">diffdata</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">histerror_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nsamples</span><span class="o">*</span><span class="n">myhist</span><span class="p">)</span><span class="o">/</span><span class="n">nsamples</span>
        <span class="c1"># We further replace the 0 values (empty bins) with the maximum standard deviation.</span>
        <span class="n">histerror</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">histerror_base</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">,</span> <span class="n">histerror_base</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">histerror_base</span><span class="p">))</span>
        <span class="n">parameters</span><span class="p">,</span> <span class="n">covariance</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">Gauss</span><span class="p">,</span> <span class="n">bincenters</span><span class="p">,</span> <span class="n">myhist</span><span class="p">,</span>
                                           <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">histerror</span><span class="p">)</span>
        <span class="n">parameters_cauchy</span><span class="p">,</span> <span class="n">covariance_cauchy</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">Cauchy</span><span class="p">,</span> <span class="n">bincenters</span><span class="p">,</span> <span class="n">myhist</span><span class="p">,</span>
                                           <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">histerror</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plotall</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">parameters_cauchy</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">myhist</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;diff-null (MC)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaussian fit&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">Cauchy</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">parameters_cauchy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters_cauchy</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cauchy fit&quot;</span><span class="p">)</span>

            <span class="c1">#plt.yscale(&quot;log&quot;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wavelength: $\lambda = </span><span class="si">{</span><span class="n">awl</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">$ m&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Differential observable value [e-]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diffdata</span><span class="p">[:,</span><span class="n">i</span><span class="p">]),</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">myhist</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MC_sim (diff-null)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaussian fit&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">Cauchy</span><span class="p">(</span><span class="n">bincenters</span><span class="p">,</span> <span class="n">parameters_cauchy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters_cauchy</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cauchy fit&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wavelength: $\lambda = </span><span class="si">{</span><span class="n">awl</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">$ m&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Differential observable value [e-]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diffdata</span><span class="p">[:,</span><span class="n">i</span><span class="p">]),</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/tmp/plots/gaussian_fit_</span><span class="si">{</span><span class="mf">1e6</span><span class="o">*</span><span class="n">awl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">microns.pdf&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="c1">####################</span>
    <span class="c1"># More elipsis</span>
    <span class="c1">#####################</span>
    
    <span class="kn">from</span> <span class="nn">kernuller</span> <span class="kn">import</span> <span class="n">pairwise_kernel</span>
    <span class="n">ak</span> <span class="o">=</span> <span class="n">pairwise_kernel</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">myk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">ak</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))))</span>
    <span class="n">asim</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">myk</span>


    <span class="n">diffobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij, mkj-&gt;mk&quot;</span><span class="p">,</span><span class="n">asim</span><span class="o">.</span><span class="n">combiner</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">dit_intensity</span><span class="p">)</span>
    <span class="n">diff_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diffobs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">prof</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">noiseprofile</span><span class="p">(</span><span class="n">integ</span><span class="p">,</span> <span class="n">asim</span><span class="p">,</span> <span class="n">diffobs</span><span class="p">,</span> <span class="n">n_pixsplit</span><span class="o">=</span><span class="n">mynpix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plotall</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">plot_noise_sources</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">lambda_science_range</span><span class="p">,</span> <span class="n">dit</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">ymin</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;xx-small&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;/tmp/plots/noises.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="n">characteristics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean_coupling&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coupling_means</span><span class="p">),</span>
                  <span class="s2">&quot;inter-frame_coupling_std&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">coupling_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
                  <span class="s2">&quot;intra-frame_coupling_std&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coupling_stds</span><span class="p">),</span>
                  <span class="s2">&quot;inter-frame_ft_phase&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">phase_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
                  <span class="s2">&quot;intra-frame_ft_phase&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">phase_stds</span><span class="p">),</span>
                  <span class="s2">&quot;inter-frame_inj_phase&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">injphase_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
                  <span class="s2">&quot;shapirops&quot;</span><span class="p">:</span><span class="n">shapirops</span><span class="p">,</span>
                  <span class="s2">&quot;fit_params&quot;</span><span class="p">:</span><span class="n">parameters</span>
                  <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">asim</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">characteristics</span></div>

<div class="viewcode-block" id="produce_maps"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.produce_maps">[docs]</a><span class="k">def</span> <span class="nf">produce_maps</span><span class="p">(</span><span class="n">asim</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">adit</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                <span class="n">mypfa</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">mypdet</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">base_name</span><span class="o">=</span><span class="s2">&quot;/tmp/R200_twinmaps_&quot;</span><span class="p">,</span>
                <span class="n">total_time</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span>
                <span class="n">starmags</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span><span class="mf">10.</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                <span class="n">decs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                <span class="n">mapcrop</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mapres</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility macro that packages the production of multiple sensitivity</span>
<span class="sd">    maps for a given director object and noise profile</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    - asim     : Simulator director object</span>
<span class="sd">    - prof     : Noise profile</span>
<span class="sd">    </span>
<span class="sd">    **Returns:**</span>
<span class="sd">    </span>
<span class="sd">    - metamap   : T</span>
<span class="sd">    - themap    : The energy detector map in magnitude</span>
<span class="sd">    - theNPmap  : The Neyman-Pearson detector map in magnitude</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="kn">import</span> <span class="nn">gc</span>
    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
    <span class="kn">import</span> <span class="nn">scifysim</span> <span class="k">as</span> <span class="nn">sf</span>
    
    <span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">sqrtm</span>
    <span class="n">old_target</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    
    <span class="kn">from</span> <span class="nn">einops</span> <span class="kn">import</span> <span class="n">rearrange</span>
    <span class="n">rfx</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">rfx_N</span> <span class="o">=</span> <span class="mf">22.</span> <span class="c1"># For NP test, the ref mag needs to be relatively high</span>
    <span class="n">nslots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
    <span class="n">ndits</span> <span class="o">=</span> <span class="n">total_time</span><span class="o">/</span><span class="n">adit</span><span class="o">/</span><span class="n">nslots</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">old_target</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span> <span class="c1">#asim.target.ra.adeg</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DIT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">adit</span><span class="p">,</span> <span class="s2">&quot;Detector integration time [s]&quot;</span><span class="p">),</span>
               <span class="s2">&quot;PFA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">mypfa</span><span class="p">,</span> <span class="s2">&quot;False alarm rate&quot;</span><span class="p">),</span>
               <span class="s2">&quot;PDET&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">mypdet</span><span class="p">,</span> <span class="s2">&quot;Detection probability&quot;</span><span class="p">),</span>
               <span class="s2">&quot;INTEGRATION&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_time</span><span class="p">,</span> <span class="s2">&quot;Total integration time on target [s]&quot;</span><span class="p">),</span>
               <span class="s2">&quot;CALIBRATION&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IDEAL&quot;</span><span class="p">,</span> <span class="s2">&quot;Currently only IDEAL. Biases are assumed perfectly corrected&quot;</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">adec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">decs</span><span class="p">[:])):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======= Declination </span><span class="si">{</span><span class="n">adec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">adec</span><span class="p">,</span> <span class="s2">&quot;The declination for which the object map was computed&quot;</span><span class="p">)</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;coords&quot;</span><span class="p">)</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">adec</span><span class="p">))</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">prepare_observatory</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">asim</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">asim</span><span class="o">.</span><span class="n">build_all_maps</span><span class="p">(</span><span class="n">mapres</span><span class="o">=</span><span class="n">mapres</span><span class="p">,</span> <span class="n">mapcrop</span><span class="o">=</span><span class="n">mapcrop</span><span class="p">)</span>

        <span class="n">themaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">theNPmaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">starmag</span> <span class="ow">in</span> <span class="n">starmags</span><span class="p">:</span>
            <span class="n">amat</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ndits</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">diff_noise_floor_dit</span><span class="p">(</span><span class="n">starmag</span><span class="p">,</span> <span class="n">adit</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">wmat</span> <span class="o">=</span> <span class="n">sqrtm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">amat</span><span class="p">))</span>
            <span class="n">whitenings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">sequence</span><span class="p">))[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">wmat</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:]</span>
            <span class="n">aymap</span> <span class="o">=</span> <span class="n">extract_diffobs_map</span><span class="p">(</span><span class="n">asim</span><span class="o">.</span><span class="n">maps</span><span class="p">,</span> <span class="n">asim</span><span class="p">,</span>
                                        <span class="n">postprod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">asim</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span>\
                                    <span class="n">asim</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">sflux_from_vegamag</span><span class="p">(</span><span class="n">rfx_N</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
            <span class="c1">#rearrange(aymap, &quot;a b c d e -&gt; a (b c) d e&quot;)</span>
            <span class="n">mgs</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span> <span class="n">Tes</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">get_sensitivity_Te</span><span class="p">(</span><span class="n">aymap</span><span class="p">,</span> <span class="n">postproc_mat</span><span class="o">=</span><span class="n">whitenings</span><span class="p">,</span>
                                                         <span class="n">ref_mag</span><span class="o">=</span><span class="n">rfx_N</span><span class="p">,</span> <span class="n">pdet</span><span class="o">=</span><span class="n">mypdet</span><span class="p">,</span>
                                                         <span class="n">pfa</span><span class="o">=</span><span class="n">mypfa</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="p">)</span>

            <span class="n">mags_NP</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">get_sensitivity_Tnp</span><span class="p">(</span><span class="n">aymap</span><span class="p">,</span> <span class="n">postproc_mat</span><span class="o">=</span><span class="n">whitenings</span><span class="p">,</span>
                                                      <span class="n">pfa</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">pdet</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">ref_mag</span><span class="o">=</span><span class="n">rfx_N</span><span class="p">,</span>
                                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">themaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mgs</span><span class="p">)</span>
            <span class="n">theNPmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mags_NP</span><span class="p">)</span>
        <span class="n">themaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">themaps</span><span class="p">)</span>
        <span class="n">theNPmaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theNPmaps</span><span class="p">)</span>
        <span class="n">ameta</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">map_manager</span><span class="o">.</span><span class="n">map_meta</span><span class="p">(</span><span class="n">asim</span><span class="p">,</span> <span class="n">starmags</span><span class="p">,</span> 
                                        <span class="n">mgs</span><span class="o">=</span><span class="n">themaps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                                        <span class="n">mgs_TNP</span><span class="o">=</span><span class="n">theNPmaps</span><span class="p">,</span>
                                        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">ameta</span><span class="o">.</span><span class="n">to_fits</span><span class="p">(</span><span class="n">base_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_dec_</span><span class="si">%.1f</span><span class="s2">.fits&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ameta</span><span class="o">.</span><span class="n">input_order</span><span class="p">,</span> <span class="n">adec</span><span class="p">))</span>
        <span class="n">aplot</span> <span class="o">=</span> <span class="n">ameta</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span><span class="mf">4.</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">)</span>
        <span class="n">aplot</span> <span class="o">=</span> <span class="n">ameta</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span><span class="mf">4.</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
        <span class="c1">#plt.title(&quot;Dec: %.0f&quot;%adec)</span>
        <span class="c1">#plt.show()</span>
        <span class="k">del</span> <span class="n">asim</span><span class="o">.</span><span class="n">maps</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">ameta</span><span class="p">,</span> <span class="n">themaps</span><span class="p">,</span> <span class="n">theNPmaps</span></div>
    

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">shapiro</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">cauchy</span>

<div class="viewcode-block" id="Gauss"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.Gauss">[docs]</a><span class="k">def</span> <span class="nf">Gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span></div>
<div class="viewcode-block" id="Cauchy"><a class="viewcode-back" href="../../scifysim.utilities.html#scifysim.utilities.Cauchy">[docs]</a><span class="k">def</span> <span class="nf">Cauchy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">cauchy</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Romain Laugier.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>