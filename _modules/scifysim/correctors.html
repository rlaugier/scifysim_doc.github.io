<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scifysim.correctors &mdash; SCIFYsim dev-0.2.3 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=88750a54"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SCIFYsim
          </a>
              <div class="version">
                dev-0.2.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup_guide.html">Installing SCIFYsim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../need_to_know.html">What you need to know</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipe.html">Documentation recipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">scifysim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.analysis.html">scifysim.analysis module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.combiner.html">scifysim.combiner module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.combiners.html">scifysim.combiners module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.confconverter.html">scifysim.confconverter module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.correctors.html">scifysim.correctors module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.director.html">scifysim.director module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.injection.html">scifysim.injection module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.map_manager.html">scifysim.map_manager module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.mol_dens.html">scifysim.mol_dens module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.n_air.html">scifysim.n_air module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.observatory.html">scifysim.observatory module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.parsefile.html">scifysim.parsefile module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.plot_tools.html">scifysim.plot_tools module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.sources.html">scifysim.sources module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.spectrograph.html">scifysim.spectrograph module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scifysim.utilities.html">scifysim.utilities module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SCIFYsim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">scifysim.correctors</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scifysim.correctors</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#from sympy.functions.elementary.piecewise import Piecewise</span>
<span class="c1">#from kernuller import mas2rad, rad2mas</span>
<span class="c1">#from . import utilities</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">n_air</span>
<span class="c1">#from astropy import constants</span>
<span class="c1">#from astropy import units</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">interp</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logit</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="c1"># import pdb</span>

<span class="c1"># from pdb import set_trace</span>


<span class="n">parent</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
<span class="c1">#znse_file = parent/&quot;data/znse_index.csv&quot;</span>
<span class="n">znse_file</span> <span class="o">=</span> <span class="n">parent</span><span class="o">/</span><span class="s2">&quot;data/znse_Connolly.csv&quot;</span>
<span class="n">caf2_file</span> <span class="o">=</span> <span class="n">parent</span><span class="o">/</span><span class="s2">&quot;data/caf2_index.csv&quot;</span>



<span class="c1"># Brute force test parameter to </span>
<span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">comphasor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">thetas</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span>

<div class="viewcode-block" id="get_max_differential"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.get_max_differential">[docs]</a><span class="k">def</span> <span class="nf">get_max_differential</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the maximum differential between beams:</span>
<span class="sd">    </span>
<span class="sd">    * returns : max(array) - min(array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">array</span><span class="p">)</span></div>

<span class="c1"># Utility functions for optimization</span>
<span class="c1">##################################################</span>

<div class="viewcode-block" id="material_sellmeier"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.material_sellmeier">[docs]</a><span class="k">class</span> <span class="nc">material_sellmeier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="material_sellmeier.__init__"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.material_sellmeier.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * bs  : the B terms of the Sellmeier equation</span>
<span class="sd">        * cs  : the C terms of the Sellmeier equation [Âµm^2]</span>

<span class="sd">        if cs is not provided, then we expect coefficients given from `bs`</span>
<span class="sd">        as (B1, C1, B2, C2, ...)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bs2bcs</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span></div>
            
<div class="viewcode-block" id="material_sellmeier.get_n"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.material_sellmeier.get_n">[docs]</a>    <span class="k">def</span> <span class="nf">get_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">lamb_microns</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">*</span><span class="mf">1e6</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ab</span><span class="o">*</span><span class="n">lamb_microns</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">lamb_microns</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">ac</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)])</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">nr</span> <span class="o">+</span> <span class="n">add</span></div></div>

<div class="viewcode-block" id="bs2bcs"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.bs2bcs">[docs]</a><span class="k">def</span> <span class="nf">bs2bcs</span><span class="p">(</span><span class="n">bs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms a flat list of sellmeier coefficients (B1, C1, B2, C2, ...)</span>
<span class="sd">    into two vectors fo coefficients B and C.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">b2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">b2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>    </div>

<span class="c1"># Adding builtin material for the linb</span>
<span class="n">bs_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.9804</span><span class="p">,</span>
              <span class="mf">0.02047</span><span class="p">,</span>
              <span class="mf">0.5981</span><span class="p">,</span>
              <span class="mf">0.0666</span><span class="p">,</span>
              <span class="mf">8.9543</span><span class="p">,</span>
              <span class="mf">416.08</span><span class="p">])</span>
<span class="n">bs_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.6734</span><span class="p">,</span>
                <span class="mf">0.01764</span><span class="p">,</span>
                <span class="mf">1.2290</span><span class="p">,</span>
                <span class="mf">0.05914</span><span class="p">,</span>
                <span class="mf">12.614</span><span class="p">,</span>
                <span class="mf">474.6</span><span class="p">])</span>

<span class="n">linb_o</span> <span class="o">=</span> <span class="n">material_sellmeier</span><span class="p">(</span><span class="n">bs_o</span><span class="p">)</span>
<span class="n">linb_e</span> <span class="o">=</span> <span class="n">material_sellmeier</span><span class="p">(</span><span class="n">bs_e</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Parameters</span><span class="p">,</span> <span class="n">minimize</span>
<div class="viewcode-block" id="extract_corrector_params"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.extract_corrector_params">[docs]</a><span class="k">def</span> <span class="nf">extract_corrector_params</span><span class="p">(</span><span class="n">corrector</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to reconstruct the *b* and *c*</span>
<span class="sd">    vectors from the lmfit Parameters object.</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * corrector : The corrector object</span>
<span class="sd">    * params   :  at lmfit Parameters object</span>
<span class="sd">      containing b_i and c_i terms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">ntel</span> <span class="o">=</span> <span class="n">corrector</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">corrector</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
    <span class="n">cvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">corrector</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntel</span><span class="p">):</span>
        <span class="n">bvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;b</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="n">cvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;c</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">bvec</span><span class="p">,</span><span class="n">cvec</span></div>


<div class="viewcode-block" id="get_depth"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.get_depth">[docs]</a><span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="n">combiner</span><span class="p">,</span> <span class="n">Is</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a &quot;null depth&quot; analogue (dark/bright)</span>
<span class="sd">    to be minimized by the tuning method.</span>
<span class="sd">    The masks in the combiner definition</span>
<span class="sd">    are used to determine the role of the different outputs.</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * combiner : A combiner object.</span>
<span class="sd">    * Is       : An array of intensities</span>
<span class="sd">    </span>
<span class="sd">    .. admonition: Note:</span>
<span class="sd">    </span>
<span class="sd">        This definition might need some adjustments for</span>
<span class="sd">        use in kernel-nullers?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bright</span> <span class="o">=</span> <span class="n">Is</span><span class="p">[:,</span><span class="n">combiner</span><span class="o">.</span><span class="n">bright</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">Is</span><span class="p">[:,</span><span class="n">combiner</span><span class="o">.</span><span class="n">dark</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">dark</span><span class="o">/</span><span class="n">bright</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="get_Is"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.get_Is">[docs]</a><span class="k">def</span> <span class="nf">get_Is</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns intensities at the combiners&#39; outputs</span>
<span class="sd">    taking into account the corrections provided in</span>
<span class="sd">    params.</span>
<span class="sd">    </span>
<span class="sd">    **dcomp is computed automatically be default.**</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    * params   : either</span>
<span class="sd">    </span>
<span class="sd">                - A Parameters object from the optimization</span>
<span class="sd">                  does not support e: e is taken from corrector</span>
<span class="sd">                - A tuple of vectors bvec, cvec</span>
<span class="sd">                </span>
<span class="sd">    * combiner : A combiner object.</span>
<span class="sd">    * corrector : The corrector object</span>
<span class="sd">    * lambs    : The wavelengths considered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">):</span>
        <span class="n">bvec</span><span class="p">,</span> <span class="n">cvec</span> <span class="o">=</span> <span class="n">extract_corrector_params</span><span class="p">(</span><span class="n">corrector</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">evec</span> <span class="o">=</span> <span class="n">corrector</span><span class="o">.</span><span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bvec</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cvec</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">evec</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># bvec, cvec = params</span>
    <span class="n">phasor</span> <span class="o">=</span> <span class="n">corrector</span><span class="o">.</span><span class="n">get_phasor_from_params</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> 
                                             <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">b</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                             <span class="n">c</span><span class="o">=</span><span class="n">cvec</span><span class="p">,</span>
                                             <span class="n">e</span><span class="o">=</span><span class="n">evec</span><span class="p">)</span>
    <span class="c1">#res = combiner.Mcn.dot(phasor)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ikj,ij-&gt;ik&quot;</span><span class="p">,</span> <span class="n">combiner</span><span class="o">.</span><span class="n">Mcn</span><span class="p">,</span> <span class="n">phasor</span><span class="p">)</span>
    <span class="n">Is</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">Is</span></div>


<div class="viewcode-block" id="get_contrast_res"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.get_contrast_res">[docs]</a><span class="k">def</span> <span class="nf">get_contrast_res</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Macro that gets the a residual from parameters </span>
<span class="sd">    for minimizing method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Is</span> <span class="o">=</span> <span class="n">get_Is</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">lambs</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get_depth</span><span class="p">(</span><span class="n">combiner</span><span class="p">,</span> <span class="n">Is</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="get_es"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.get_es">[docs]</a><span class="k">def</span> <span class="nf">get_es</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the enantiomorph excursion taking into account the corrections provided in</span>
<span class="sd">    params.</span>
<span class="sd">    </span>
<span class="sd">    **Currently works only for double-bracewell 3-4 architecures**</span>
<span class="sd">        </span>
<span class="sd">    **dcomp is computed automatically by default.**</span>
<span class="sd">    </span>
<span class="sd">    **Parameters:**</span>
<span class="sd">    </span>
<span class="sd">    - params   : either</span>
<span class="sd">            * A Parameters object from the optimization</span>
<span class="sd">            * A tuple of vectors bvec, cvec</span>
<span class="sd">    - combiner : A combiner object.</span>
<span class="sd">    - corrector : The corrector object</span>
<span class="sd">    - lambs    : The wavelengths considered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">):</span>
        <span class="n">bvec</span><span class="p">,</span> <span class="n">cvec</span> <span class="o">=</span> <span class="n">extract_corrector_params</span><span class="p">(</span><span class="n">corrector</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bvec</span><span class="p">,</span> <span class="n">cvec</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">phasor</span> <span class="o">=</span> <span class="n">corrector</span><span class="o">.</span><span class="n">get_phasor_from_params</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> 
                                             <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">b</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                             <span class="n">c</span><span class="o">=</span><span class="n">cvec</span><span class="p">)</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">comphasor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">thetas</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span>
    <span class="n">amatcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk, ik -&gt; ijk&quot;</span><span class="p">,</span> <span class="n">combiner</span><span class="o">.</span><span class="n">Mcn</span><span class="p">,</span> <span class="n">phasor</span><span class="p">)</span>
    <span class="n">allcor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ik, mk -&gt; mik&quot;</span><span class="p">,</span> <span class="n">amatcomp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:],</span> <span class="n">comphasor</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">amatcomp</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">,:])[</span><span class="kc">None</span><span class="p">,:,:]</span>
    <span class="n">excursion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">allcor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">excursion</span></div>
<div class="viewcode-block" id="get_shape_res"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.get_shape_res">[docs]</a><span class="k">def</span> <span class="nf">get_shape_res</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Macro that gets the a residual from parameters </span>
<span class="sd">    for minimizing method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get_es</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">lambs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="offband_ft"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft">[docs]</a><span class="k">class</span> <span class="nc">offband_ft</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="offband_ft.__init__"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wl_ft</span><span class="p">,</span> <span class="n">wl_science</span><span class="p">,</span> <span class="n">wa_true</span><span class="p">,</span> <span class="n">wa_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corrector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a fringe tracker object that handles the problems of dispersion</span>
<span class="sd">        between the band in use and the band of interest. It also addresses the problems</span>
<span class="sd">        inside the band of interest.</span>
<span class="sd">        </span>
<span class="sd">        **Arguments:**</span>
<span class="sd">        </span>
<span class="sd">        * wl_ft : The wavelength at which the fringe tracking is done.</span>
<span class="sd">          OPD will be set to produce 0 phase at the man FT wavelength</span>
<span class="sd">        * wl_science : The wavelength range for which the correction is optimized</span>
<span class="sd">        * wa_true : True wet air model</span>
<span class="sd">        * wa_model : Modeled wet air model (as measured at the telescopes)</span>
<span class="sd">        * corrector : An dispersion corrector object to compute corresponding</span>
<span class="sd">          glass and air thickness</span>
<span class="sd">          </span>
<span class="sd">        **Note:**</span>
<span class="sd">        </span>
<span class="sd">        Contrary to the corrector object, the corrections are stored in a single 2D</span>
<span class="sd">        array, with the b on the row 0 and c on row 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span> <span class="o">=</span> <span class="n">wl_ft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span> <span class="o">=</span> <span class="n">wl_science</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span> <span class="o">=</span> <span class="n">wa_true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span> <span class="o">=</span> <span class="n">wa_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span> <span class="o">=</span> <span class="n">corrector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">corrector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span><span class="o">.</span><span class="n">get_Nair</span>
        <span class="c1"># corrector_model should be used mostly to compute b_ft or make predictions</span>
        <span class="c1"># Estimates of the real phases should always use the true corrector</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_corrector_models</span><span class="p">()</span>
        
        <span class="c1">#self.corrector = corrector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_piston_ft</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_correction_ft</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_correction_ft_science</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="offband_ft.refresh_corrector_models"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.refresh_corrector_models">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_corrector_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_model_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span><span class="o">.</span><span class="n">solve_air_corrector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_model_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span><span class="o">.</span><span class="n">solve_air</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">)</span><span class="c1"># Solving based for the closed_loop FT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_model_ft_feedforward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span><span class="o">.</span><span class="n">solve_air_corrector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">)</span><span class="c1"># Solving based on the FT measurements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_truth_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">solve_air_corrector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_truth_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">solve_air</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">)</span><span class="c1"># Solving based for the closed_loop FT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_truth_ft_feedforward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">solve_air_corrector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">)</span><span class="c1"># Solving based on the FT measurements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_model_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_S_GD_star</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_model_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_S_GD_star</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_S_GD_star</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_S_GD_star</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="offband_ft.get_ft_correction_on_science"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.get_ft_correction_on_science">[docs]</a>    <span class="k">def</span> <span class="nf">get_ft_correction_on_science</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pistons</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Arguments**:</span>
<span class="sd">        </span>
<span class="sd">        * pistons : The value of optical path length missing at </span>
<span class="sd">          the reference plane [m]</span>
<span class="sd">        </span>
<span class="sd">        **Output**: The phases for the science wavelengths for a closed loop correction</span>
<span class="sd">        by the fringe tracker [rad]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The true piston that gives the best mean phase in the FT band</span>
        <span class="c1"># This should remain true in white fringe phase tracking mode</span>
        <span class="c1"># because of closed loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_piston_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">theoretical_piston</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span>
                                                                         <span class="n">pistons</span><span class="p">,</span>
                                                                         <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">,</span>
                                                                         <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># The corrected phase:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_correction_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                            <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simple_piston_ft</span><span class="p">,</span>
                                                                            <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_correction_ft_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                                    <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simple_piston_ft</span><span class="p">,</span>
                                                                                    <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                            <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simple_piston_ft</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_correction_ft_science</span></div>
    

    
<div class="viewcode-block" id="offband_ft.update_NCP_corrections"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.update_NCP_corrections">[docs]</a>    <span class="k">def</span> <span class="nf">update_NCP_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pistons</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;phase&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by `get_phase_on_band` and `get_phase_on_science_values` and therefore</span>
<span class="sd">        called each time the `director.point` is called.</span>
<span class="sd">        </span>
<span class="sd">        **Arguments**:</span>
<span class="sd">        </span>
<span class="sd">        * pistons : The value of optical path length missing at </span>
<span class="sd">          the reference plane [m]</span>

<span class="sd">        **Refreshes**:</span>

<span class="sd">        * `self.true_phase_on_science`</span>
<span class="sd">        self.model_phase_on_science</span>
<span class="sd">        self.correction_ft_to_science</span>
<span class="sd">        self.phase_seen_by_ft </span>
<span class="sd">        self.b_ft</span>
<span class="sd">        self.correction_feedforward</span>
<span class="sd">        self.b_science_ideal</span>
<span class="sd">        </span>
<span class="sd">        * Computing the feedforward correction based on the FT phase:</span>
<span class="sd">          - `self.b_ft` : The atmospheric corrector for the FT band</span>
<span class="sd">          - `self.correction_feedforward` : The atmospheric corrector for the FT band</span>
<span class="sd">        </span>
<span class="sd">        * Computing the ideal correction for perfect knowledge of atmosphere</span>
<span class="sd">          (If we could measure the actual phase and close a loop)</span>
<span class="sd">          - `self.b_science_ideal` : The atmospherci corrector for the science band</span>
<span class="sd">          - `self.correction_closed_loop`</span>
<span class="sd">        </span>
<span class="sd">        * Computing a biased estimation based on a full model</span>
<span class="sd">          - `self.b_science_model` : The atmospherci corrector for the science band</span>
<span class="sd">          - `self.correction_blind`</span>

<span class="sd">        **New implementation**:</span>
<span class="sd">        </span>
<span class="sd">        In the idea that the phase of phase at entrance of the NOTT chip phi_tot:</span>
<span class="sd">        ```</span>
<span class="sd">        phi_tot = phi_v + phi_DL + phi_nott                            </span>
<span class="sd">                    |        |        |-&gt; Phase from the NOTT LDC</span>
<span class="sd">                    |        |----------&gt; Phase from the DL correction</span>
<span class="sd">                    |-------------------&gt; Phase from the vacuum piston imbalance</span>
<span class="sd">        phi_A = phi_v + phi_DL</span>
<span class="sd">          |-&gt;  the Asgard phase</span>
<span class="sd">        phi_nott = phi_AN + phi_ZN + phi_CN + phi_LN</span>
<span class="sd">                    |        |        |        |-&gt; phase from LiNb plates</span>
<span class="sd">                    |        |        |----------&gt; phase from CO2 cells</span>
<span class="sd">                    |        |-------------------&gt; phase from ZnSe plates</span>
<span class="sd">                    |----------------------------&gt; phase from the air DL and TT</span>

<span class="sd">        ```</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In the idea that the phase of phase at entrance of the NOTT chip phi_tot</span>
        <span class="c1"># The vacuum phase:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span> <span class="o">*</span> <span class="n">pistons</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_v_ft</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span> <span class="o">*</span> <span class="n">pistons</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;phase&quot;</span><span class="p">:</span>
            <span class="c1"># Computing the feedforward correction based on the FT phase:</span>
            <span class="c1"># This is using the true phase since it is closed loop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_truth_ft</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_v_ft</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phi_DL_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft</span><span class="p">)</span>
            <span class="c1"># This is what we believe Heimdallr has accomplished</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_ft_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_model_ft</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_v_ft</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft_model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL_ft_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phi_DL_model_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector_model</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft_model</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span>
            <span class="c1"># raise NotImplementedError(&quot;Group delay FT tracking not ready yet&quot;)</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Early implementation of GD tracking&quot;</span><span class="p">)</span>
            <span class="n">n_air</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">n_air_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_science</span> <span class="o">*</span> <span class="n">n_air</span> <span class="o">*</span> <span class="n">pistons</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL_ft</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_ft</span> <span class="o">*</span> <span class="n">n_air_ft</span> <span class="o">*</span> <span class="n">pistons</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n_air_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">phi_DL_band</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">band</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_science</span> <span class="o">*</span> <span class="n">n_air_band</span> <span class="o">*</span> <span class="n">pistons</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">n_air_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">n_air_ft_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL_model</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_model_science</span> <span class="o">*</span> <span class="n">n_air_model</span> <span class="o">*</span> <span class="n">pistons</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL_ft_model</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_model_ft</span> <span class="o">*</span> <span class="n">n_air_ft_model</span> <span class="o">*</span> <span class="n">pistons</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n_air_model_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">phi_DL_model_band</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">band</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_gd_model_science</span> <span class="o">*</span> <span class="n">n_air_model_band</span> <span class="o">*</span> <span class="n">pistons</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_asgard_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_v</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_asgard_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_v</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_DL</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phi_v_band</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">band</span> <span class="o">*</span> <span class="n">pistons</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">phi_asgard_true_band</span> <span class="o">=</span> <span class="n">phi_v_band</span> <span class="o">-</span> <span class="n">phi_DL_band</span>
            <span class="n">phi_asgard_model_band</span> <span class="o">=</span> <span class="n">phi_v_band</span> <span class="o">-</span> <span class="n">phi_DL_model_band</span>

        <span class="c1"># Now to compute the correction</span>
        <span class="c1"># Temp correction</span>
        <span class="c1">###########################</span>
        <span class="c1"># </span>

        <span class="c1"># Computing the ideal correction (If we could measure the actual phase and close a loop)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_science_ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_model_science</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_asgard_true</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#self.correction_closed_loop = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                      b=self.b_science_ideal[0,:],</span>
        <span class="c1">#                                                      c=self.b_science_ideal[1,:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                             <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_ideal</span><span class="p">)</span>
        
        <span class="c1"># Computing a biased estimation based on a full model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_science_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_model_science</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_asgard_model</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#self.correction_blind = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                      b=self.b_science_model[0,:],</span>
        <span class="c1">#                                                      c=self.b_science_model[1,:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_blind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                       <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_model</span><span class="p">)</span>

        <span class="c1"># self.phi_tot_ft = self.phi_v_ft + self.phi_DL_ft</span>
        <span class="c1"># self.phi_tot    = self.phi_v + self.phi_DL</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_nott_ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_ideal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_nott_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_model</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phi_nott_ideal_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                    <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_ideal</span><span class="p">)</span>
            <span class="n">phi_nott_model_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                    <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_model</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phi_asgard_true_band</span><span class="p">,</span> <span class="n">phi_asgard_model_band</span><span class="p">,</span> <span class="n">phi_nott_ideal_band</span><span class="p">,</span> <span class="n">phi_nott_model_band</span> </div>



    
        <span class="c1"># # Computing the errors in the L&#39; band</span>
        <span class="c1"># # The total phase from the piston on the band</span>
        <span class="c1"># self.true_phase_on_science = self.corrector.theoretical_phase(self.wl_science, pistons, model=self.wa_true, add=0)</span>
        <span class="c1"># if band is not None:</span>
        <span class="c1">#     total_phase_on_band = self.corrector.theoretical_phase(band, pistons,</span>
        <span class="c1">#                                                           model=self.wa_true, add=0)</span>
        <span class="c1"># self.model_phase_on_science = self.corrector.theoretical_phase(self.wl_science, pistons,</span>
        <span class="c1">#                                                                model=self.wa_model, add=0)</span>
        <span class="c1"># # The phase from piston, only from FT to science (assusming a closed loop on the FT)</span>
        <span class="c1"># self.correction_ft_to_science = self.get_ft_correction_on_science(pistons)</span>
        <span class="c1"># if band is not None:</span>
        <span class="c1">#     correction_to_phase_ft = self.get_ft_correction_on_science(pistons, band=band)</span>
        <span class="c1"># # becomes self.phi_v</span>
        <span class="c1"># self.phase_seen_by_ft = self.corrector.theoretical_phase(self.wl_ft, pistons, model=self.wa_true, add=0) - self.phase_correction_ft</span>
        
        <span class="c1"># # Computing the feedforward correction based on the FT phase:</span>
        <span class="c1"># self.b_ft = self.S_model_ft.dot(self.phase_seen_by_ft).T</span>
        <span class="c1"># #self.correction_feedforward = asim.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1"># #                                                      b=self.b_ft[0,:],</span>
        <span class="c1"># #                                                      c=self.b_ft[1,:])</span>
        <span class="c1"># self.correction_feedforward = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                                      vector=self.b_ft)</span>
        
        <span class="c1"># # Computing the ideal correction (If we could measure the actual phase and close a loop)</span>
        <span class="c1"># self.b_science_ideal = self.S_model_science.dot(self.true_phase_on_science - self.correction_ft_to_science).T</span>
        <span class="c1"># #self.correction_closed_loop = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1"># #                                                      b=self.b_science_ideal[0,:],</span>
        <span class="c1"># #                                                      c=self.b_science_ideal[1,:])</span>
        <span class="c1"># self.correction_closed_loop = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                                      vector=self.b_science_ideal)</span>
        
        <span class="c1"># # Computing a biased estimation based on a full model</span>
        <span class="c1"># self.b_science_model = self.S_model_science.dot(self.model_phase_on_science - self.correction_ft_to_science).T</span>
        <span class="c1"># #self.correction_blind = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1"># #                                                      b=self.b_science_model[0,:],</span>
        <span class="c1"># #                                                      c=self.b_science_model[1,:])</span>
        <span class="c1"># self.correction_blind = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                                vector=self.b_science_model)</span>
        <span class="c1"># if band is not None:</span>
        <span class="c1">#     return total_phase_on_band, correction_to_phase_ft    </span>

<div class="viewcode-block" id="offband_ft.update_NCP_corrections_old"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.update_NCP_corrections_old">[docs]</a>    <span class="k">def</span> <span class="nf">update_NCP_corrections_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pistons</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by `get_phase_on_band` and `get_phase_on_science_values` and therefore</span>
<span class="sd">        called each time the `director.point` is called.</span>
<span class="sd">        </span>
<span class="sd">        **Arguments**:</span>
<span class="sd">        </span>
<span class="sd">        * pistons : The value of optical path length missing at </span>
<span class="sd">          the reference plane [m]</span>

<span class="sd">        **Refreshes**:</span>

<span class="sd">        * `self.true_phase_on_science`</span>
<span class="sd">        self.model_phase_on_science</span>
<span class="sd">        self.correction_ft_to_science</span>
<span class="sd">        self.phase_seen_by_ft </span>
<span class="sd">        self.b_ft</span>
<span class="sd">        self.correction_feedforward</span>
<span class="sd">        self.b_science_ideal</span>
<span class="sd">        </span>
<span class="sd">        * Computing the feedforward correction based on the FT phase:</span>
<span class="sd">          - `self.b_ft` : The atmospheric corrector for the FT band</span>
<span class="sd">          - `self.correction_feedforward` : The atmospheric corrector for the FT band</span>
<span class="sd">        </span>
<span class="sd">        * Computing the ideal correction for perfect knowledge of atmosphere</span>
<span class="sd">          (If we could measure the actual phase and close a loop)</span>
<span class="sd">          - `self.b_science_ideal` : The atmospherci corrector for the science band</span>
<span class="sd">          - `self.correction_closed_loop`</span>
<span class="sd">        </span>
<span class="sd">        * Computing a biased estimation based on a full model</span>
<span class="sd">          - `self.b_science_model` : The atmospherci corrector for the science band</span>
<span class="sd">          - `self.correction_blind`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Computing the errors in the L&#39; band</span>
        <span class="c1"># The total phase from the piston on the band</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_phase_on_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">theoretical_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">,</span> <span class="n">pistons</span><span class="p">,</span>
                                                                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_phase_on_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">theoretical_phase</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">pistons</span><span class="p">,</span>
                                                                  <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_phase_on_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">theoretical_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">,</span> <span class="n">pistons</span><span class="p">,</span>
                                                                       <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># The phase from piston, only from FT to science (assusming a closed loop on the FT)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_ft_to_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ft_correction_on_science</span><span class="p">(</span><span class="n">pistons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction_to_phase_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ft_correction_on_science</span><span class="p">(</span><span class="n">pistons</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_seen_by_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">theoretical_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span><span class="p">,</span> <span class="n">pistons</span><span class="p">,</span>
                                                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_correction_ft</span>
        
        <span class="c1"># Computing the feedforward correction based on the FT phase:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_model_ft</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_seen_by_ft</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#self.correction_feedforward = asim.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                      b=self.b_ft[0,:],</span>
        <span class="c1">#                                                      c=self.b_ft[1,:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_feedforward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                             <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft</span><span class="p">)</span>
        
        <span class="c1"># Computing the ideal correction (If we could measure the actual phase and close a loop)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_science_ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_model_science</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_phase_on_science</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">correction_ft_to_science</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#self.correction_closed_loop = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                      b=self.b_science_ideal[0,:],</span>
        <span class="c1">#                                                      c=self.b_science_ideal[1,:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_closed_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                             <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_ideal</span><span class="p">)</span>
        
        <span class="c1"># Computing a biased estimation based on a full model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_science_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_model_science</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_phase_on_science</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">correction_ft_to_science</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#self.correction_blind = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                      b=self.b_science_model[0,:],</span>
        <span class="c1">#                                                      c=self.b_science_model[1,:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_blind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                       <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_phase_on_band</span><span class="p">,</span> <span class="n">correction_to_phase_ft</span></div>

<div class="viewcode-block" id="offband_ft.get_modeled_law"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.get_modeled_law">[docs]</a>    <span class="k">def</span> <span class="nf">get_modeled_law</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_baseline</span><span class="o">=</span><span class="mi">133</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate a law for glass and air compensation</span>
<span class="sd">        **Arguments:**</span>
<span class="sd">        </span>
<span class="sd">        * max_baseline : the maximum length tho considerj</span>
<span class="sd">        * model : A humid air model for which to draw the plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_model</span>
        <span class="n">path_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">max_baseline</span><span class="p">,</span> <span class="n">max_baseline</span><span class="p">,</span> <span class="mi">200</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">S_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">solve_air_corrector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">)</span>
        
        <span class="n">model_phase_on_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">theoretical_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl_science</span><span class="p">,</span> <span class="n">path_lengths</span><span class="p">,</span>
                                                                  <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">correction_ft_to_science</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ft_correction_on_science</span><span class="p">(</span><span class="n">path_lengths</span><span class="p">)</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">model_phase_on_science</span> <span class="o">-</span> <span class="n">correction_ft_to_science</span>
        <span class="n">b_model</span> <span class="o">=</span> <span class="n">S_model</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
        <span class="c1">#correction_closed_loop = self.corrector.get_raw_phase_correction(self.wl_science[:,None],</span>
        <span class="c1">#                                                      b=self.b_science_ideal[0,:],</span>
        <span class="c1">#                                                      c=self.b_science_ideal[1,:])</span>
        
        <span class="n">air_compensation</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">nmean</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">b_model</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">air_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b_model</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">air_compensation</span><span class="p">)</span>
        
        <span class="c1">#self.model_phase_on_science - self.correction_ft_to_science</span>
        <span class="n">glass_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b_model</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">path_lengths</span><span class="p">,</span> <span class="n">b_model</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Air length, uncompensated&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">path_lengths</span><span class="p">,</span> <span class="n">b_model</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">air_compensation</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Air length, uncompensated&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Path length [m]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Air compensation [m]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum range for </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> over </span><span class="si">{</span><span class="n">max_baseline</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> m</span><span class="se">\n</span><span class="s2"> Air: </span><span class="si">{</span><span class="n">air_range</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">path_lengths</span><span class="p">,</span> <span class="n">b_model</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Glass length, uncompensated&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Path length [m]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Glass compensation [m]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum glass range: </span><span class="si">{</span><span class="n">glass_range</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
        
        
        
<div class="viewcode-block" id="offband_ft.get_S_GD_star"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.get_S_GD_star">[docs]</a>    <span class="k">def</span> <span class="nf">get_S_GD_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        S_GD_star is the transform matrix (flat in this case) that projects</span>
<span class="sd">        the phase of vacuum created phases into piston that minimize the</span>
<span class="sd">        group delay.</span>

<span class="sd">        This is inspired by Tango 1990. In the case of only air conpensation,</span>
<span class="sd">        equation </span>
<span class="sd">        </span>
<span class="sd">        **Arguments**:</span>
<span class="sd">        * band  : if None: will save `self.sld_sxs`</span>
<span class="sd">        * pistons : </span>
<span class="sd">        * model    : A specific model with which to compute the correction</span>
<span class="sd">        * resample: None (default) to keep the sampling of the band,</span>
<span class="sd">          or int to resample band with that number of samples.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span>
        <span class="k">if</span> <span class="n">resample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wls</span> <span class="o">=</span> <span class="n">band</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">band</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">resample</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span>
        <span class="c1"># sig is the spectroscopic wavenumber 1/lambda</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">wls</span>
        <span class="n">nair</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_Nair_wn</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sigX</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">nair</span>
        <span class="n">s_dsigX_dsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">sigX</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>
        <span class="n">s_gd</span> <span class="o">=</span> <span class="n">s_dsigX_dsig</span> <span class="o">/</span><span class="n">nair</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_gd</span> <span class="o">=</span> <span class="n">s_gd</span>
        <span class="k">return</span> <span class="n">s_gd</span></div>

<div class="viewcode-block" id="offband_ft.get_phase_GD_tracking"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.get_phase_GD_tracking">[docs]</a>    <span class="k">def</span> <span class="nf">get_phase_GD_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pistons</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Arguments**:</span>

<span class="sd">        * band  : if None: will save `self.sld_sxs`</span>
<span class="sd">        * pistons : </span>
<span class="sd">        * model    : A specific model with which to compute the correction</span>
<span class="sd">        * resample: None (default) to keep the sampling of the band,</span>
<span class="sd">          or int to resample band with that number of samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl_ft</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_true</span>
        <span class="n">s_gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_S_GD_star</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>

        <span class="n">n_air</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">phase_GD_target</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">band</span> <span class="o">*</span> <span class="n">pistons</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">s_gd</span> <span class="o">*</span> <span class="n">n_air</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_GD_target</span> <span class="o">=</span> <span class="n">phase_GD_target</span>
        <span class="k">return</span> <span class="n">phase_GD_target</span></div>
        
    
<div class="viewcode-block" id="offband_ft.get_phase_on_band"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.get_phase_on_band">[docs]</a>    <span class="k">def</span> <span class="nf">get_phase_on_band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">pistons</span><span class="p">,</span>
                                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;ideal&quot;</span><span class="p">,</span>
                                <span class="n">ft_mode</span><span class="o">=</span><span class="s2">&quot;phase&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Similar to ``get_phase_science_values`` but for an arbitrary band </span>
<span class="sd">        for illustration purposes.</span>
<span class="sd">        </span>
<span class="sd">        **Arguments**:</span>
<span class="sd">        * band  : </span>
<span class="sd">        * pistons : </span>
<span class="sd">        * mode    : Type of correction to apply</span>
<span class="sd">            - `ideal` : Compensate with perfect knowledge of the atmospheric</span>
<span class="sd">              effects.</span>
<span class="sd">            - `blind` : Compensate using the internal atmosphere model</span>
<span class="sd">              which may deviate from ground truth.</span>
<span class="sd">            - `feedforward` : Assumes the dispersion is being measured at teh FT band</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `phi_asgard_model_band` normally used only to compute b_xxx</span>
        <span class="n">phi_asgard_true_band</span><span class="p">,</span>\
        <span class="n">phi_asgard_model_band</span><span class="p">,</span>\
        <span class="n">phi_nott_ideal_band</span><span class="p">,</span>\
        <span class="n">phi_nott_model_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_NCP_corrections</span><span class="p">(</span><span class="n">pistons</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">ft_mode</span><span class="p">)</span>

        <span class="c1">#true_phase_on_band = self.corrector.theoretical_phase(band, pistons, model=self.wa_true, add=0)</span>
        <span class="c1">#model_phase_on_band = self.corrector.theoretical_phase(band, pistons, model=self.wa_model, add=0)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ideal&quot;</span><span class="p">:</span>
            <span class="c1"># Assumes a closed loop in the science band</span>
            <span class="c1">#correction_closed_loop = self.corrector.get_raw_phase_correction(band[:,None],</span>
            <span class="c1">#                                                  b=self.b_science_ideal[0,:],</span>
            <span class="c1">#                                                  c=self.b_science_ideal[1,:])</span>
            <span class="n">correction_closed_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                            <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_ideal</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phi_asgard_true_band</span> <span class="o">-</span> <span class="n">phi_nott_ideal_band</span> <span class="o">-</span> <span class="n">correction_closed_loop</span>
            
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;blind&quot;</span><span class="p">:</span>
            <span class="c1"># Assumes only atmosphere is good and setpoint of FT is solid</span>
            <span class="c1">#correction_blind = self.corrector.get_raw_phase_correction(band[:,None],</span>
            <span class="c1">#                                                  b=self.b_science_model[0,:],</span>
            <span class="c1">#                                                  c=self.b_science_model[1,:])</span>
            <span class="n">correction_blind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                      <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_science_model</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phi_asgard_true_band</span> <span class="o">-</span> <span class="n">phi_asgard_model_band</span> <span class="o">-</span> <span class="n">correction_blind</span>
            <span class="c1"># NB: phi_asgard_model_band is used only for computing b_model</span>
        
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;feedforward&quot;</span><span class="p">:</span>
            <span class="c1"># Assumes a measurement of dispersion in the FT band</span>
            <span class="c1">#correction_feedforward = asim.corrector.get_raw_phase_correction(band[:,None],</span>
            <span class="c1">#                                                  b=self.b_ft[0,:],</span>
            <span class="c1">#                                                  c=self.b_ft[1,:])</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;feedfoward not implemented yet. returns model-model&quot;</span><span class="p">)</span>
            <span class="n">correction_feedforward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrector</span><span class="o">.</span><span class="n">get_raw_phase_correction</span><span class="p">(</span><span class="n">band</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                                                            <span class="n">vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ft</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phi_asgard_model_band</span> <span class="o">-</span> <span class="n">phi_nott_model_band</span> <span class="o">-</span> <span class="n">correction_feedforward</span></div>
        
        
        
<div class="viewcode-block" id="offband_ft.get_phase_science_values"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.offband_ft.get_phase_science_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_phase_science_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pistons</span><span class="p">,</span>
                                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;ideal&quot;</span><span class="p">,</span>
                                    <span class="n">ft_mode</span><span class="o">=</span><span class="s2">&quot;phase&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_NCP_corrections</span><span class="p">(</span><span class="n">pistons</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">ft_mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ideal&quot;</span><span class="p">:</span>
            <span class="c1"># Assumes a closed loop in the science band</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_asgard_true</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_nott_ideal</span>
            
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;blind&quot;</span><span class="p">:</span>
            <span class="c1"># Assumes only atmosphere is good and setpoint of FT is solid</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_asgard_true</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_nott_model</span>
        
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;feedforward&quot;</span><span class="p">:</span>
            <span class="c1"># Assumes a measurement of dispersion in the FT band</span>
            <span class="n">logit</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;feedfoward not implemented yet. returns model-model&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_asgard_model</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_nott_model</span></div></div>

        

<div class="viewcode-block" id="generic_vacuum"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.generic_vacuum">[docs]</a><span class="k">def</span> <span class="nf">generic_vacuum</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add should always be 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span> <span class="o">+</span> <span class="n">add</span></div>
<div class="viewcode-block" id="no_material"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.no_material">[docs]</a><span class="k">def</span> <span class="nf">no_material</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add should always be 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span> <span class="o">+</span> <span class="n">add</span></div>

<div class="viewcode-block" id="corrector"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector">[docs]</a><span class="k">class</span> <span class="nc">corrector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="corrector.__init__"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">lambs</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">model_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_material2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A module that provides beam adjustments</span>
<span class="sd">        for the input. It contains amplitude *a*, geometric</span>
<span class="sd">        piston *b* and ZnSe piston substitution *c*. Note that</span>
<span class="sd">        the ZnSe length replaces some air length.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * config:     A parsed config file</span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">          (At the __init__ stage, it is only used for</span>
<span class="sd">          the computation of a mean refractive index for</span>
<span class="sd">          the dispersive material)</span>
<span class="sd">        * file A file containing the plate index</span>
<span class="sd">        * order  : The order to which do the interpolation of the</span>
<span class="sd">          tabulated refractive index of the material 1</span>
<span class="sd">        * model_comp : A wet_atmo object model for the material in</span>
<span class="sd">          which compensation is made (None -&gt; Vacuum).</span>
<span class="sd">        * model_material2 : A wet_atmo object model for the second</span>
<span class="sd">          material for compensation is made (None -&gt; no material).</span>
<span class="sd">          </span>
<span class="sd">                    </span>
<span class="sd">        **Internal parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * a     :     Vector of the amplitude term</span>
<span class="sd">        * b     :     Vetor of the geometric piston term [m]</span>
<span class="sd">        * c     :     Vetor of the dispersive piston term [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nplate_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">znse_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">nplate_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">parent</span><span class="o">/</span><span class="s2">&quot;data&quot;</span><span class="o">/</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">nplate_file</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">nplate_file</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">kind</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">model_comp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not spotted ncomp&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">=</span> <span class="n">generic_vacuum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wa_comp</span> <span class="o">=</span> <span class="n">model_comp</span>
            <span class="c1"># print(&quot;successfully spotted ncomp&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_comp</span><span class="o">.</span><span class="n">get_Nair</span>
            
        <span class="k">if</span> <span class="n">model_material2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="o">=</span> <span class="n">no_material</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="o">=</span> <span class="n">model_material2</span><span class="o">.</span><span class="n">get_Nair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmean_mat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span><span class="p">(</span><span class="n">lambs</span><span class="p">))</span>
        <span class="n">diams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getarray</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span> <span class="s2">&quot;diam&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tel</span> <span class="o">=</span> <span class="n">diams</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># An amplitude factor</span>
        
        <span class="n">chip_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tel</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="c1"># (n_tel, n_glasses)</span>
        <span class="n">atmo_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tel</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="c1"># (n_tel, n_glasses)</span>
        <span class="n">a_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tel</span><span class="p">)</span> <span class="c1"># (n_tel, n_glasses)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_adjustments</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a_corr</span><span class="p">,</span> <span class="n">chip_corr</span><span class="o">=</span><span class="n">chip_corr</span><span class="p">,</span> <span class="n">atmo_corr</span><span class="o">=</span><span class="n">atmo_corr</span><span class="p">,</span>
                                <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">nmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nplate</span><span class="p">(</span><span class="n">lambs</span><span class="p">))</span>

        
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_model</span> <span class="o">=</span> <span class="n">n_air</span><span class="o">.</span><span class="n">wet_atmo</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></div>
        <span class="c1">#pdb.set_trace()</span>
        
<div class="viewcode-block" id="corrector.refresh_adjustments"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.refresh_adjustments">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_adjustments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chip_corr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atmo_corr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the values of self.a, self.b... based on the </span>
<span class="sd">        values in self.chip_corr and atmo_corr. Except for a,</span>
<span class="sd">        arrays are of shape `(n_tel, n_glasses)` with n_glasses including</span>
<span class="sd">        air and air compensation.</span>
<span class="sd">        </span>
<span class="sd">        **Arguments:**</span>
<span class="sd">        * a        : Correction for amplitude</span>
<span class="sd">        * chip corr: Correction for the chip [m]</span>
<span class="sd">        * atmo_corr: Correction for the atmosphere [m]</span>
<span class="sd">        * write : If true, will write down the vectors received</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">elif</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            
        <span class="k">if</span> <span class="n">chip_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chip_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_corr</span>
        <span class="k">elif</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chip_corr</span> <span class="o">=</span> <span class="n">chip_corr</span>
            
        <span class="k">if</span> <span class="n">atmo_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atmo_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmo_corr</span>
        <span class="k">elif</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atmo_corr</span> <span class="o">=</span> <span class="n">atmo_corr</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">chip_corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">atmo_corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Air compensation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span>  <span class="o">=</span> <span class="n">chip_corr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">atmo_corr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Glass length</span>
        <span class="c1">#-(self.nmean-1)*self.c </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcomp</span> <span class="o">=</span> <span class="n">chip_corr</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">atmo_corr</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># A length of air as compensation for glass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">chip_corr</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">atmo_corr</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># Additional material (CO2 bellows)</span></div>
        
<div class="viewcode-block" id="corrector.get_phasor"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.get_phasor">[docs]</a>    <span class="k">def</span> <span class="nf">get_phasor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the complex phasor corresponding</span>
<span class="sd">        to the current a, b, c, and dcomp phasors.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        </span>
<span class="sd">        **Returns:** alpha</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the air displacing solid plate:</span>
        <span class="n">np1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># The air displacing second material:</span>
        <span class="n">np2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">+</span> \
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">dcomp</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">+</span>\
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">np1</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span>\
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">np2</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">alpha</span></div>
<div class="viewcode-block" id="corrector.get_phasor_s"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.get_phasor_s">[docs]</a>    <span class="k">def</span> <span class="nf">get_phasor_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deprecated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the air displacing solid plate:</span>
        <span class="n">np1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># The air displacing second material:</span>
        <span class="n">np2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcomp</span> <span class="o">+</span>\
                                                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">*</span><span class="n">np1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">*</span><span class="n">np2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">alpha</span></div>
<div class="viewcode-block" id="corrector.get_raw_phase_correction"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.get_raw_phase_correction">[docs]</a>    <span class="k">def</span> <span class="nf">get_raw_phase_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">,</span>
                                 <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">dcomp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the raw (non-wrapped) phase produced by an optical path</span>
<span class="sd">        of b[m] in air and c[m] in plate material.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * a     :     Vector of the amplitude term</span>
<span class="sd">        * b     :     Vettor of the geometric piston term [m]</span>
<span class="sd">        * c     :     Vettor of the dispersive piston term [m]</span>
<span class="sd">        * e     :     Vettor of the addtional corretction material term [m]</span>
<span class="sd">        * dcomp :     A length of air to compensate for the plate</span>
<span class="sd">        * vector :    The vector-form of all dispersive correction </span>
<span class="sd">          shape: (n_materials, n_tel) [m]</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the air displacing solid plate:</span>
        <span class="n">np1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># The air displacing second material:</span>
        <span class="n">np2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1">#if model is None:</span>
        <span class="c1">#    model = self.prediction_model</span>
        <span class="n">nair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">vector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phase_correction</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="o">*</span><span class="p">(</span><span class="n">nair</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">dcomp</span><span class="p">)</span> <span class="o">+</span> <span class="n">np1</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">np2</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">phase_correction</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="o">*</span><span class="p">(</span><span class="n">nair</span><span class="o">*</span><span class="p">(</span><span class="n">vector</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dcomp</span><span class="p">)</span> <span class="o">+</span>\
                                                  <span class="n">np1</span><span class="o">*</span><span class="n">vector</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np2</span><span class="o">*</span><span class="n">vector</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">phase_correction</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="o">*</span><span class="p">(</span><span class="n">nair</span><span class="o">*</span><span class="p">(</span><span class="n">vector</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dcomp</span><span class="p">)</span> <span class="o">+</span>\
                                                  <span class="n">np1</span><span class="o">*</span><span class="n">vector</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">phase_correction</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="o">*</span><span class="p">(</span><span class="n">nair</span><span class="o">*</span><span class="p">(</span><span class="n">vector</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dcomp</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">phase_correction</span></div>

<div class="viewcode-block" id="corrector.get_vector"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.get_vector">[docs]</a>    <span class="k">def</span> <span class="nf">get_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            get_vector get the vector form of the current corrector setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">vector</span></div>
    
<div class="viewcode-block" id="corrector.get_dcomp"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.get_dcomp">[docs]</a>    <span class="k">def</span> <span class="nf">get_dcomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the theoertical value of dcomp for a given value of compensator</span>
<span class="sd">        plate, to correct for the pure piston term introduced.</span>
<span class="sd">        **Arguments**:</span>
<span class="sd">        * c   : The value of glass plate [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dcomp</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmean</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">c</span>
        <span class="k">return</span> <span class="n">dcomp</span></div>
        
<div class="viewcode-block" id="corrector.get_dcomp_from_vector"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.get_dcomp_from_vector">[docs]</a>    <span class="k">def</span> <span class="nf">get_dcomp_from_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the theoertical value of dcomp for a vector value of compensator</span>
<span class="sd">        plate, to correct for the pure piston term introduced.</span>
<span class="sd">        **Arguments**:</span>
<span class="sd">        * vector : The vector valued corrector position [m]</span>
<span class="sd">          (Only c at index 1 is used)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dcomp</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmean</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">c</span>
        <span class="k">return</span> <span class="n">dcomp</span></div>
        

<div class="viewcode-block" id="corrector.get_phasor_from_params"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.get_phasor_from_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_phasor_from_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">dcomp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similar to get_phasor() but allows to provide the</span>
<span class="sd">        parameters as arguments (slower).</span>
<span class="sd">        </span>
<span class="sd">        Returns the complex phasor corresponding</span>
<span class="sd">        to the current a, b, c, and dcomp phasors.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * a     :     Vector of the amplitude term</span>
<span class="sd">        * b     :     Vetor of the geometric piston term [m]</span>
<span class="sd">        * c     :     Vetor of the dispersive piston term [m]</span>
<span class="sd">        * e     :     Vettor of the addtional corretction material term [m]</span>
<span class="sd">        * dcomp :     A length of air to compensate for the plate [m]</span>
<span class="sd">          if dcomp is None: it will be computed based on `self.c`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">dcomp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dcomp</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span>      
            
        <span class="c1"># pdb.set_trace()</span>
        
        <span class="c1"># the air displacing solid plate:</span>
        <span class="n">np1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># The air displacing second material:</span>
        <span class="n">np2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1">#nplate -1 because it is air displacing glass</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">+</span> \
                                                            <span class="n">dcomp</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">+</span>\
                                                        <span class="n">c</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">np1</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span>\
                                                        <span class="n">e</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">np2</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">alpha</span></div>
    
<div class="viewcode-block" id="corrector.theoretical_phase"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.theoretical_phase">[docs]</a>    <span class="k">def</span> <span class="nf">theoretical_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lambs</span><span class="p">,</span> <span class="n">proj_opds</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the theoretical chromatic phase effect of the</span>
<span class="sd">        array geometry projected on axis based on the wet atmosphere</span>
<span class="sd">        model.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * proj_opds  : The projected piston obtained by projection</span>
<span class="sd">          (Get from simulator.obs.get_projected_geometric_pistons)</span>
<span class="sd">        * model      : A model for humid air (see n_air.wet_atmo object).</span>
<span class="sd">          If None, defaults to self.model, created upon init.</span>
<span class="sd">        * add        : returns n-1+add (add=0 gives the relative</span>
<span class="sd">          optical path compared to vacuum)</span>
<span class="sd">        * ref        : The reference wavelength for which phase is 0.</span>
<span class="sd">            - `None`</span>
<span class="sd">            - the value of a reference wavelength [m]</span>
<span class="sd">            - &quot;center&quot; : use the central bin of lambs</span>
<span class="sd">            - &quot;mean&quot; : use the mean of lambs</span>
<span class="sd">        </span>
<span class="sd">        **Returns:** phase [rad]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nair</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">add</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nref</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lambs</span><span class="p">[</span><span class="n">lambs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]])</span>
                <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lambs</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ref</span><span class="p">,])</span>
            <span class="c1"># Here get_Nair expects an array to will return an array</span>
            <span class="n">nref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">add</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="c1"># otherwise ref is the falue of the reference wavelength</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proj_opds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">proj_opds_s</span> <span class="o">=</span> <span class="n">proj_opds</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj_opds_s</span> <span class="o">=</span> <span class="n">proj_opds</span><span class="o">.</span><span class="n">T</span>
            
        <span class="n">phase</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">proj_opds_s</span> <span class="o">*</span> <span class="p">((</span><span class="n">nair</span> <span class="o">-</span> <span class="n">nref</span><span class="p">)</span> <span class="o">/</span> <span class="n">lambs</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">phase</span></div>
    
<div class="viewcode-block" id="corrector.theoretical_piston"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.theoretical_piston">[docs]</a>    <span class="k">def</span> <span class="nf">theoretical_piston</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lambs</span><span class="p">,</span> <span class="n">proj_opds</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the theoretical chromatic optical path effect of the</span>
<span class="sd">        array geometry projected on axis based on the wet atmosphere</span>
<span class="sd">        model.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * proj_opds  : The projected piston obtained by projection</span>
<span class="sd">          (Get from simulator.obs.get_projected_geometric_pistons)</span>
<span class="sd">        * model      : A model for humid air (see n_air.wet_atmo object).</span>
<span class="sd">          If None, defaults to self.model, created upon init.</span>
<span class="sd">        * add        : returns n-1+add (add=0 gives the relative</span>
<span class="sd">          optical path compared to vacuum)</span>
<span class="sd">        * ref        : The reference wavelength for which opl is 0.</span>
<span class="sd">            - `None`</span>
<span class="sd">            - the value of a reference wavelength [m]</span>
<span class="sd">            - &quot;center&quot; : use the central bin of lambs</span>
<span class="sd">            - &quot;mean&quot; : use the mean of lambs</span>
<span class="sd">        </span>
<span class="sd">        **Returns:** piston [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nair</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">add</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nref</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lambs</span><span class="p">[</span><span class="n">lambs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]])</span>
                <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lambs</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ref</span><span class="p">])</span>
            <span class="n">nref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">add</span><span class="p">)</span>
        <span class="c1"># otherwise ref is the falue of the reference wavelength</span>
        <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">proj_opds</span> <span class="o">*</span> <span class="p">(</span><span class="n">nair</span> <span class="o">-</span> <span class="n">nref</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span><span class="o">.</span><span class="n">T</span></div>
        
<div class="viewcode-block" id="corrector.solve_air"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.solve_air">[docs]</a>    <span class="k">def</span> <span class="nf">solve_air</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">corrector_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a least squares compensation model (see</span>
<span class="sd">        **Koresko et al. 2003 DOI: 10.1117/12.458032**)</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * model   : The wet atmosphere model (see n_air.wet_atmo object)</span>
<span class="sd">        * corrector_shape : (bool) if True: the matrix will be adjusted to</span>
<span class="sd">          give vectors adapted to a corrector with the correct number of materials.</span>
<span class="sd">        </span>
<span class="sd">        **Returns:** :math:`\Big( \mathbf{A}^T\mathbf{A}\mathbf{A}^T \Big)^{-1}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nair</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#nplate -1 because it is air displacing glass</span>
        <span class="c1"># ns = np.array([nair, (self.nplate(lambs)-1)]).T </span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">nair</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ns</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">corrector_shape</span><span class="p">:</span>
            <span class="n">n_corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> 
                                        <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">]))</span>
            <span class="n">S_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_corrections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">S_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">S_0</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span></div>
        
        
                              
                              
<div class="viewcode-block" id="corrector.solve_air_corrector"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.solve_air_corrector">[docs]</a>    <span class="k">def</span> <span class="nf">solve_air_corrector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a least squares compensation model for </span>
<span class="sd">        correction with variable thickness plates of material.</span>
<span class="sd">        (see **Koresko et al. 2003 DOI: 10.1117/12.458032**)</span>
<span class="sd">        </span>
<span class="sd">        This will use </span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        </span>
<span class="sd">        **Returns:** :math:`\Big( \mathbf{A}^T\mathbf{A}\mathbf{A}^T \Big)^{-1}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span><span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># If the corrector is equipped, add dof of</span>
        <span class="c1"># air displacing glass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">:</span>
             <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nplate</span><span class="p">(</span><span class="n">lambs</span><span class="p">,)</span> <span class="o">-</span> <span class="n">nair</span>
        
        <span class="c1"># If the corrector is equipped, add dof of</span>
        <span class="c1"># air displacing material</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">:</span>
            <span class="n">v3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span><span class="p">(</span><span class="n">lambs</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nair</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nplate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">):</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nair</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> 
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nplate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">):</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nair</span><span class="p">,</span> <span class="n">v2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> 
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nplate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">):</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nair</span><span class="p">,</span> <span class="n">v3</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> 
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nplate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_material</span><span class="p">):</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nair</span><span class="p">,])</span><span class="o">.</span><span class="n">T</span> 
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Combination of materials not found&quot;</span><span class="p">)</span>
            
        <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span></div>

<div class="viewcode-block" id="corrector.solve_air_model"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.solve_air_model">[docs]</a>    <span class="k">def</span> <span class="nf">solve_air_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a least squares compensation model (see</span>
<span class="sd">        **Koresko et al. 2003 DOI: 10.1117/12.458032**)</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * model   : The wet atmosphere model (see n_air.wet_atmo object)</span>
<span class="sd">        </span>
<span class="sd">        **Returns:** :math:`\Big( \mathbf{A}^T\mathbf{A}\mathbf{A}^T \Big)^{-1}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">amodel</span><span class="o">.</span><span class="n">get_Nair</span><span class="p">(</span><span class="n">lambs</span><span class="p">)</span> <span class="k">for</span> <span class="n">amodel</span> <span class="ow">in</span> <span class="n">models</span><span class="p">])</span>
        <span class="c1"># One of the components need to have the geometric element ()</span>
        <span class="n">ns</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ns</span><span class="o">.</span><span class="n">T</span> <span class="c1"># We do the transpose here</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span></div>
                              
<div class="viewcode-block" id="corrector.tune_static"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.tune_static">[docs]</a>    <span class="k">def</span> <span class="nf">tune_static</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">freeze_params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;b0&quot;</span><span class="p">,</span> <span class="s2">&quot;c0&quot;</span><span class="p">,</span> <span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize the compensator to correct chromatism in the </span>
<span class="sd">        model of the combiner. Returns a lmfit solution object.</span>
<span class="sd">        If &quot;apply&quot; is set to True, a, b, c, and dcomp are also</span>
<span class="sd">        set to the best fit value.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * combiner :  A combiner object (chromatic)  </span>
<span class="sd">        * apply    :  Boolean deciding whether to set the local</span>
<span class="sd">          parameters to best fit value (default: True)</span>
<span class="sd">        * freeze_params : The name of parameters to be freezed.</span>
<span class="sd">          Should be used to account for the larger than</span>
<span class="sd">          necessary number of degrees of freedom.</span>
<span class="sd">                    </span>
<span class="sd">        .. admonition:: Note:</span>
<span class="sd">            </span>
<span class="sd">            For obtaining a more practical direct results, some</span>
<span class="sd">            more complicated balancing guidelines should be followed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#pdb.set_trace()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;b</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">value</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;c</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">value</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;b0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;c0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;c2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;b2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">get_contrast_res</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
               <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">combiner</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">),</span>
               <span class="n">method</span><span class="o">=</span><span class="s2">&quot;leastsq&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sol</span> <span class="o">=</span> <span class="n">sol</span>
        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="n">bvec</span><span class="p">,</span> <span class="n">cvec</span> <span class="o">=</span> <span class="n">extract_corrector_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chip_corr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span><span class="n">bvec</span><span class="p">,</span>
                             <span class="s2">&quot;c&quot;</span><span class="p">:</span><span class="n">cvec</span><span class="p">,</span>
                             <span class="s2">&quot;dcomp&quot;</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmean</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cvec</span><span class="p">}</span>
            <span class="c1"># These updates would be removed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_corr</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_corr</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_corr</span><span class="p">[</span><span class="s2">&quot;dcomp&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sol</span></div>
    
<div class="viewcode-block" id="corrector.tune_static_shape"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.tune_static_shape">[docs]</a>    <span class="k">def</span> <span class="nf">tune_static_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sync_params</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;b3&quot;</span><span class="p">,</span> <span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;c3&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)],</span>
                    <span class="n">freeze_params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;b0&quot;</span><span class="p">,</span> <span class="s2">&quot;c0&quot;</span><span class="p">,</span> <span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;c1&quot;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize the compensator to correct chromatism in the </span>
<span class="sd">        model of the combiner to obtain enantomporph combinations</span>
<span class="sd">        at the outputs. Returns a lmfit solution object.</span>
<span class="sd">        If ``apply`` is set to True, a, b, c, and dcomp are also</span>
<span class="sd">        set to the best fit value.</span>
<span class="sd">        </span>
<span class="sd">        **Currently only works for double Bracewell 3-4 architectures.**</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        </span>
<span class="sd">        * lambs :     The wavelength channels to consider [m]</span>
<span class="sd">        * combiner :  A combiner object (chromatic)  </span>
<span class="sd">        * apply    :  Boolean deciding whether to set the local</span>
<span class="sd">          parameters to best fit value (default: True)</span>
<span class="sd">          </span>
<span class="sd">        .. admonition:: Note:</span>
<span class="sd">        </span>
<span class="sd">            For obtaining a more practical direct results, some</span>
<span class="sd">            more complicated balancing guidelines should be followed.</span>
<span class="sd">        </span>
<span class="sd">        **Example:**</span>
<span class="sd">        </span>
<span class="sd">        .. code-block::</span>
<span class="sd">            </span>
<span class="sd">            sol = asim.corrector.tune_static_shape(asim.lambda_science_range,</span>
<span class="sd">                             asim.combiner,</span>
<span class="sd">                             sync_params=[(&quot;b3&quot;, &quot;b2&quot;, asim.corrector.b[3] - asim.corrector.b[2]),</span>
<span class="sd">                                         (&quot;c3&quot;, &quot;c2&quot;, asim.corrector.c[3] - asim.corrector.c[2])],</span>
<span class="sd">                             apply=True)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside_tuning&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;b</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;c</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">tosync</span> <span class="ow">in</span> <span class="n">sync_params</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">tosync</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">tosync</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;+ </span><span class="si">{</span><span class="n">tosync</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># If we have </span>
        <span class="c1">#b23 = self.b[3]-self.b[2]</span>
        <span class="c1">#c23 = self.c[3]-self.c[2]</span>
        <span class="c1">#params[&quot;b3&quot;].set(expr=f&quot;b2 + {b23}&quot;)</span>
        <span class="c1">#params[&quot;c3&quot;].set(expr=f&quot;c2 + {c23}&quot;)</span>
        <span class="k">for</span> <span class="n">aparam</span> <span class="ow">in</span> <span class="n">freeze_params</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">aparam</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1">#display.display(params)</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">get_shape_res</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
               <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">combiner</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lambs</span><span class="p">),</span>
               <span class="n">method</span><span class="o">=</span><span class="s2">&quot;leastsq&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sol</span> <span class="o">=</span> <span class="n">sol</span>
        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="n">bvec</span><span class="p">,</span> <span class="n">cvec</span> <span class="o">=</span> <span class="n">extract_corrector_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">bvec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">cvec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcomp</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmean</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">return</span> <span class="n">sol</span></div>
    
    
    
<div class="viewcode-block" id="corrector.plot_tuning"><a class="viewcode-back" href="../../scifysim.correctors.html#scifysim.correctors.corrector.plot_tuning">[docs]</a>    <span class="k">def</span> <span class="nf">plot_tuning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lambs</span><span class="p">,</span>  <span class="n">npoints</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot of the state of tuning.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters:**</span>
<span class="sd">        * lambs :     The wavelength range to consider to consider [m]</span>
<span class="sd">        * npoints :   The number number of points in the range to consider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">kernuller.diagrams</span> <span class="kn">import</span> <span class="n">plot_chromatic_matrix</span> <span class="k">as</span> <span class="n">cmpc</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        
        <span class="n">pltlambrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lambs</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lambs</span><span class="p">),</span>
                                   <span class="n">npoints</span><span class="p">)</span>
        <span class="n">init_phasor</span> <span class="o">=</span> <span class="n">cor</span><span class="o">.</span><span class="n">get_phasor</span><span class="p">(</span><span class="n">pltlambrange</span><span class="p">)</span></div></div>
        
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Romain Laugier.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>